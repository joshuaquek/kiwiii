// https://github.com/mojaie/kiwiii Version 1.0.0-alpha.3. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("lodash"),require("Dexie"),require("vega")):"function"==typeof define&&define.amd?define(["d3","lodash","Dexie","vega"],t):e["kw-datagrid"]=t(e.d3,e._,e.Dexie,e.vega)}(this,function(e,t,o,s){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,o=o&&o.hasOwnProperty("default")?o.default:o,s=s&&s.hasOwnProperty("default")?s.default:s;const n={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},r={datatable:"nodes",connection:"edges"};function i(e){const t=e.columns.map(e=>("numeric"===e.sort?e.format="numeric":"text"===e.sort?e.format="text":"none"===e.sort&&(e.format="raw"),e));return{id:e.id,name:e.name,dataType:r[e.format],schemaVersion:.8,revision:0,status:n[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function l(e){return{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:e.query,progress:e.progress,execTime:e.execTime,created:e.created,reference:{}}}function a(t){let o=t;return o.edges.hasOwnProperty("schemaVersion")||o.edges.hasOwnProperty("$schema")||(o.nodes=i(o.nodes),o.edges=function(e,t){const o={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(o.nodeColor.id=e.snapshot.nodeColor.id,o.nodeColor.scale=e.snapshot.nodeColor.scale,o.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):o.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(o.nodeSize.id=e.snapshot.nodeSize.id,o.nodeSize.scale=e.snapshot.nodeSize.scale,o.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):o.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(o.nodeLabel.id=e.snapshot.nodeLabel.id,o.nodeLabel.size=e.snapshot.nodeLabel.size,o.nodeLabel.text=e.snapshot.nodeLabel.text,o.nodeLabel.visible=e.snapshot.nodeLabel.visible,o.nodeLabel.scale=e.snapshot.nodeLabel.scale,o.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):o.nodeLabel={id:"label",size:12,text:"index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?o.nodeContent=e.snapshot.nodeContent:o.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?o.edge=e.snapshot.edge:o.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:r[e.format],schemaVersion:.8,revision:0,reference:{nodes:e.nodeTableId},status:n[e.status],fields:[{key:"source"},{key:"target"},{key:"weight"}],records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:o}}(o.edges,o.nodes.fields)),"0.8"!=o.edges.schemaVersion&&.1!==o.edges.schemaVersion||((o=function(e){if(e.edges.hasOwnProperty("reference")||(e.edges.reference={nodes:e.edges.nodesID}),e.nodes.fields.find(e=>"_index"===e.key)){const t={};e.nodes.records.forEach((e,o)=>{e.index=o,e.structure=e._structure,t[e._index]=e.index,delete e._index,delete e._structure}),e.edges.records.forEach(e=>{e.source=t[e.source],e.target=t[e.target]}),e.nodes.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")})}return e}(o)).nodes=l(o.nodes),o.edges=function(t){const o={networkThreshold:t.networkThreshold};return o.nodeContentVisible=t.snapshot.nodeContent.structure.visible,o.nodeColor=t.snapshot.nodeColor.scale||{},o.nodeColor.field&&(o.nodeColor.field=t.snapshot.nodeColor.field.key,"_index"===o.nodeColor.field&&(o.nodeColor.field="index")),"ordinal"===o.nodeColor.scale&&(o.nodeColor.range=e.schemeCategory20),o.nodeSize=t.snapshot.nodeSize.scale||{},t.snapshot.nodeSize.field&&(o.nodeSize.field=t.snapshot.nodeSize.field.key,"_index"===o.nodeSize.field&&(o.nodeSize.field="index")),o.nodeLabel={},t.snapshot.nodeLabel.text&&(o.nodeLabel.text=t.snapshot.nodeLabel.text.key,"_index"===o.nodeLabel.text&&(o.nodeLabel.text="index")),o.nodeLabel.size=t.snapshot.nodeLabel.size,o.nodeLabel.visible=t.snapshot.nodeLabel.visible,o.nodeLabelColor=t.snapshot.nodeLabel.scale||{},t.snapshot.nodeLabel.field&&(o.nodeLabelColor.field=t.snapshot.nodeLabel.field.key,"_index"===o.nodeLabelColor.field&&(o.nodeLabelColor.field="index")),"ordinal"===o.nodeLabelColor.scale&&(o.nodeLabelColor.range=e.schemeCategory20),o.edgeVisible=t.snapshot.edge.visible,o.edgeWidth=t.snapshot.edge.scale||{},o.edgeLabel={},o.edgeLabel.size=t.snapshot.edge.label.size,o.edgeLabel.visible=t.snapshot.edge.label.visible,o.networkThreshold=t.networkThreshold||t.query.threshold,o.coords=t.snapshot.nodePositions,{id:t.id,name:t.name,dataType:t.dataType,schemaVersion:"0.10",revision:t.revision,status:t.status,fields:t.fields,records:t.records,query:{params:t.query},progress:t.progress,execTime:t.execTime,created:t.created,snapshot:o,reference:t.reference}}(o.edges)),o.edges.hasOwnProperty("$schema")||(delete o.nodes.schemaVersion,delete o.edges.schemaVersion,delete o.nodes.revision,delete o.edges.revision,o.nodes.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json",o.edges.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),o}var d={convertPackage:function(e){let t={};if(!e.hasOwnProperty("views")){const o=new Date,s=e.hasOwnProperty("edges"),n=s?a(e):function(e){let t=e;return t.hasOwnProperty("schemaVersion")||t.hasOwnProperty("$schema")||(t=i(t)),"0.8"==t.schemaVersion&&(t=l(t=function(e){return e.records.forEach((e,t)=>{e.index=t,e.structure=e._structure,delete e._index,delete e._structure}),e.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")}),e}(t))),t.hasOwnProperty("$schema")||(delete t.schemaVersion,delete t.revision,t.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t.fields.forEach(e=>{"structure"===e.key&&(e.format="svg"),delete e.width,delete e.height}),t}(e),r=s?n.nodes:n;(t={$schema:"https://mojaie.github.io/kiwiii/specs/package_v1.0.json",name:n.edges.name,views:[],dataset:[]}).dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:r.id,name:r.name,contents:[{$schema:r.$schema,workflowID:r.reference.workflow,name:r.name,fields:r.fields,records:r.records,created:r.created,status:r.status,query:r.query,execTime:r.execTime,progress:r.progress}]}),t.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:r.id,name:r.name,viewType:"datagrid",rows:r.id,fields:r.fields,sortOrder:null,filterText:null,checkpoints:[{type:"convert",date:o.toString(),description:"converted from legacy format"}]}),s&&(t.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:n.edges.id,name:n.edges.name,contents:[{$schema:n.edges.$schema,workflowID:n.edges.reference.workflow,name:n.edges.name,fields:n.edges.fields,records:n.edges.records,created:n.edges.created,status:n.edges.status,query:n.edges.query,execTime:n.edges.execTime,progress:n.edges.progress}]}),t.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:n.edges.id,name:n.edges.name,viewType:"network",nodes:r.id,edges:n.edges.id,nodeColor:n.edges.snapshot.nodeColor,nodeSize:n.edges.snapshot.nodeSize,nodeLabel:n.edges.snapshot.nodeLabel,nodeLabelColor:n.edges.snapshot.nodeLabelColor,edgeWidth:n.edges.snapshot.edgeWidth,edgeLabel:n.edges.snapshot.edgeLabel,networkThreshold:n.edges.snapshot.networkThreshold,networkThresholdCutoff:n.edges.snapshot.networkThresholdCutoff,fieldTransform:n.edges.snapshot.fieldTransform,coords:n.edges.snapshot.coords,checkpoints:[{type:"convert",date:o.toString(),description:"converted from legacy format"}]})),t.views.filter(e=>"network"===e.viewType).forEach(e=>{e.minConnThld=e.networkThresholdCutoff,e.currentConnThld=e.networkThreshold,e.hasOwnProperty("nodeLabel")&&(e.nodeLabel.field=e.nodeLabel.text),e.hasOwnProperty("edgeLabel")&&(e.edgeLabel.field="weight"),e.hasOwnProperty("edgeWidth")&&(e.edgeWidth.field="weight")})}return t.views.filter(e=>"network"===e.viewType).forEach(e=>{e.nodeColor.field||(e.nodeColor.field="index"),e.nodeSize.field||(e.nodeSize.field="index"),e.nodeLabel.field||(e.nodeLabel.field="index"),e.nodeLabelColor.field||(e.nodeLabelColor.field="index"),e.edgeColor?e.edgeColor.field||(e.edgeColor.field="weight"):e.edgeColor={field:"weight",color:"monogray",scale:"linear",domain:[0,1],range:["#999999","#999999"],unknown:"#cccccc"},e.edgeWidth.field||(e.edgeWidth.field="weight"),e.edgeLabel.field||(e.edgeLabel.field="weight"),e.edgeLabelColor?e.edgeLabelColor.field||(e.edgeLabelColor.field="weight"):e.edgeLabelColor={field:"weight",color:"monoblack",scale:"linear",domain:[1,1],range:["#333333","#333333"],unknown:"#cccccc"}}),t}};var c={sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id","assay_id","list"].includes(e)?"text":["text_field","checkbox","html"].includes(e)?"html":"none"},formatNum:function(t,o){return null==t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(o)(t):t},partialMatch:function(e,t){return null!=t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const p={items:"storeID, sessionStarted"};let u=new o("Store");function h(){return u.items.orderBy("sessionStarted").reverse().toArray()}function f(e,t){return u.items.where("storeID").equals(e).modify(t).catch(e=>{console.error("IDBError: Update failed",e)})}u.version(1).stores(p);var m={reset:function(){return u.delete().then(()=>{(u=new o("Store")).version(1).stores(p)})},getAllItems:h,getItem:function(e){return u.items.where("storeID").equals(e).first().catch(t=>{console.error(`IDBError: Unexpected table ID: ${e}`,t)})},updateItem:f,deleteItem:function(e){return u.items.where("storeID").equals(e).delete()},getView:function(e,t){return h().then(t=>t.find(t=>t.storeID===e).views).then(o=>{const s=o.find(e=>e.viewID===t);if(s)return s.storeID=e,s})},appendView:function(e,t,o){return f(e,e=>{const s=e.views.findIndex(e=>e.viewID===t);e.views.splice(s+1,0,o)})},updateView:function(e,o,s){return f(e,e=>{const n=e.views.findIndex(e=>e.viewID===o);t.isFunction(s)?s(e.views[n]):e.views[n]=s})},deleteView:function(e,t){return f(e,e=>{const o=e.views.findIndex(e=>e.viewID===t);e.views.splice(o,1);const s={};e.dataset.forEach(e=>{s[e.collectionID]=0}),e.views.forEach(e=>{["rows","items","nodes","edges"].filter(t=>e.hasOwnProperty(t)).forEach(t=>{s[e[t]]+=1})}),Object.entries(s).forEach(t=>{if(!t[1]){const o=e.dataset.findIndex(e=>e.collectionID===t[0]);e.dataset.splice(o,1)}})})},getAllCollections:function(){return h().then(e=>t.flatten(e.map(e=>e.dataset.map(t=>(t.storeID=e.storeID,t)))))},getCollection:function(e,t){return h().then(t=>t.find(t=>t.storeID===e).dataset).then(o=>{const s=o.find(e=>e.collectionID===t);if(s)return s.storeID=e,s})},updateCollection:function(e,o,s){return f(e,e=>{const n=e.dataset.findIndex(e=>e.collectionID===o);t.isFunction(s)?s(e.dataset[n]):e.dataset[n]=s})},importItem:function(e){e=d.convertPackage(e);const t=new Date;return e.storeID=c.uuidv4().slice(0,8),e.sessionStarted=t.toString(),u.items.put(e)},newDatagrid:function(e){const t=(new Date).toLocaleString("en-GB",{timeZone:"Asia/Tokyo"}),o=c.uuidv4().slice(0,8),s=c.uuidv4().slice(0,8),n=e.workflowID.slice(0,8),r={$schema:"https://mojaie.github.io/kiwiii/specs/package_v1.0.json",storeID:o,name:e.name,views:[{$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:s,name:e.name,viewType:"datagrid",rows:n,checkpoints:[{type:"creation",date:t}]}],dataset:[{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:n,name:e.name,contents:[e]}],sessionStarted:t};return u.items.put(r).then(()=>({storeID:o,viewID:s}))},newNetwork:function(e,t,o,s){const n=c.uuidv4().slice(0,8),r=s.workflowID.slice(0,8);return f(e,e=>{e.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:n,name:`${o}_${s.name}`,viewType:"network",nodes:t,edges:r,minConnThld:s.query.params.threshold}),e.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:r,name:s.name,contents:[s]})}).then(()=>n)}};const g="../req/";function w(e,t={}){const o=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${g}${e}${o}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))}function y(e){return e.json()}var x={get:w,json:y,text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${g}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null},serverStatus:function(){const e={};return w("server").then(y).then(t=>{e.server=t}).then(()=>w("schema")).then(y).then(t=>{e.schema=t}).then(()=>e)}};function b(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}var v={singleToMulti:b,mappingToTable:function(e){const t=e.hasOwnProperty("field")?b(e):e;return{fields:[{key:t.key,format:"text"}].concat(t.fields),records:Object.entries(t.mapping).map(e=>{const o={};return o[t.key]=e[0],t.fields.forEach((t,s)=>{o[t.key]=e[1][s]}),o})}},tableToMapping:function(e,t,o=["index"]){const s={created:(new Date).toString(),fields:e.fields.filter(e=>e.key!==t).filter(e=>!o.includes(e.key)),key:t,mapping:{}};return e.records.forEach(e=>{s.mapping[e[t]]=s.fields.map(t=>e[t.key])}),s},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),o=t.shift().split(","),s=o.shift(),n=new Date,r=[],i=[];o.forEach((e,t)=>{""!==e&&(r.push(t),i.push({key:e,format:"text"}))});const l={created:n.toString(),fields:i,key:s,mapping:{}};return t.forEach(e=>{const t=e.split(","),o=t.shift();l.mapping[o]=Array(r.length),r.forEach(e=>{l.mapping[o][e]=t[e]})}),l},apply:function(e,o){const s=o.hasOwnProperty("field")?b(o):o;e.records.filter(e=>s.mapping.hasOwnProperty(e[s.key])).forEach(e=>{s.fields.forEach((t,o)=>{e[t.key]=s.mapping[e[s.key]][o]})}),e.fields=t(e.fields).concat(s.fields).uniqBy("key").value()}};class k{constructor(e){this.autoIndex="index",this.collectionID=e.collectionID||null,this.storeID=e.storeID||null,this.name=e.name||null,e.records?(this.contents=[e],this.fields=[]):(this.contents=e.contents,this.fields=e.fields||[]),this.contents.forEach(e=>{e.fields.forEach(e=>this.addField(e))})}addField(e){this.fields.find(t=>t.key===e.key)||(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),this.fields.push(e))}updateFields(e){this.fields=[],e.forEach(e=>this.addField(e))}joinFields(e){this.contents.forEach(t=>{v.apply(t,e)}),e.hasOwnProperty("fields")?e.fields.forEach(e=>this.addField(e)):this.addField(e.field)}apply(e){this.contents.forEach(t=>{t.records.forEach(t=>{e(t)})})}records(){return t.flatten(this.contents.map(e=>e.records))}fetch(e){const t=this.contents.filter(e=>["running","ready","interrupted","queued"].includes(e.status)).map(t=>{const o={id:t.workflowID,command:e};return x.get("progress",o).then(x.json).then(e=>m.updateCollection(this.storeID,this.collectionID,t=>{const s=t.contents.findIndex(e=>e.workflowID===o.id);"failure"===e.status?t.contents[s].status="failure":t.contents[s]=e}))});return Promise.all(t).then(()=>m.getCollection(this.storeID,this.collectionID)).then(e=>{this.contents=e.contents})}pull(){return this.fetch("pull")}abort(){return this.fetch("abort")}size(){return t.sum(this.contents.map(e=>e.records.length))}status(){return this.contents.some(e=>"interrupted"===e.status)?"interrupted":this.contents.some(e=>"running"===e.status)?"running":this.contents.some(e=>"queued"===e.status)?"queued":this.contents.some(e=>"ready"===e.status)?"ready":this.contents.some(e=>"aborted"===e.status)?"aborted":this.contents.some(e=>"failure"===e.status)?"failure":"done"}ongoing(){return["ready","queued","running","interrupted"].includes(this.status())}progress(){return t.min(this.contents.map(e=>e.progress))}execTime(){return t.sum(this.contents.map(e=>e.execTime))}export(){return{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:this.collectionID,name:this.name,fields:this.fields,contents:this.contents}}}function I(e,t){const o=e.select(".dg-header");o.selectAll(".dg-hcell").remove(),o.selectAll(".dg-hcell").data(t.visibleFields).enter().append("div").classed("dg-hcell",!0).call(t.headerCellRenderer)}function C(t,o){const s=t.select(".dg-body").selectAll(".dg-row").data(o.recordsToShow(),o.keyFunc);s.exit().remove(),s.selectAll(".dg-cell").remove(),s.enter().append("div").attr("class","dg-row").style("position","absolute").style("width","100%").merge(s).style("height",`${o.rowHeight}px`).each(function(t,s){const n=o.viewportTop+s,r=n*o.rowHeight;e.select(this).style("transform",`translate(0px, ${r}px)`).classed("odd",n%2==0).call(o.rowFactory(),t)})}function T(e,t,o){e.select(".dg-body").style("height",`${t.bodyHeight}px`),t.setScrollPosition(o),e.call(C,t,o),e.select(".dg-viewport").node().scrollTop=o*t.rowHeight}function D(e,t){const o=e.select(".dg-viewport"),s=o.node().getBoundingClientRect().top;t.resizeViewport(window.innerHeight-s-5),o.style("height",`${t.viewportHeight}px`)}var L={headerCellRenderer:function(e){e.style("display","inline-block").style("width",e=>`${e.width}%`).text(e=>e.name)},updateHeader:I,updateRows:C,updateViewport:T,resize:D,datagrid:function(e,t){e.append("div").classed("dg-header",!0),e.append("div").classed("dg-viewport",!0).style("overflow-y","auto").on("scroll",function(){const o=Math.floor(this.scrollTop/t.rowHeight);o!==t.previousViewportTop&&(t.setScrollPosition(o),e.call(C,t,o))}).append("div").classed("dg-body",!0).style("position","relative"),t.updateContentsNotifier=(()=>{t.applyHeader(),e.call(I,t),e.call(D,t),t.applyData(),e.call(T,t,t.viewportTop)}),t.updateFilterNotifier=(o=>{t.setFilterText(o),e.call(T,t,0)})}};function O(e,t,o){e.text(c.formatNum(t[o.key],o.d3_format))}function _(e,t,o){e.text(t[o.key])}function S(e,t,o){e.html(t[o.key])}function j(e,t,o){e.append("a").attr("href",`profile.html?compound=${t[o.key]}`).attr("target","_blank").text(t[o.key])}function P(e,t,o){e.append("img").attr("width",180).attr("height",180).attr("src",t[o.key])}function F(e,t,o){e.append("input").attr("type","checkbox").property("checked",t[o.key]).property("disabled",!!o.disabled&&t[o.disabled]).on("click",function(){t[o.key]=this.checked})}function V(e,t,o){e.append("input").attr("type","text").style("width","90%").property("value",t[o.key]).on("change",function(){t[o.key]=this.value})}function $(e,t){e.call(t)}const z={numeric:_,text:_,date:function(e,t,o){e.text(t[o.key])},raw:_,d3_format:O,compound_id:j,assay_id:_,list:_,plot:{plotCell:function(e,t,o){new s.View(s.parse(t[o.key])).initialize(e.node()).run()},plotThumbnail:function(e){return new s.View(s.parse(e)).toImageURL("png")},binaryToDataURI:function(e){return new Promise(t=>{const o=new FileReader;o.onload=(e=>{t(e.target.result)}),o.readAsDataURL(e)})}}.plotCell,image:P,checkbox:F,text_field:V,control:$,svg:S,html:S};function B(e){e.classed("dg-cell",!0).classed("align-middle",!0).classed("text-truncate",!0).style("display","inline-block")}var E={d3Format:O,text:_,html:S,compound_id:j,image:P,checkbox:F,textField:V,call:$,rowCell:B,rowFactory:function(e){return(t,o)=>{e.forEach(e=>{const s=t.append("div").call(B).style("width",`${e.width}%`);o.hasOwnProperty(e.key)&&s.call(z[e.format],o,e)})}}};function R(e){return parseInt(e.select("input").property("value"))}function q(e){return parseFloat(e.select("input").property("value"))}var H={textBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","text")},updateTextBox:function(e,t){e.select("input").property("value",t)},textBoxValue:function(e){return e.select("input").property("value")},readonlyBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control-plaintext",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","text").attr("readonly","readonly")},textareaBox:function(e,t,o){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("textarea").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("rows",o)},updateTextareaBox:function(e,t){e.select("textarea").property("value",t)},updateTextareaPlaceholder:function(e,t){e.select("textarea").attr("placeholder",t)},textareaBoxValue:function(e){const t=e.select("textarea").property("value");if(t)return t;const o=e.select("textarea").attr("placeholder");return o||""},textareaBoxLines:function(e){const t=e.select("textarea").property("value");if(t)return t.split("\n").filter(e=>e.length>0);const o=e.select("textarea").attr("placeholder");return o?o.split("\n").filter(e=>e.length>0):[]},checkBox:function(e,t){const o=e.classed("form-group",!0).classed("form-row",!0).classed("form-check",!0).append("label").classed("form-check-label",!0).classed("col-form-label-sm",!0);o.append("input").classed("form-check-input",!0).attr("type","checkbox"),o.append("span").text(t)},updateCheckBox:function(e,t){e.select("input").property("checked",t)},checkBoxValue:function(e){return e.select("input").property("checked")},numberBox:function(e,t,o,s,n){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","number").attr("min",o).attr("max",s).attr("step",n)},updateNumberBox:function(e,t){e.select("input").property("value",t)},numberIntValid:function(e){const t=R(e),o=parseInt(e.select("input").attr("min")),s=parseInt(e.select("input").attr("max")),n=!isNaN(t)&&t>=o&&t<=s;return e.select("input").style("background-color",n?"#ffffff":"#ffcccc"),n},numberFloatValid:function(e){const t=q(e),o=parseInt(e.select("input").attr("min")),s=parseInt(e.select("input").attr("max")),n=!isNaN(t)&&t>=o&&t<=s;return e.select("input").style("background-color",n?"#ffffff":"#ffcccc"),n},numberBoxIntValue:R,numberBoxFloatValue:q,colorBox:function(t,o){t.classed("form-row",!0).classed("align-items-center",!0).on("change",()=>{e.event.stopPropagation()}),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).text(o),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).append("input").classed("form-control",!0).classed("form-control-sm",!0).attr("type","color")},updateColorBox:function(e,t){e.select("input").property("value",t)},colorBoxValue:function(e){return e.select("input").property("value")},fileInputBox:function(e,t,o){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",o)},clearFileInput:function(e){const t=e.select("input").attr();e.select("input").remove(),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",t)},fileInputBoxValue:function(e){return e.select("input").property("files")[0]}};return{DatagridState:class{constructor(e,t){this.storeID=e.storeID||null,this.viewID=e.viewID||null,this.name=e.name||null,this.sortOrder=e.sortOrder||[],this.filterText=e.filterText||null,this.rows=new k(t),this.visibleFields=null,this.sortedRecords=null,this.filteredRecords=null,this.defaultColumnHeight={numeric:40,text:40,html:40,none:200},this.scrollBarSpace=20,this.keyFunc=(e=>e.index),this.rowHeight=null,this.bodyHeight=null,this.viewportHeight=null,this.numViewportRows=null,this.viewportTop=0,this.previousViewportTop=null,this.viewportBottom=null,this.fixedViewportHeight=null,this.updateContentsNotifier=null,this.updateFilterNotifier=null,this.headerCellRenderer=L.headerCellRenderer,this.rowFactory=(()=>E.rowFactory(this.visibleFields))}setViewportSize(e){this.viewportHeight=this.fixedViewportHeight||e}setScrollPosition(e){this.previousViewportTop=this.viewportTop,this.viewportTop=e,this.viewportBottom=Math.min(this.viewportTop+this.numViewportRows,this.filteredRecords.length)}setNumViewportRows(){this.numViewportRows=Math.ceil(this.viewportHeight/this.rowHeight)+1}resizeViewport(e){this.setViewportSize(e),this.setNumViewportRows()}applyHeader(){this.visibleFields=this.rows.fields.filter(e=>e.visible);const e=this.visibleFields.reduce((e,t)=>e+(t.widthf||1),0);this.visibleFields=this.visibleFields.map(t=>{const o={width:(t.widthf||1)/e*100,height:t.height||this.defaultColumnHeight[c.sortType(t.format)]};return Object.assign(o,t)}),this.rowHeight=this.visibleFields.reduce((e,t)=>e.height>t.height?e:t,0).height}applyData(){this.setNumViewportRows(),this.applyOrder()}applyOrder(e,o){if(e)this.sortedRecords=t.orderBy(this.rows.records().slice(),[e],[o]);else{const e=this.sortOrder.map(e=>e.key),o=this.sortOrder.map(e=>e.order);e&&(this.sortedRecords=t.orderBy(this.rows.records().slice(),e,o))}this.applyFilter()}applyFilter(){if(null===this.filterText)this.filteredRecords=this.sortedRecords.slice();else{const e=this.visibleFields.filter(e=>"none"!==c.sortType(e.format)).map(e=>e.key);this.filteredRecords=this.sortedRecords.filter(t=>e.some(e=>c.partialMatch(this.filterText,t[e])))}this.bodyHeight=this.filteredRecords.length*this.rowHeight}setSortOrder(e,t){const o=this.sortOrder.findIndex(e=>e.key),s={key:e,order:t};-1!==o&&this.sortOrder.splice(o,1),this.sortOrder.splice(0,0,s),this.applyOrder(e,t)}setFilterText(e){this.filterText=e,this.applyFilter()}updateFields(e){this.rows.updateFields(e)}joinFields(e){this.rows.joinFields(e),this.applyData()}recordsToShow(){return this.filteredRecords.slice(this.viewportTop,this.viewportBottom)}save(){return m.updateItem(this.storeID,e=>{const t=e.dataset.findIndex(e=>e.collectionID===this.rows.collectionID);e.dataset[t]=this.rows.export();const o=e.views.findIndex(e=>e.viewID===this.viewID);e.views[o]=this.export()})}export(){return{$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:this.viewID,name:this.name,viewType:"datagrid",rows:this.rows.collectionID,sortOrder:this.sortOrder,filterText:this.filterText}}},component:L,rowFilter:{setFilter:function(e,t){const o=e.classed("row",!0).classed("justify-content-end",!0).append("div").classed("col-5",!0).call(H.textBox,"Search");o.select("label").classed("text-right",!0),o.select("input").on("keyup",function(){t.updateFilterNotifier(H.textBoxValue(o))})}},sort:{setSort:function(t,o){o.headerCellRenderer=(s=>{s.style("display","inline-block").style("width",e=>`${e.width}%`).text(e=>e.name).filter(e=>"none"!==c.sortType(e.format)).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",s=>{const n="v"===e.select(`#sort-${s.key}`).text();e.select(`#sort-${s.key}`).text(n?"^":"v"),o.setSortOrder(s.key,n?"desc":"asc"),t.call(L.updateRows,o)})})}},legacy:d}});
//# sourceMappingURL=kw-datagrid.js.map
