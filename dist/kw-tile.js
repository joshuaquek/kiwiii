// https://github.com/mojaie/kiwiii Version 1.0.0-alpha.3. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("d3"),require("lodash"),require("Dexie")):"function"==typeof define&&define.amd?define(["d3","lodash","Dexie"],t):e["kw-tile"]=t(e.d3,e._,e.Dexie)}(this,function(e,t,o){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,o=o&&o.hasOwnProperty("default")?o.default:o;var s={sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id","assay_id","list"].includes(e)?"text":["text_field","checkbox","html"].includes(e)?"html":"none"},formatNum:function(t,o){return null==t||Number.isNaN(t)?"":t==parseFloat(t)?e.format(o)(t):t},partialMatch:function(e,t){return null!=t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const l={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},n={datatable:"nodes",connection:"edges"};function a(e){const t=e.columns.map(e=>("numeric"===e.sort?e.format="numeric":"text"===e.sort?e.format="text":"none"===e.sort&&(e.format="raw"),e));return{id:e.id,name:e.name,dataType:n[e.format],schemaVersion:.8,revision:0,status:l[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function r(e){return{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:e.query,progress:e.progress,execTime:e.execTime,created:e.created,reference:{}}}function c(t){let o=t;return o.edges.hasOwnProperty("schemaVersion")||o.edges.hasOwnProperty("$schema")||(o.nodes=a(o.nodes),o.edges=function(e,t){const o={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(o.nodeColor.id=e.snapshot.nodeColor.id,o.nodeColor.scale=e.snapshot.nodeColor.scale,o.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):o.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(o.nodeSize.id=e.snapshot.nodeSize.id,o.nodeSize.scale=e.snapshot.nodeSize.scale,o.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):o.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(o.nodeLabel.id=e.snapshot.nodeLabel.id,o.nodeLabel.size=e.snapshot.nodeLabel.size,o.nodeLabel.text=e.snapshot.nodeLabel.text,o.nodeLabel.visible=e.snapshot.nodeLabel.visible,o.nodeLabel.scale=e.snapshot.nodeLabel.scale,o.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):o.nodeLabel={id:"label",size:12,text:"index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?o.nodeContent=e.snapshot.nodeContent:o.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?o.edge=e.snapshot.edge:o.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:n[e.format],schemaVersion:.8,revision:0,reference:{nodes:e.nodeTableId},status:l[e.status],fields:[{key:"source"},{key:"target"},{key:"weight"}],records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:o}}(o.edges,o.nodes.fields)),"0.8"!=o.edges.schemaVersion&&.1!==o.edges.schemaVersion||((o=function(e){if(e.edges.hasOwnProperty("reference")||(e.edges.reference={nodes:e.edges.nodesID}),e.nodes.fields.find(e=>"_index"===e.key)){const t={};e.nodes.records.forEach((e,o)=>{e.index=o,e.structure=e._structure,t[e._index]=e.index,delete e._index,delete e._structure}),e.edges.records.forEach(e=>{e.source=t[e.source],e.target=t[e.target]}),e.nodes.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")})}return e}(o)).nodes=r(o.nodes),o.edges=function(t){const o={networkThreshold:t.networkThreshold};return o.nodeContentVisible=t.snapshot.nodeContent.structure.visible,o.nodeColor=t.snapshot.nodeColor.scale||{},o.nodeColor.field&&(o.nodeColor.field=t.snapshot.nodeColor.field.key,"_index"===o.nodeColor.field&&(o.nodeColor.field="index")),"ordinal"===o.nodeColor.scale&&(o.nodeColor.range=e.schemeCategory20),o.nodeSize=t.snapshot.nodeSize.scale||{},t.snapshot.nodeSize.field&&(o.nodeSize.field=t.snapshot.nodeSize.field.key,"_index"===o.nodeSize.field&&(o.nodeSize.field="index")),o.nodeLabel={},t.snapshot.nodeLabel.text&&(o.nodeLabel.text=t.snapshot.nodeLabel.text.key,"_index"===o.nodeLabel.text&&(o.nodeLabel.text="index")),o.nodeLabel.size=t.snapshot.nodeLabel.size,o.nodeLabel.visible=t.snapshot.nodeLabel.visible,o.nodeLabelColor=t.snapshot.nodeLabel.scale||{},t.snapshot.nodeLabel.field&&(o.nodeLabelColor.field=t.snapshot.nodeLabel.field.key,"_index"===o.nodeLabelColor.field&&(o.nodeLabelColor.field="index")),"ordinal"===o.nodeLabelColor.scale&&(o.nodeLabelColor.range=e.schemeCategory20),o.edgeVisible=t.snapshot.edge.visible,o.edgeWidth=t.snapshot.edge.scale||{},o.edgeLabel={},o.edgeLabel.size=t.snapshot.edge.label.size,o.edgeLabel.visible=t.snapshot.edge.label.visible,o.networkThreshold=t.networkThreshold||t.query.threshold,o.coords=t.snapshot.nodePositions,{id:t.id,name:t.name,dataType:t.dataType,schemaVersion:"0.10",revision:t.revision,status:t.status,fields:t.fields,records:t.records,query:{params:t.query},progress:t.progress,execTime:t.execTime,created:t.created,snapshot:o,reference:t.reference}}(o.edges)),o.edges.hasOwnProperty("$schema")||(delete o.nodes.schemaVersion,delete o.edges.schemaVersion,delete o.nodes.revision,delete o.edges.revision,o.nodes.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json",o.edges.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),o}var i={convertPackage:function(e){let t={};if(!e.hasOwnProperty("views")){const o=new Date,s=e.hasOwnProperty("edges"),l=s?c(e):function(e){let t=e;return t.hasOwnProperty("schemaVersion")||t.hasOwnProperty("$schema")||(t=a(t)),"0.8"==t.schemaVersion&&(t=r(t=function(e){return e.records.forEach((e,t)=>{e.index=t,e.structure=e._structure,delete e._index,delete e._structure}),e.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")}),e}(t))),t.hasOwnProperty("$schema")||(delete t.schemaVersion,delete t.revision,t.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t.fields.forEach(e=>{"structure"===e.key&&(e.format="svg"),delete e.width,delete e.height}),t}(e),n=s?l.nodes:l;(t={$schema:"https://mojaie.github.io/kiwiii/specs/package_v1.0.json",name:l.edges.name,views:[],dataset:[]}).dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:n.id,name:n.name,contents:[{$schema:n.$schema,workflowID:n.reference.workflow,name:n.name,fields:n.fields,records:n.records,created:n.created,status:n.status,query:n.query,execTime:n.execTime,progress:n.progress}]}),t.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:n.id,name:n.name,viewType:"datagrid",rows:n.id,fields:n.fields,sortOrder:null,filterText:null,checkpoints:[{type:"convert",date:o.toString(),description:"converted from legacy format"}]}),s&&(t.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:l.edges.id,name:l.edges.name,contents:[{$schema:l.edges.$schema,workflowID:l.edges.reference.workflow,name:l.edges.name,fields:l.edges.fields,records:l.edges.records,created:l.edges.created,status:l.edges.status,query:l.edges.query,execTime:l.edges.execTime,progress:l.edges.progress}]}),t.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:l.edges.id,name:l.edges.name,viewType:"network",nodes:n.id,edges:l.edges.id,nodeColor:l.edges.snapshot.nodeColor,nodeSize:l.edges.snapshot.nodeSize,nodeLabel:l.edges.snapshot.nodeLabel,nodeLabelColor:l.edges.snapshot.nodeLabelColor,edgeWidth:l.edges.snapshot.edgeWidth,edgeLabel:l.edges.snapshot.edgeLabel,networkThreshold:l.edges.snapshot.networkThreshold,networkThresholdCutoff:l.edges.snapshot.networkThresholdCutoff,fieldTransform:l.edges.snapshot.fieldTransform,coords:l.edges.snapshot.coords,checkpoints:[{type:"convert",date:o.toString(),description:"converted from legacy format"}]})),t.views.filter(e=>"network"===e.viewType).forEach(e=>{e.minConnThld=e.networkThresholdCutoff,e.currentConnThld=e.networkThreshold,e.hasOwnProperty("nodeLabel")&&(e.nodeLabel.field=e.nodeLabel.text),e.hasOwnProperty("edgeLabel")&&(e.edgeLabel.field="weight"),e.hasOwnProperty("edgeWidth")&&(e.edgeWidth.field="weight")})}return t.views.filter(e=>"network"===e.viewType).forEach(e=>{e.nodeColor.field||(e.nodeColor.field="index"),e.nodeSize.field||(e.nodeSize.field="index"),e.nodeLabel.field||(e.nodeLabel.field="index"),e.nodeLabelColor.field||(e.nodeLabelColor.field="index"),e.edgeColor?e.edgeColor.field||(e.edgeColor.field="weight"):e.edgeColor={field:"weight",color:"monogray",scale:"linear",domain:[0,1],range:["#999999","#999999"],unknown:"#cccccc"},e.edgeWidth.field||(e.edgeWidth.field="weight"),e.edgeLabel.field||(e.edgeLabel.field="weight"),e.edgeLabelColor?e.edgeLabelColor.field||(e.edgeLabelColor.field="weight"):e.edgeLabelColor={field:"weight",color:"monoblack",scale:"linear",domain:[1,1],range:["#333333","#333333"],unknown:"#cccccc"}}),t}};const d={items:"storeID, sessionStarted"};let u=new o("Store");function f(){return u.items.orderBy("sessionStarted").reverse().toArray()}function p(e,t){return u.items.where("storeID").equals(e).modify(t).catch(e=>{console.error("IDBError: Update failed",e)})}u.version(1).stores(d);var h={reset:function(){return u.delete().then(()=>{(u=new o("Store")).version(1).stores(d)})},getAllItems:f,getItem:function(e){return u.items.where("storeID").equals(e).first().catch(t=>{console.error(`IDBError: Unexpected table ID: ${e}`,t)})},updateItem:p,deleteItem:function(e){return u.items.where("storeID").equals(e).delete()},getView:function(e,t){return f().then(t=>t.find(t=>t.storeID===e).views).then(o=>{const s=o.find(e=>e.viewID===t);if(s)return s.storeID=e,s})},appendView:function(e,t,o){return p(e,e=>{const s=e.views.findIndex(e=>e.viewID===t);e.views.splice(s+1,0,o)})},updateView:function(e,o,s){return p(e,e=>{const l=e.views.findIndex(e=>e.viewID===o);t.isFunction(s)?s(e.views[l]):e.views[l]=s})},deleteView:function(e,t){return p(e,e=>{const o=e.views.findIndex(e=>e.viewID===t);e.views.splice(o,1);const s={};e.dataset.forEach(e=>{s[e.collectionID]=0}),e.views.forEach(e=>{["rows","items","nodes","edges"].filter(t=>e.hasOwnProperty(t)).forEach(t=>{s[e[t]]+=1})}),Object.entries(s).forEach(t=>{if(!t[1]){const o=e.dataset.findIndex(e=>e.collectionID===t[0]);e.dataset.splice(o,1)}})})},getAllCollections:function(){return f().then(e=>t.flatten(e.map(e=>e.dataset.map(t=>(t.storeID=e.storeID,t)))))},getCollection:function(e,t){return f().then(t=>t.find(t=>t.storeID===e).dataset).then(o=>{const s=o.find(e=>e.collectionID===t);if(s)return s.storeID=e,s})},updateCollection:function(e,o,s){return p(e,e=>{const l=e.dataset.findIndex(e=>e.collectionID===o);t.isFunction(s)?s(e.dataset[l]):e.dataset[l]=s})},importItem:function(e){e=i.convertPackage(e);const t=new Date;return e.storeID=s.uuidv4().slice(0,8),e.sessionStarted=t.toString(),u.items.put(e)},newDatagrid:function(e){const t=(new Date).toLocaleString("en-GB",{timeZone:"Asia/Tokyo"}),o=s.uuidv4().slice(0,8),l=s.uuidv4().slice(0,8),n=e.workflowID.slice(0,8),a={$schema:"https://mojaie.github.io/kiwiii/specs/package_v1.0.json",storeID:o,name:e.name,views:[{$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:l,name:e.name,viewType:"datagrid",rows:n,checkpoints:[{type:"creation",date:t}]}],dataset:[{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:n,name:e.name,contents:[e]}],sessionStarted:t};return u.items.put(a).then(()=>({storeID:o,viewID:l}))},newNetwork:function(e,t,o,l){const n=s.uuidv4().slice(0,8),a=l.workflowID.slice(0,8);return p(e,e=>{e.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:n,name:`${o}_${l.name}`,viewType:"network",nodes:t,edges:a,minConnThld:l.query.params.threshold}),e.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:a,name:l.name,contents:[l]})}).then(()=>n)}};const m="../req/";function g(e,t={}){const o=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${m}${e}${o}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))}function x(e){return e.json()}var b={get:g,json:x,text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${m}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null},serverStatus:function(){const e={};return g("server").then(x).then(t=>{e.server=t}).then(()=>g("schema")).then(x).then(t=>{e.schema=t}).then(()=>e)}};function w(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}var y={singleToMulti:w,mappingToTable:function(e){const t=e.hasOwnProperty("field")?w(e):e;return{fields:[{key:t.key,format:"text"}].concat(t.fields),records:Object.entries(t.mapping).map(e=>{const o={};return o[t.key]=e[0],t.fields.forEach((t,s)=>{o[t.key]=e[1][s]}),o})}},tableToMapping:function(e,t,o=["index"]){const s={created:(new Date).toString(),fields:e.fields.filter(e=>e.key!==t).filter(e=>!o.includes(e.key)),key:t,mapping:{}};return e.records.forEach(e=>{s.mapping[e[t]]=s.fields.map(t=>e[t.key])}),s},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),o=t.shift().split(","),s=o.shift(),l=new Date,n=[],a=[];o.forEach((e,t)=>{""!==e&&(n.push(t),a.push({key:e,format:"text"}))});const r={created:l.toString(),fields:a,key:s,mapping:{}};return t.forEach(e=>{const t=e.split(","),o=t.shift();r.mapping[o]=Array(n.length),n.forEach(e=>{r.mapping[o][e]=t[e]})}),r},apply:function(e,o){const s=o.hasOwnProperty("field")?w(o):o;e.records.filter(e=>s.mapping.hasOwnProperty(e[s.key])).forEach(e=>{s.fields.forEach((t,o)=>{e[t.key]=s.mapping[e[s.key]][o]})}),e.fields=t(e.fields).concat(s.fields).uniqBy("key").value()}};class v{constructor(e){this.autoIndex="index",this.collectionID=e.collectionID||null,this.storeID=e.storeID||null,this.name=e.name||null,e.records?(this.contents=[e],this.fields=[]):(this.contents=e.contents,this.fields=e.fields||[]),this.contents.forEach(e=>{e.fields.forEach(e=>this.addField(e))})}addField(e){this.fields.find(t=>t.key===e.key)||(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),this.fields.push(e))}updateFields(e){this.fields=[],e.forEach(e=>this.addField(e))}joinFields(e){this.contents.forEach(t=>{y.apply(t,e)}),e.hasOwnProperty("fields")?e.fields.forEach(e=>this.addField(e)):this.addField(e.field)}apply(e){this.contents.forEach(t=>{t.records.forEach(t=>{e(t)})})}records(){return t.flatten(this.contents.map(e=>e.records))}fetch(e){const t=this.contents.filter(e=>["running","ready","interrupted","queued"].includes(e.status)).map(t=>{const o={id:t.workflowID,command:e};return b.get("progress",o).then(b.json).then(e=>h.updateCollection(this.storeID,this.collectionID,t=>{const s=t.contents.findIndex(e=>e.workflowID===o.id);"failure"===e.status?t.contents[s].status="failure":t.contents[s]=e}))});return Promise.all(t).then(()=>h.getCollection(this.storeID,this.collectionID)).then(e=>{this.contents=e.contents})}pull(){return this.fetch("pull")}abort(){return this.fetch("abort")}size(){return t.sum(this.contents.map(e=>e.records.length))}status(){return this.contents.some(e=>"interrupted"===e.status)?"interrupted":this.contents.some(e=>"running"===e.status)?"running":this.contents.some(e=>"queued"===e.status)?"queued":this.contents.some(e=>"ready"===e.status)?"ready":this.contents.some(e=>"aborted"===e.status)?"aborted":this.contents.some(e=>"failure"===e.status)?"failure":"done"}ongoing(){return["ready","queued","running","interrupted"].includes(this.status())}progress(){return t.min(this.contents.map(e=>e.progress))}execTime(){return t.sum(this.contents.map(e=>e.execTime))}export(){return{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:this.collectionID,name:this.name,fields:this.fields,contents:this.contents}}}class k{constructor(e,t,o){this.fieldWidth=e,this.fieldHeight=t,this.viewBox={top:0,right:this.fieldWidth,bottom:this.fieldHeight,left:0},this.focusArea={},this.focusAreaMargin=50,this.boundary={top:0,right:this.fieldWidth,bottom:this.fieldHeight,left:0},this.transform=o||{x:0,y:0,k:1},this.prevTransform={x:this.transform.x,y:this.transform.y,k:this.transform.k},this.resizeNotifier=(()=>{})}setFocusArea(){const e=this.transform.x,t=this.transform.y,o=this.transform.k,s=this.focusAreaMargin;this.focusArea.top=(this.viewBox.top-t)/o-s,this.focusArea.left=(this.viewBox.left-e)/o-s,this.focusArea.bottom=(this.viewBox.bottom-t)/o+s,this.focusArea.right=(this.viewBox.right-e)/o+s}setViewBox(e,t){this.viewBox.right=e,this.viewBox.bottom=t,this.setFocusArea()}setTransform(e,t,o){this.transform.x=e,this.transform.y=t,this.transform.k=o,this.setFocusArea()}fitTransform(){const e=this.viewBox.bottom,t=this.viewBox.right,o=t/e,s=this.boundary.bottom-this.boundary.top,l=this.boundary.right-this.boundary.left,n=o>=l/s,a=n?e/s:t/l,r=n?(t-l*a)/2:0,c=n?0:(e-s*a)/2,i=-this.boundary.left*a+r,d=-this.boundary.top*a+c;this.setTransform(i,d,a)}showTransform(){e.select("#debug-transform").text(JSON.stringify(this.transform))}showFocusArea(){e.select("#debug-focusarea").text(JSON.stringify(this.focusArea))}showViewBox(){e.select("#debug-viewbox").text(JSON.stringify(this.viewBox))}}const B=[{key:"monoblack",type:"monocolor",colors:["#333333"],unknown:"#333333"},{key:"monogray",type:"monocolor",colors:["#cccccc"],unknown:"#cccccc"},{key:"nodeDefault",type:"monocolor",colors:["#7fffd4"],unknown:"#7fffd4"},{key:"aquamarine",type:"bicolor",colors:["#778899","#7fffd4"],unknown:"#f0f0f0"},{key:"chartreuse",type:"bicolor",colors:["#778899","#7fff00"],unknown:"#f0f0f0"},{key:"salmon",type:"bicolor",colors:["#778899","#fa8072"],unknown:"#f0f0f0"},{key:"violet",type:"bicolor",colors:["#778899","#ee82ee"],unknown:"#f0f0f0"},{key:"temperature",type:"tricolor",colors:["#87ceeb","#fff5ee","#fa8072"],unknown:"#f0f0f0"},{key:"spectrum",type:"tricolor",colors:["#6495ed","#ccff66","#ffa500"],unknown:"#f0f0f0"},{key:"category10",type:"categorical",colors:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#bc80bd","#ccebc5"],unknown:"#f0f0f0"},{key:"cbsafe",type:"categorical",colors:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],unknown:"#f0f0f0"},{key:"category20",type:"categorical",colors:e.schemePaired.concat(e.schemeSet2),unknown:"#f0f0f0"},{key:"category40",type:"categorical",colors:e.schemePaired.concat(e.schemePastel2,e.schemeSet2,e.schemeSet3),unknown:"#f0f0f0"},{key:"custom",type:"custom",colors:["#ffffff"],text:"custom"}],C=[{key:"linear",name:"Linear",func:e.scaleLinear},{key:"log",name:"Log",func:e.scaleLog},{key:"quantize",name:"Quantize",func:e.scaleQuantize},{key:"ordinal",name:"Ordinal",func:e.scaleOrdinal}];var I={colorScales:B,types:C,scaleFunction:function(e){const t=B.find(t=>t.key===e.color);let o,s;t&&"custom"!==t.key?(o=t.colors,s=t.unknown):(o=e.range,s=e.unknown);let l=null;if(3===o.length){const t=(parseFloat(e.domain[0])+parseFloat(e.domain[1]))/2;l=[e.domain[0],t,e.domain[1]]}else l=e.domain;let n=C.find(t=>t.key===e.scale).func();return n=(n=n.domain(l)).range(o),["linear","log"].includes(e.scale)&&(n=n.clamp(!0)),t=>{if(""===t||null==t)return s;if(["linear","log"].includes(e.scale)&&parseFloat(t)!=t)return s;if("log"===e.scale&&t<=0)return s;const o=n(t);return void 0===o?s:o}},isD3Format:function(t){try{e.format(t)}catch(e){return!1}return!0}};function V(e){return parseInt(e.select("input").property("value"))}function S(e){return parseFloat(e.select("input").property("value"))}var T={textBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","text")},updateTextBox:function(e,t){e.select("input").property("value",t)},textBoxValue:function(e){return e.select("input").property("value")},readonlyBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control-plaintext",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","text").attr("readonly","readonly")},textareaBox:function(e,t,o){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("textarea").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("rows",o)},updateTextareaBox:function(e,t){e.select("textarea").property("value",t)},updateTextareaPlaceholder:function(e,t){e.select("textarea").attr("placeholder",t)},textareaBoxValue:function(e){const t=e.select("textarea").property("value");if(t)return t;const o=e.select("textarea").attr("placeholder");return o||""},textareaBoxLines:function(e){const t=e.select("textarea").property("value");if(t)return t.split("\n").filter(e=>e.length>0);const o=e.select("textarea").attr("placeholder");return o?o.split("\n").filter(e=>e.length>0):[]},checkBox:function(e,t){const o=e.classed("form-group",!0).classed("form-row",!0).classed("form-check",!0).append("label").classed("form-check-label",!0).classed("col-form-label-sm",!0);o.append("input").classed("form-check-input",!0).attr("type","checkbox"),o.append("span").text(t)},updateCheckBox:function(e,t){e.select("input").property("checked",t)},checkBoxValue:function(e){return e.select("input").property("checked")},numberBox:function(e,t,o,s,l){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","number").attr("min",o).attr("max",s).attr("step",l)},updateNumberBox:function(e,t){e.select("input").property("value",t)},numberIntValid:function(e){const t=V(e),o=parseInt(e.select("input").attr("min")),s=parseInt(e.select("input").attr("max")),l=!isNaN(t)&&t>=o&&t<=s;return e.select("input").style("background-color",l?"#ffffff":"#ffcccc"),l},numberFloatValid:function(e){const t=S(e),o=parseInt(e.select("input").attr("min")),s=parseInt(e.select("input").attr("max")),l=!isNaN(t)&&t>=o&&t<=s;return e.select("input").style("background-color",l?"#ffffff":"#ffcccc"),l},numberBoxIntValue:V,numberBoxFloatValue:S,colorBox:function(t,o){t.classed("form-row",!0).classed("align-items-center",!0).on("change",()=>{e.event.stopPropagation()}),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).text(o),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).append("input").classed("form-control",!0).classed("form-control-sm",!0).attr("type","color")},updateColorBox:function(e,t){e.select("input").property("value",t)},colorBoxValue:function(e){return e.select("input").property("value")},fileInputBox:function(e,t,o){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",o)},clearFileInput:function(e){const t=e.select("input").attr();e.select("input").remove(),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",t)},fileInputBoxValue:function(e){return e.select("input").property("files")[0]}};function D(e,t,o){e.attr("viewBox","0 0 100 10").attr("preserveAspectRatio","none");const s=e.append("g");s.append("rect").attr("x",0).attr("y",0).attr("width",100).attr("height",10).attr("fill",t[0]),s.append("text").attr("text-anchor","middle").attr("x",50).attr("y",10).attr("font-size",12).text(o)}var L={colorBar:{monocolor:D,bicolor:function(e,t,o){const l=s.uuidv4().slice(0,8);e.call(D,t,o);const n=e.append("defs").append("linearGradient").attr("id",l);n.append("stop").attr("offset",0).attr("stop-color",t[0]),n.append("stop").attr("offset",1).attr("stop-color",t[1]),e.select("rect").attr("fill",`url(#${l})`)},tricolor:function(e,t,o){const l=s.uuidv4().slice(0,8);e.call(D,t,o);const n=e.append("defs").append("linearGradient").attr("id",l);n.append("stop").attr("offset",0).attr("stop-color",t[0]),n.append("stop").attr("offset",.5).attr("stop-color",t[1]),n.append("stop").attr("offset",1).attr("stop-color",t[2]),e.select("rect").attr("fill",`url(#${l})`)},categorical:function(e,t,o){e.attr("viewBox","0 0 100 10").attr("preserveAspectRatio","none");const s=100/t.length,l=e.append("g");t.forEach((e,o)=>{l.append("rect").attr("x",s*o).attr("y",0).attr("width",s).attr("height",20).attr("fill",t[o])}),l.append("text").attr("text-anchor","middle").attr("x",50).attr("y",20).attr("font-size",20).text(o)},custom:D},setSize:function(e,t,o){e.attr("width",t).attr("height",o)}};function P(e){return e.selectAll("input:checked").data().map(e=>e.key)}function z(e,t){const o=e.select(".selected");o.selectAll("svg").remove(),o.datum(t),o.append("svg").call(L.colorBar[t.type],t.colors,t.text).call(L.setSize,100,10)}var A={selectBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("select").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0)},selectBoxItems:function(e,t){const o=e.select("select").selectAll("option").data(t,e=>e.key);o.exit().remove(),o.enter().append("option").attr("value",e=>e.key).text(e=>e.name)},updateSelectBox:function(e,t){e.select("select").property("value",t)},selectBoxValue:function(e){return e.select("select").property("value")},checklistBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("ul").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0)},checklistBoxItems:function(e,t){const o=e.select("ul").selectAll("li").data(t,e=>e.key);o.exit().remove();const s=o.enter().append("li").attr("class","form-check").append("label").attr("class","form-check-label");s.append("input").attr("type","checkbox").attr("class","form-check-input").property("value",e=>e.key),s.append("span").text(e=>e.name)},updateChecklistBox:function(t,o){o&&t.selectAll("input").each(function(t){e.select(this).property("checked",o.includes(t.key))})},checklistBoxValue:P,anyChecked:function(e){return P(e).length>0},colorScaleBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t||"Colorscale");const o=e.append("div").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0),s=o.append("div").classed("btn-group",!0).classed("mr-1",!0);s.append("button").classed("btn",!0).classed("btn-light",!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown"),s.append("div").classed("dropdown-menu",!0).classed("py-0",!0),o.append("span").classed("selected",!0)},colorScaleBoxItems:function(t,o){const s=t.select(".dropdown-menu").selectAll("a").data(o,e=>e);s.exit().remove(),s.enter().append("a").classed("dropdown-item",!0).classed("py-0",!0).attr("href","#").attr("title",e=>e.key).on("click",function(e){t.call(z,e),t.dispatch("change",{bubbles:!0})}).append("svg").each(function(t){e.select(this).call(L.colorBar[t.type],t.colors,t.text).call(L.setSize,100,10)})},updateColorScaleBox:function(e,t){const o=e.select(".dropdown-menu").selectAll("a").data().find(e=>e.key===t);e.call(z,o)},colorScaleBoxValue:function(e){return e.select(".selected").datum().key},colorScaleBoxItem:function(e){return e.select(".selected").datum()}};function F(e){const t=e.select(".min").property("value"),o=e.select(".max").property("value"),s=e=>""!==e&&!isNaN(e);return e.select(".min").style("background-color",s(t)?"#ffffff":"#ffcccc"),e.select(".max").style("background-color",s(o)?"#ffffff":"#ffcccc"),s(t)&&s(o)}var N={rangeBox:function(e,t){e.classed("form-row",!0).classed("align-items-center",!0),e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).text(t);const o=e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0);o.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).text("min"),o.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("min",!0).attr("type","text");const s=e.append("div").classed("form-group",!0).classed("col-4",!0).classed("mb-1",!0);s.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).text("max"),s.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("max",!0).attr("type","text")},updateRangeBox:function(t,o){t.select(".min").property("value",o[0]),t.select(".max").property("value",o[1]),t.selectAll(".min,.max").on("input",function(){F(t)||e.event.stopPropagation()}).dispatch("input",{bubbles:!0})},rangeBoxValues:function(e){return[parseFloat(e.select(".min").property("value")),parseFloat(e.select(".max").property("value"))]},rangeBoxValid:F,colorRangeBox:function(t,o){t.classed("form-row",!0).classed("align-items-center",!0),t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0).text(o);const s=t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0);s.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).text("min"),s.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("min",!0).attr("type","color");const l=t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0);l.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).text("mid"),l.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("mid",!0).attr("type","color");const n=t.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-3",!0).classed("mb-1",!0);n.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("py-0",!0).text("max"),n.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("max",!0).attr("type","color"),t.on("change",()=>{e.event.stopPropagation()})},updateColorRangeBox:function(e,t){e.select(".min").property("value",t[0]),e.select(".mid").property("value",t[1]),e.select(".max").property("value",t[2])},colorRangeBoxValues:function(e){return[e.select(".min").property("value"),e.select(".mid").property("value"),e.select(".max").property("value")]}};function O(e){if(!N.rangeBoxValid(e.select(".domain")))return!1;if("linear"===A.selectBoxValue(e.select(".scale")))return!0;const t=N.rangeBoxValues(e.select(".domain"));e.select(".domain").select(".min").style("background-color",t[0]>0?"#ffffff":"#ffcccc"),e.select(".domain").select(".max").style("background-color",t[1]>0?"#ffffff":"#ffcccc");const o=""!==A.selectBoxValue(e.select(".scale"));return e.select(".scale").select("select").style("background-color",o?"#ffffff":"#ffcccc"),t[0]>0&&t[1]>0&&o}var R={colorRangeGroup:function(e,t){e.classed("mb-3",!0),e.append("div").classed("colorscale",!0).classed("mb-2",!0).call(A.colorScaleBox,"Colorscale").call(A.colorScaleBoxItems,t);const o=s.uuidv4().slice(0,8);e.append("div").classed("form-row",!0).classed("justify-content-end",!0).append("button").classed("btn",!0).classed("btn-sm",!0).classed("btn-outline-primary",!0).classed("dropdown-toggle",!0).attr("data-toggle","collapse").attr("data-target",`#${o}-collapse`).attr("aria-expanded","false").attr("aria-controls",`${o}-collapse`).text("Custom colorscale");const l=e.append("div").classed("collapse",!0).attr("id",`${o}-collapse`).append("div").classed("card",!0).classed("card-body",!0).classed("p-2",!0);l.append("div").classed("rangetype",!0).classed("mb-1",!0).call(A.selectBox,"Range type").call(A.selectBoxItems,[{key:"continuous",name:"Continuous"},{key:"two-piece",name:"Two-piece"}]),l.append("div").classed("range",!0).classed("mb-1",!0).call(N.colorRangeBox,"Range"),l.append("div").classed("unknown",!0).classed("mb-1",!0).call(T.colorBox,"Unknown")},updateColorRangeGroup:function(e,t,o,s){const l=()=>{const t=A.colorScaleBoxValue(e.select(".colorscale")),o=A.selectBoxValue(e.select(".rangetype")),s="custom"===t;e.selectAll(".rangetype, .range, .unknown").selectAll("select, input").property("disabled",!s).style("opacity",s?null:.3),e.select(".range").select(".mid").property("disabled",!s||"continuous"===o).style("opacity",s&&"continuous"!==o?null:.3)};e.select(".colorscale").call(A.updateColorScaleBox,t).on("change",function(){l()});const n=2===o.length?"continuous":"two-piece";e.select(".rangetype").call(A.updateSelectBox,n).on("change",function(){l()}).dispatch("change");const a=2===o.length?[o[0],null,o[1]]:o;e.select(".range").call(N.updateColorRangeBox,a).on("focusin",()=>{e.dispatch("change",{bubbles:!0})}),e.select(".unknown").call(T.updateColorBox,s).on("focusin",()=>{e.dispatch("change",{bubbles:!0})})},colorRangeGroupValue:function(e){const t=A.colorScaleBoxItem(e.select(".colorscale")),o=A.selectBoxValue(e.select(".rangetype")),s=N.colorRangeBoxValues(e.select(".range")),l=T.colorBoxValue(e.select(".unknown"));return{color:t.key,colorScaleType:t.type,range:"continuous"===o?[s[0],s[2]]:s,unknown:l}},scaleBoxGroup:function(e){e.classed("mb-3",!0),e.append("div").classed("scale",!0).classed("mb-1",!0).call(A.selectBox,"Scale").call(A.selectBoxItems,[{key:"linear",name:"Linear"},{key:"log",name:"Log"}]),e.append("div").classed("domain",!0).classed("mb-1",!0).call(N.rangeBox,"Domain")},updateScaleBoxGroup:function(t,o,s){t.select(".scale").call(A.updateSelectBox,o),t.select(".domain").call(N.updateRangeBox,s).on("input",function(){O(t)}),t.selectAll(".scale, .domain").on("change",function(){O(t)||e.event.stopPropagation()})},scaleBoxGroupValue:function(e){return{scale:A.selectBoxValue(e.select(".scale"))||"linear",domain:N.rangeBoxValues(e.select(".domain"))}},scaleBoxGroupValid:O};function $(e,t,o){e.append("div").classed("field",!0).call(A.selectBox,o||"Field"),e.append("div").classed("range",!0).call(R.colorRangeGroup,t),e.append("div").classed("scale",!0).call(R.scaleBoxGroup)}function j(t,o,s){t.select(".field").call(A.selectBoxItems,o).call(A.updateSelectBox,s.field),t.select(".range").call(R.updateColorRangeGroup,s.color,s.range,s.unknown),t.select(".scale").call(R.updateScaleBoxGroup,s.scale,s.domain),t.selectAll(".field, .range, .scale").on("change",function(){_(t)||e.event.stopPropagation()}).dispatch("change")}function _(e){const t=R.colorRangeGroupValue(e.select(".range")),o=["categorical","monocolor"].includes(t.colorScaleType);e.select(".scale").selectAll("select,input").property("disabled",o).style("opacity",o?.3:null);const s=R.scaleBoxGroupValid(e.select(".scale"));return o||s}function E(e){const t=R.colorRangeGroupValue(e.select(".range")),o=R.scaleBoxGroupValue(e.select(".scale"));return{field:A.selectBoxValue(e.select(".field")),color:t.color,range:t.range,unknown:t.unknown,scale:"categorical"===t.colorScaleType?"ordinal":o.scale,domain:o.domain}}function q(e){if(!N.rangeBoxValid(e.select(".range")))return!1;const t=N.rangeBoxValues(e.select(".range")),o=T.textBoxValue(e.select(".unknown")),s=""!==o&&!isNaN(o)&&o>0;return e.select(".range").select(".min").style("background-color",t[0]>0?"#ffffff":"#ffcccc"),e.select(".range").select(".max").style("background-color",t[1]>0?"#ffffff":"#ffcccc"),e.select(".unknown").select("input").style("background-color",s?"#ffffff":"#ffcccc"),t[0]>0&&t[1]>0&&s}function W(e){return!!R.scaleBoxGroupValid(e.select(".scale"))&&q(e)}function G(e){return!!T.numberFloatValid(e.select(".size"))&&_(e)}var M={colorControlBox:$,updateColorControlBox:j,colorControlValid:_,colorControlBoxState:E,sizeControlBox:function(e,t){e.append("div").classed("field",!0).call(A.selectBox,t||"Field"),e.append("div").classed("range",!0).call(N.rangeBox,"Range"),e.append("div").classed("unknown",!0).classed("mb-3",!0).call(T.textBox,"Unknown",0,1e3,1).select("input").classed("col-8",!1).classed("col-3",!0),e.append("div").classed("scale",!0).call(R.scaleBoxGroup)},updateSizeControlBox:function(t,o,s){t.select(".field").call(A.selectBoxItems,o).call(A.updateSelectBox,s.field),t.select(".range").call(N.updateRangeBox,s.range),t.select(".unknown").call(T.updateTextBox,s.unknown),t.select(".scale").call(R.updateScaleBoxGroup,s.scale,s.domain),t.selectAll(".range, .unknown").on("input",function(){q(t)}),t.selectAll(".field, .range, .unknown, .scale").on("change",function(){W(t)||e.event.stopPropagation()})},sizeControlValid:W,sizeControlBoxState:function(e){const t=R.scaleBoxGroupValue(e.select(".scale"));return{field:A.selectBoxValue(e.select(".field")),range:N.rangeBoxValues(e.select(".range")),unknown:T.textBoxValue(e.select(".unknown")),scale:t.scale,domain:t.domain}},labelControlBox:function(e,t){e.append("div").append("div").classed("visible",!0).call(T.checkBox,"Show labels");const o=e.append("div").classed("mb-3",!0);o.append("div").classed("text",!0).classed("mb-1",!0).call(A.selectBox,"Text field"),o.append("div").classed("size",!0).classed("mb-1",!0).call(T.numberBox,"Font size",4,100,1),e.call($,t,"Color field")},updateLabelControlBox:function(t,o,s,l){t.select(".visible").call(T.updateCheckBox,s.visible),t.select(".text").call(A.selectBoxItems,o).call(A.updateSelectBox,s.field),t.select(".size").call(T.updateNumberBox,s.size).on("input",function(){T.numberFloatValid(e.select(this))}),t.call(j,o,l).selectAll(".visible, .text, .size, .field, .range, .scale").on("change",function(){G(t)||e.event.stopPropagation()}).dispatch("change")},labelControlValid:G,labelControlBoxState:function(e){return{label:{field:A.selectBoxValue(e.select(".text")),size:T.numberBoxFloatValue(e.select(".size")),visible:T.checkBoxValue(e.select(".visible"))},labelColor:E(e)}},controlBoxFrame:function(e,t,o){e.append("nav").append("div").classed("nav",!0).classed("nav-tabs",!0).attr("id",t).attr("role","tablist"),e.append("div").classed("tab-content",!0).classed("p-2",!0).attr("id",o)},controlBoxNav:function(e,t,o){e.classed("nav-item",!0).classed("nav-link",!0).classed("py-1",!0).attr("id",`${t}-tab`).attr("data-toggle","tab").attr("href",`#${t}`).attr("role","tab").attr("aria-controls",t).attr("aria-selected","false").text(o)},controlBoxItem:function(e,t){e.classed("tab-pane",!0).classed("fade",!0).classed("container",!0).classed("px-0",!0).attr("id",t).attr("role","tabpanel").attr("aria-labelledby",`${t}-tab`)}};function H(e){const t=e.append("div").classed("panel-group",!0).classed("mb-3",!0);t.append("div").classed("rowcnt",!0).classed("mb-1",!0).call(T.numberBox,"Rows",1,9999,1),t.append("div").classed("colcnt",!0).classed("mb-1",!0).call(T.numberBox,"Columns",1,9999,1),t.append("div").classed("groupby",!0).classed("mb-1",!0).call(A.selectBox,"GroupBy"),t.append("div").classed("crow",!0).classed("mb-1",!0).call(T.numberBox,"ChunksPerRow",1,999,1),t.append("div").classed("showcol",!0).classed("mb-1",!0).call(T.checkBox,"Show column number"),t.append("div").classed("showrow",!0).classed("mb-1",!0).call(T.checkBox,"Show row number")}function J(e,t){const o=e.select(".panel-group");o.select(".rowcnt").call(T.updateNumberBox,t.rowCount),o.select(".colcnt").call(T.updateNumberBox,t.columnCount),o.select(".groupby").call(A.selectBoxItems,t.items.fields.filter(e=>"none"!==s.sortType(e.format))).call(A.updateSelectBox,t.groupField||""),o.select(".crow").call(T.updateNumberBox,t.chunksPerRow),o.select(".showcol").call(T.updateCheckBox,t.showColumnNumber),o.select(".showrow").call(T.updateCheckBox,t.showRowNumber),o.selectAll(".rowcnt, .colcnt, .groupby, .crow, .showcol, .showrow").on("change",function(){t.rowCount=T.numberBoxIntValue(o.select(".rowcnt")),t.columnCount=T.numberBoxIntValue(o.select(".colcnt")),t.groupField=A.selectBoxValue(o.select(".groupby")),t.chunksPerRow=T.numberBoxIntValue(o.select(".crow")),t.showColumnNumber=T.checkBoxValue(o.select(".showcol")),t.showRowNumber=T.checkBoxValue(o.select(".showrow")),t.updateFieldNotifier()})}function U(e,o){const l=o.items.fields.filter(e=>"none"!==s.sortType(e.format));e.call(M.updateColorControlBox,l,o.tileColor).on("change",function(){if(o.tileColor=M.colorControlBoxState(e),"ordinal"===o.tileColor.scale){const e=o.items.records().map(e=>e[o.tileColor.field]);o.tileColor.domain=t.uniq(e).sort()}o.updateItemAttrNotifier()})}function Q(e,o){const l=o.items.fields.filter(e=>"none"!==s.sortType(e.format));e.call(M.updateLabelControlBox,l,o.tileValue,o.tileValueColor).on("change",function(){const s=M.labelControlBoxState(e);if(o.tileValue=s.label,o.tileValueColor=s.labelColor,"ordinal"===o.tileValueColor.scale){const e=o.items.records().map(e=>e[o.tileValueColor.field]);o.tileValueColor.domain=t.uniq(e).sort()}o.updateItemAttrNotifier()})}function Y(e,t){e.select(".control-main").call(J,t),e.select(".control-color").call(U,t),e.select(".control-value").call(Q,t)}function Z(e,t){const o=e.node(),s=o.offsetWidth,l=o.offsetHeight;e.select(".view").attr("viewBox",`0 0 ${s} ${l}`).select(".boundary").attr("width",s).attr("height",l),t.setViewBox(s,l),t.resizeNotifier()}var K={transform:function(e,t,o,s){e.select(".field").attr("transform",`translate(${t}, ${o}) scale(${s})`)},resize:Z,viewFrame:function(e,t){e.style("width","100%").style("height","100%"),e.select(".view").remove(),e.append("svg").classed("view",!0),e.call(Z,t)},view:function(e,t){e.attr("preserveAspectRatio","xMinYMin meet").attr("pointer-events","all").attr("viewBox",`0 0 ${t.viewBox.right} ${t.viewBox.bottom}`).style("width","100%").style("height","100%"),e.select(".boundary").remove(),e.select(".field").remove(),e.append("rect").classed("boundary",!0).attr("x",0).attr("y",0).attr("width",t.viewBox.right).attr("height",t.viewBox.bottom).attr("fill","#ffffff").attr("stroke-width",1).attr("stroke","#cccccc"),e.append("g").classed("field",!0).style("opacity",1e-6).transition().duration(1e3).style("opacity",1)}};function X(e,t){const o=t.itemsToRender(),s=e.selectAll(".item").data(o,e=>e.index);s.exit().remove();const l=s.enter().append("g").attr("class","item");l.append("rect").attr("class","tile").attr("x",0).attr("y",0).style("stroke-width",1).style("stroke","#cccccc"),l.append("g").attr("class","tile-content"),l.append("text").attr("class","tile-value");const n=l.merge(s);n.select(".tile").attr("width",t.columnWidth).attr("height",t.rowHeight),t.enableFocusedView&&(t.focusedView=o.length<t.focusedViewThreshold),t.focusedView&&t.tileContent.visible?(n.select(".tile-content").html(e=>e.structure),n.select(".tile-content").select("svg").attr("width",t.columnWidth).attr("height",t.rowHeight)):n.select(".tile-content").select("svg").remove(),e.call(ee,t)}function ee(e,t){const o=I.scaleFunction(t.tileColor),l=I.scaleFunction(t.tileValueColor),n=e.selectAll(".item").attr("transform",e=>`translate(${e.x}, ${e.y})`);n.select(".tile").style("fill",e=>o(e[t.tileColor.field])),n.select(".tile-value").text(e=>{if(null===t.tileValue.field)return"";const o=t.items.fields.find(e=>e.key===t.tileValue.field);return"d3_format"===o.format?s.formatNum(e[t.tileValue.field],o.d3_format):e[t.tileValue.field]}).attr("x",.05*t.columnWidth).attr("y",.75*t.rowHeight).attr("font-size",.5*t.rowHeight).attr("textLength",.9*t.columnWidth).attr("lengthAdjust","spacingAndGlyphs").attr("visibility",t.tileValue.visible?"inherit":"hidden").style("fill",e=>l(e[t.tileValueColor.field]))}function te(t,o){return e.zoom().scaleExtent(o.scaleExtent).translateExtent(o.translateExtent).on("zoom",function(){const o=e.event.transform;t.call(K.transform,o.x,o.y,o.k)}).on("end",function(){const t=e.event.transform;o.setTransform(t.x,t.y,t.k),o.prevTransform={x:t.x,y:t.y,k:t.k},o.updateItemNotifier()})}return{TileState:class extends k{constructor(e,t){super(1200,800,e.fieldTransform),this.chunkMarginRatio=.05,this.focusedViewThreshold=200,this.enableFocusedView=!0,this.focusedView=!1,this.viewID=e.viewID||null,this.storeID=e.storeID||null,this.name=e.name,this.items=new v(t),this.its=JSON.parse(JSON.stringify(this.items.records())),this.rowCount=e.rowCount||8,this.columnCount=e.columnCount||12,this.groupField=e.groupField||null,this.chunksPerRow=e.chunksPerRow||1,this.fixRowCount=e.fixRowCount||!1,this.fixColumnCount=e.fixColumnCount||!1,this.tileAspectRatio=1,this.showRowNumber=e.showRowNumber||!1,this.showColumnNumber=e.showColumnNumber||!1;const o=this.items.fields[0].key||null,s=(e,t)=>{Object.entries(t).forEach(t=>{e.hasOwnProperty(t[0])||(e[t[0]]=t[1])})};this.tileContent={},e.hasOwnProperty("tileContent")&&(this.tileContent=e.tileContent),s(this.tileContent,{field:null,visible:!1}),this.tileColor={};const l={field:o,color:"monogray",scale:"linear",domain:[0,1],range:["#7fffd4","#7fffd4"],unknown:"#7fffd4"};e.hasOwnProperty("tileColor")&&(this.tileColor=e.tileColor),s(this.tileColor,l),this.tileValue={},e.hasOwnProperty("tileValue")&&(this.tileValue=e.tileValue),s(this.tileValue,{field:null,size:12,visible:!1,halign:2,valign:2}),this.tileValueColor={};const n={field:o,color:"monoblack",scale:"linear",domain:[0,1],range:["#7fffd4","#7fffd4"],unknown:"#7fffd4"};e.hasOwnProperty("tileValueColor")&&(this.tileValueColor=e.tileValueColor),s(this.tileValueColor,n),this.scaleExtent=[1,1/0],this.translateExtent=[[0,0],[this.fieldWidth,1/0]],this.chunkWidth=null,this.chunkHeight=null,this.chunkMarginH=null,this.chunkMarginV=null,this.columnWidth=null,this.rowHeight=null,this.zoomListener=null,this.updateFieldNotifier=null,this.updateItemNotifier=null,this.updateItemAttrNotifier=null}setViewBox(e,t){this.viewBox.right=e,this.viewBox.bottom=t;const o=this.viewBox.right,s=this.boundary.right-this.boundary.left;this.scaleExtent=[o/s,1/0],this.translateExtent=[[0,0],[s,1/0]],this.setTransform(0,0,o/s),this.setFocusArea()}setCoords(){this.its.forEach(e=>{const t=Math.floor(e.chunk/this.chunksPerRow),o=e.chunk%this.chunksPerRow;e.x=this.chunkWidth*o+this.chunkMarginH*(o+1)+this.columnWidth*e.col,e.y=this.chunkHeight*t+this.chunkMarginV*(t+1)+this.rowHeight*e.row})}setIndices(){const e=this.columnCount*this.rowCount;let o=0;Object.entries(t.groupBy(this.its,this.groupBy)).sort(e=>e[0]).forEach((t,s)=>{t[1].forEach((t,l)=>{const n=l%e;t.group=s,t.chunk=Math.floor(l/e)+o,t.row=Math.floor(n/this.columnCount),t.col=n%this.columnCount}),o+=Math.ceil(t[1].length/e)}),this.setCoords()}setFieldSize(){this.chunkWidth=this.fieldWidth/(this.chunksPerRow+this.chunkMarginRatio*(this.chunksPerRow+1)),this.chunkHeight=this.chunkWidth*this.tileAspectRatio,this.chunkMarginH=this.chunkWidth*this.chunkMarginRatio,this.chunkMarginV=this.chunkHeight*this.chunkMarginRatio,this.columnWidth=this.chunkWidth/this.columnCount,this.rowHeight=this.columnWidth*this.tileAspectRatio,this.setIndices()}itemsToRender(){return this.its.filter(e=>this.focusArea.top<e.y&&this.focusArea.left<e.x&&this.focusArea.bottom>e.y&&this.focusArea.right>e.x)}save(){return h.updateItem(this.storeID,e=>{const t=e.items.findIndex(e=>e.collectionID===this.items.collectionID);e.items[t]=this.items.export();const o=e.views.findIndex(e=>e.viewID===this.viewID);e.views[o]=this.export()})}export(){return{$schema:"https://mojaie.github.io/kiwiii/specs/tile_v1.0.json",viewID:this.viewID,name:this.name,viewType:"tile",items:this.items.collectionID,rowCount:this.rowCount,columnCount:this.columnCount,groupField:this.groupField,chunksPerRow:this.chunksPerRow,tileContent:this.tileContent,tileColor:this.tileColor,tileValue:this.tileValue,tileValueColor:this.tileValueColor,fieldTransform:this.transform}}},control:{controlBox:function(e,t){e.select("nav").remove(),e.select(".tab-content").remove(),e.call(M.controlBoxFrame,"control-frame-nav","control-frame-content");const o=e.select(".nav-tabs"),s=e.select(".tab-content");o.append("a").classed("active",!0).attr("aria-selected","true").call(M.controlBoxNav,"control-main","Main"),s.append("div").classed("show",!0).classed("active",!0).classed("control-main",!0).call(M.controlBoxItem,"control-main").call(H,t),o.append("a").call(M.controlBoxNav,"control-color","Color"),s.append("div").classed("control-color",!0).call(M.controlBoxItem,"control-color").call(M.colorControlBox,I.colorScales),o.append("a").call(M.controlBoxNav,"control-value","Value"),s.append("div").classed("control-value",!0).call(M.controlBoxItem,"control-value").call(M.labelControlBox,I.colorScales),e.call(Y,t)},updateControlBox:Y},component:{updateItems:X,updateItemAttrs:ee,tileView:function(e,t){e.call(K.view,t);const o=e.select(".field").append("g").classed("tl-items",!0);t.updateFieldNotifier=(()=>{t.setFieldSize(),o.call(X,t)}),t.updateItemNotifier=(()=>{o.call(X,t)}),t.updateItemAttrNotifier=(()=>{o.call(ee,t)}),t.updateFieldNotifier()}},interaction:{zoomListener:te,setInteraction:function t(o,s){s.zoomListener=te(o,s),o.call(s.zoomListener),s.resizeNotifier=(()=>{o.call(t,s),s.updateItemNotifier()});const l=s.transform;o.call(K.transform,l.x,l.y,l.k).call(e.zoom().transform,e.zoomIdentity.translate(l.x,l.y).scale(l.k))}}}});
//# sourceMappingURL=kw-tile.js.map
