// https://github.com/mojaie/kiwiii Version 1.0.0-alpha.2. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("pako"),require("d3"),require("Dexie"),require("vega")):"function"==typeof define&&define.amd?define(["lodash","pako","d3","Dexie","vega"],t):e.datagridApp=t(e._,e.pako,e.d3,e.Dexie,e.vega)}(this,function(e,t,s,o,n){"use strict";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,s=s&&s.hasOwnProperty("default")?s.default:s,o=o&&o.hasOwnProperty("default")?o.default:o,n=n&&n.hasOwnProperty("default")?n.default:n;var a={URLQuery:function(){const t=window.location.search.substring(1).split("&").map(e=>e.split("="));return e.fromPairs(t)},compatibility:function(){},registerServiceWorker:function(){"serviceWorker"in navigator?window.addEventListener("load",()=>{navigator.serviceWorker.register("../sw.js")}):console.info("Service worker is not supported")}};const l="../req/";function r(e,t={}){const s=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${l}${e}${s}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))}function i(e){return e.json()}var d={get:r,json:i,text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${l}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null},serverStatus:function(){const e={};return r("server").then(i).then(t=>{e.server=t}).then(()=>r("schema")).then(i).then(t=>{e.schema=t}).then(()=>e)}};function c(e,t,s){return new Promise((o,n)=>{const a=new FileReader,l=t?e.slice(0,t):e;a.onload=(e=>o(e.target.result)),a.onerror=(e=>n(e)),s?a.readAsArrayBuffer(l):a.readAsText(l)})}function p(e,s){const o=s?t.inflate(e,{to:"string"}):e;return JSON.parse(o)}function u(e,t){try{const s=window.URL.createObjectURL(new Blob([e])),o=document.createElement("a");o.download=t,o.href=s,o.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}var f={readFile:c,parseJSON:p,loadJSON:function(e){const t=e.name.endsWith("c")||e.name.endsWith(".gz");return c(e,!1,t).then(e=>p(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),s=t.endsWith("c")||t.endsWith(".gz");return fetch(t).then(e=>s?e.arrayBuffer():e.json()).then(e=>p(e,s))},downloadDataFile:u,downloadJSON:function(e,s,o=!0){const n=JSON.stringify(e);u(o?t.gzip(n):n,`${s}${`.ap${o?"c":"r"}`}`)}};var m={sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id","assay_id","list"].includes(e)?"text":"none"},formatNum:function(e,t){return null==e||Number.isNaN(e)?"":e==parseFloat(e)?s.format(t)(e):e},partialMatch:function(e,t){return null!=t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const h={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},y={datatable:"nodes",connection:"edges"};function g(e){const t=e.columns.map(e=>("numeric"===e.sort?e.format="numeric":"text"===e.sort?e.format="text":"none"===e.sort&&(e.format="raw"),e));return{id:e.id,name:e.name,dataType:y[e.format],schemaVersion:.8,revision:0,status:h[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function w(e){return{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:e.query,progress:e.progress,execTime:e.execTime,created:e.created,reference:{}}}function b(e){let t=e;return t.edges.hasOwnProperty("schemaVersion")||t.edges.hasOwnProperty("$schema")||(t.nodes=g(t.nodes),t.edges=function(e,t){const s={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(s.nodeColor.id=e.snapshot.nodeColor.id,s.nodeColor.scale=e.snapshot.nodeColor.scale,s.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):s.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(s.nodeSize.id=e.snapshot.nodeSize.id,s.nodeSize.scale=e.snapshot.nodeSize.scale,s.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):s.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(s.nodeLabel.id=e.snapshot.nodeLabel.id,s.nodeLabel.size=e.snapshot.nodeLabel.size,s.nodeLabel.text=e.snapshot.nodeLabel.text,s.nodeLabel.visible=e.snapshot.nodeLabel.visible,s.nodeLabel.scale=e.snapshot.nodeLabel.scale,s.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):s.nodeLabel={id:"label",size:12,text:"index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?s.nodeContent=e.snapshot.nodeContent:s.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?s.edge=e.snapshot.edge:s.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:y[e.format],schemaVersion:.8,revision:0,reference:{nodes:e.nodeTableId},status:h[e.status],fields:[{key:"source"},{key:"target"},{key:"weight"}],records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:s}}(t.edges,t.nodes.fields)),"0.8"!=t.edges.schemaVersion&&.1!==t.edges.schemaVersion||((t=function(e){if(e.edges.hasOwnProperty("reference")||(e.edges.reference={nodes:e.edges.nodesID}),e.nodes.fields.find(e=>"_index"===e.key)){const t={};e.nodes.records.forEach((e,s)=>{e.index=s,e.structure=e._structure,t[e._index]=e.index,delete e._index,delete e._structure}),e.edges.records.forEach(e=>{e.source=t[e.source],e.target=t[e.target]}),e.nodes.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")})}return e}(t)).nodes=w(t.nodes),t.edges=function(e){const t={networkThreshold:e.networkThreshold};return t.nodeContentVisible=e.snapshot.nodeContent.structure.visible,t.nodeColor=e.snapshot.nodeColor.scale||{},t.nodeColor.field&&(t.nodeColor.field=e.snapshot.nodeColor.field.key,"_index"===t.nodeColor.field&&(t.nodeColor.field="index")),"ordinal"===t.nodeColor.scale&&(t.nodeColor.range=s.schemeCategory20),t.nodeSize=e.snapshot.nodeSize.scale||{},e.snapshot.nodeSize.field&&(t.nodeSize.field=e.snapshot.nodeSize.field.key,"_index"===t.nodeSize.field&&(t.nodeSize.field="index")),t.nodeLabel={},e.snapshot.nodeLabel.text&&(t.nodeLabel.text=e.snapshot.nodeLabel.text.key,"_index"===t.nodeLabel.text&&(t.nodeLabel.text="index")),t.nodeLabel.size=e.snapshot.nodeLabel.size,t.nodeLabel.visible=e.snapshot.nodeLabel.visible,t.nodeLabelColor=e.snapshot.nodeLabel.scale||{},e.snapshot.nodeLabel.field&&(t.nodeLabelColor.field=e.snapshot.nodeLabel.field.key,"_index"===t.nodeLabelColor.field&&(t.nodeLabelColor.field="index")),"ordinal"===t.nodeLabelColor.scale&&(t.nodeLabelColor.range=s.schemeCategory20),t.edgeVisible=e.snapshot.edge.visible,t.edgeWidth=e.snapshot.edge.scale||{},t.edgeLabel={},t.edgeLabel.size=e.snapshot.edge.label.size,t.edgeLabel.visible=e.snapshot.edge.label.visible,t.networkThreshold=e.networkThreshold||e.query.threshold,t.coords=e.snapshot.nodePositions,{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:{params:e.query},progress:e.progress,execTime:e.execTime,created:e.created,snapshot:t,reference:e.reference}}(t.edges)),t.edges.hasOwnProperty("$schema")||(delete t.nodes.schemaVersion,delete t.edges.schemaVersion,delete t.nodes.revision,delete t.edges.revision,t.nodes.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json",t.edges.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t}var x={convertPackage:function(e){if(e.hasOwnProperty("views"))return e;const t=new Date,s=e.hasOwnProperty("edges"),o=s?b(e):function(e){let t=e;return t.hasOwnProperty("schemaVersion")||t.hasOwnProperty("$schema")||(t=g(t)),"0.8"==t.schemaVersion&&(t=w(t=function(e){return e.records.forEach((e,t)=>{e.index=t,e.structure=e._structure,delete e._index,delete e._structure}),e.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")}),e}(t))),t.hasOwnProperty("$schema")||(delete t.schemaVersion,delete t.revision,t.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t.fields.forEach(e=>{"structure"===e.key&&(e.format="svg"),delete e.width,delete e.height}),t}(e),n=s?o.nodes:o,a={$schema:"https://mojaie.github.io/kiwiii/specs/package_v1.0.json",name:o.edges.name,views:[],dataset:[]};return a.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:n.id,name:n.name,contents:[{$schema:n.$schema,workflowID:n.reference.workflow,name:n.name,fields:n.fields,records:n.records,created:n.created,status:n.status,query:n.query,execTime:n.execTime,progress:n.progress}]}),a.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:n.id,name:n.name,viewType:"datagrid",rows:n.id,fields:n.fields,sortOrder:null,filterText:null,checkpoints:[{type:"convert",date:t.toString(),description:"converted from legacy format"}]}),s&&(a.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:o.edges.id,name:o.edges.name,contents:[{$schema:o.edges.$schema,workflowID:o.edges.reference.workflow,name:o.edges.name,fields:o.edges.fields,records:o.edges.records,created:o.edges.created,status:o.edges.status,query:o.edges.query,execTime:o.edges.execTime,progress:o.edges.progress}]}),a.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:o.edges.id,name:o.edges.name,viewType:"network",nodes:n.id,edges:o.edges.id,nodeColor:o.edges.snapshot.nodeColor,nodeSize:o.edges.snapshot.nodeSize,nodeLabel:o.edges.snapshot.nodeLabel,nodeLabelColor:o.edges.snapshot.nodeLabelColor,edgeWidth:o.edges.snapshot.edgeWidth,edgeLabel:o.edges.snapshot.edgeLabel,networkThreshold:o.edges.snapshot.networkThreshold,networkThresholdCutoff:o.edges.snapshot.networkThresholdCutoff,fieldTransform:o.edges.snapshot.fieldTransform,coords:o.edges.snapshot.coords,checkpoints:[{type:"convert",date:t.toString(),description:"converted from legacy format"}]})),a.views.filter(e=>"network"===e.viewType).forEach(e=>{e.minConnThld=e.networkThresholdCutoff,e.currentConnThld=e.networkThreshold,e.hasOwnProperty("nodeLabel")&&(e.nodeLabel.field=e.nodeLabel.text),e.hasOwnProperty("edgeLabel")&&(e.edgeLabel.field="weight"),e.hasOwnProperty("edgeWidth")&&(e.edgeWidth.field="weight")}),a}};const v={items:"storeID, sessionStarted"};let k=new o("Store");function B(){return k.items.orderBy("sessionStarted").reverse().toArray()}function I(e,t){return k.items.where("storeID").equals(e).modify(t).catch(e=>{console.error("IDBError: Update failed",e)})}k.version(1).stores(v);var D={reset:function(){return k.delete().then(()=>{(k=new o("Store")).version(1).stores(v)})},getAllItems:B,getItem:function(e){return k.items.where("storeID").equals(e).first().catch(t=>{console.error(`IDBError: Unexpected table ID: ${e}`,t)})},importItem:function(e){e.hasOwnProperty("views")||(e=x.convertPackage(e));const t=new Date;return e.storeID=m.uuidv4().slice(0,8),e.sessionStarted=t.toString(),k.items.put(e)},newDatagrid:function(e){const t=(new Date).toLocaleString("en-GB",{timeZone:"Asia/Tokyo"}),s=m.uuidv4().slice(0,8),o=m.uuidv4().slice(0,8),n=e.workflowID.slice(0,8),a={$schema:"https://mojaie.github.io/kiwiii/specs/package_v1.0.json",storeID:s,name:o,views:[{$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:o,name:o,viewType:"datagrid",rows:n,checkpoints:[{type:"creation",date:t}]}],dataset:[{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:n,contents:[e]}],sessionStarted:t};return k.items.put(a).then(()=>({storeID:s,viewID:o}))},updateItem:I,deleteItem:function(e){return k.items.where("storeID").equals(e).delete()},getView:function(e,t){return B().then(t=>t.find(t=>t.storeID===e).views).then(s=>{const o=s.find(e=>e.viewID===t);if(o)return o.storeID=e,o})},appendView:function(e,t,s){return I(e,e=>{const o=e.views.findIndex(e=>e.viewID===t);e.views.splice(o+1,0,s)})},updateView:function(t,s,o){return I(t,t=>{const n=t.views.findIndex(e=>e.viewID===s);e.isFunction(o)?o(t.views[n]):t.views[n]=o})},deleteView:function(e,t){return I(e,e=>{const s=e.views.findIndex(e=>e.viewID===t);e.views.splice(s,1);const o={};e.dataset.forEach(e=>{o[e.collectionID]=0}),e.views.forEach(e=>{["rows","items","nodes","edges"].filter(t=>e.hasOwnProperty(t)).forEach(t=>{o[e[t]]+=1})}),Object.entries(o).forEach(t=>{if(!t[1]){const s=e.dataset.findIndex(e=>e.collectionID===t[0]);e.dataset.splice(s,1)}})})},getCollection:function(e,t){return B().then(t=>t.find(t=>t.storeID===e).dataset).then(s=>{const o=s.find(e=>e.collectionID===t);if(o)return o.storeID=e,o})},appendCollection:function(e,t,s){return I(e,e=>{const o=e.dataset.findIndex(e=>e.collectionID===t);e.dataset.splice(o+1,0,s)})},updateCollection:function(t,s,o){return I(t,t=>{const n=t.dataset.findIndex(e=>e.collectionID===s);e.isFunction(o)?o(t.dataset[n]):t.dataset[n]=o})}};const C="../assets/icon/";var T={iconBaseURL:C,buttonBox:function(e,t,s){e.classed("form-group",!0).classed("mb-1",!0).append("button").classed("btn",!0).classed(`btn-${s}`,!0).classed("btn-sm",!0).text(t)},menuButton:function(e,t,s){e.classed("btn",!0).classed(`btn-${s}`,!0).classed("btn-sm",!0).classed("mr-1",!0).text(t)},menuButtonLink:function(e,t,s,o){e.classed("btn",!0).classed(`btn-${s}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("href","#"),e.append("img").attr("src",o?`${C}${o}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").style("vertical-align","middle").text(t)},menuModalLink:function(e,t,s,o,n){e.classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("href","#").attr("role","button").attr("data-toggle","modal").attr("data-target",`#${t}`),e.append("img").attr("src",n?`${C}${n}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").classed("label",!0).style("vertical-align","middle").text(s)},dropdownMenuButton:function(e,t,s,o){e.classed("btn-group",!0).classed("mr-1",!0);const n=e.append("button").classed("btn",!0).classed(`btn-${s}`,!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown");n.append("img").attr("src",o?`${C}${o}.svg`:null).style("width","1.25rem").style("height","1.25rem"),n.append("span").style("vertical-align","middle").text(t),e.append("div").classed("dropdown-menu",!0)},dropdownMenuItem:function(e,t,s){e.classed("dropdown-item",!0).attr("href","#"),e.append("img").attr("src",s?`${C}${s}.svg`:null).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuModal:function(e,t,s,o){e.classed("dropdown-item",!0).attr("href","#").attr("data-toggle","modal").attr("data-target",`#${s}`),e.append("img").attr("src",`${C}${o}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuFile:function(e,t,o,n){e.classed("dropdown-item",!0).attr("href","#").on("click",function(){s.select(this).select("input").node().click()}),e.append("form").style("display","none").append("input").attr("type","file").attr("accept",o),e.append("img").attr("src",`${C}${n}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuFileValue:function(e){return e.select("input").node().files[0]}};function _(e,t){e.classed("modal",!0).attr("tabindex",-1).attr("role","dialog").attr("aria-labelledby","").attr("aria-hidden",!0).attr("id",t),e.append("div").classed("modal-dialog",!0).attr("role","document").append("div").classed("modal-content",!0)}var S={confirmDialog:function(e,t){const o=e.call(_,t).select(".modal-content");o.append("div").classed("modal-body",!0).append("div").classed("message",!0);const n=o.append("div").classed("modal-footer",!0);n.append("button").classed("btn",!0).classed("btn-outline-secondary",!0).classed("cancel",!0).attr("type","button").attr("data-dismiss","modal").text("Cancel"),n.append("button").classed("btn",!0).classed("btn-warning",!0).classed("ok",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${t}-submit`).text("OK").on("click",()=>{s.select("#loading-icon").style("display","inline"),e.dispatch("submit")})},updateConfirmDialog:function(e,t){e.select(".message").text(t)},submitDialog:function(e,t,o){const n=e.call(_,t).select(".modal-content"),a=n.append("div").classed("modal-header",!0);a.append("h4").classed("modal-title",!0).text(o),a.append("button").attr("type","button").attr("data-dismiss","modal").attr("aria-label","Close").classed("close",!0).append("span").attr("aria-hidden",!0).html("&times;"),n.append("div").classed("modal-body",!0),n.append("div").classed("modal-footer",!0).append("button").classed("btn",!0).classed("btn-primary",!0).classed("submit",!0).attr("type","button").attr("data-dismiss","modal").attr("data-target",`${t}-submit`).text("Submit").on("click",()=>{s.select("#loading-icon").style("display","inline"),e.dispatch("submit")})}};function L(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}var O={singleToMulti:L,mappingToTable:function(e){const t=e.hasOwnProperty("field")?L(e):e;return{fields:[{key:t.key,format:"text"}].concat(t.fields),records:Object.entries(t.mapping).map(e=>{const s={};return s[t.key]=e[0],t.fields.forEach((t,o)=>{s[t.key]=e[1][o]}),s})}},tableToMapping:function(e,t,s=["index"]){const o={created:(new Date).toString(),fields:e.fields.filter(e=>e.key!==t).filter(e=>!s.includes(e.key)),key:t,mapping:{}};return e.records.forEach(e=>{o.mapping[e[t]]=o.fields.map(t=>e[t.key])}),o},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),s=t.shift().split(","),o=s.shift(),n=new Date,a=[],l=[];s.forEach((e,t)=>{""!==e&&(a.push(t),l.push({key:e,format:"text"}))});const r={created:n.toString(),fields:l,key:o,mapping:{}};return t.forEach(e=>{const t=e.split(","),s=t.shift();r.mapping[s]=Array(a.length),a.forEach(e=>{r.mapping[s][e]=t[e]})}),r},apply:function(t,s){const o=s.hasOwnProperty("field")?L(s):s;t.records.filter(e=>o.mapping.hasOwnProperty(e[o.key])).forEach(e=>{o.fields.forEach((t,s)=>{e[t.key]=o.mapping[e[o.key]][s]})}),t.fields=e(t.fields).concat(o.fields).uniqBy("key").value()}};class V{constructor(e){this.autoIndex="index",this.collectionID=e.collectionID||null,this.storeID=e.storeID||null,this.name=e.name||null,this.contents=e.contents||[e],this.fields=[],this.contents.forEach(e=>{e.fields.forEach(e=>this.addField(e))})}addField(e){this.fields.find(t=>t.key===e.key)||(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),this.fields.push(e))}updateFields(e){this.fields=[],e.forEach(e=>this.addField(e))}joinFields(e){this.contents.forEach(t=>{O.apply(t,e)}),e.hasOwnProperty("fields")?e.fields.forEach(e=>this.addField(e)):this.addField(e.field)}records(){return e.flatten(this.contents.map(e=>e.records))}fetch(e){const t=this.contents.filter(e=>["running","ready","interrupted","queued"].includes(e.status)).map(t=>{const s={id:t.workflowID,command:e};return d.get("progress",s).then(d.json).then(e=>D.updateCollection(this.storeID,this.collectionID,t=>{const o=t.contents.findIndex(e=>e.workflowID===s.id);"failure"===e.status?t.contents[o].status="failure":t.contents[o]=e}))});return Promise.all(t).then(()=>D.getCollection(this.storeID,this.collectionID)).then(e=>{this.contents=e.contents})}pull(){return this.fetch("pull")}abort(){return this.fetch("abort")}size(){return e.sum(this.contents.map(e=>e.records.length))}status(){return this.contents.some(e=>"interrupted"===e.status)?"interrupted":this.contents.some(e=>"running"===e.status)?"running":this.contents.some(e=>"queued"===e.status)?"queued":this.contents.some(e=>"ready"===e.status)?"ready":this.contents.some(e=>"aborted"===e.status)?"aborted":this.contents.some(e=>"failure"===e.status)?"failure":"done"}ongoing(){return["ready","queued","running","interrupted"].includes(this.status())}progress(){return e.min(this.contents.map(e=>e.progress))}execTime(){return e.sum(this.contents.map(e=>e.execTime))}export(){return{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:this.collectionID,name:this.name,fields:this.fields,contents:this.contents}}}function F(e,t){const s=e.select(".dg-header");s.selectAll(".dg-hcell").remove(),s.selectAll(".dg-hcell").data(t.visibleFields).enter().append("div").classed("dg-hcell",!0).call(t.headerCellRenderer)}function j(e,t){const o=e.select(".dg-body").selectAll(".dg-row").data(t.recordsToShow(),t.keyFunc);o.exit().remove(),o.selectAll(".dg-cell").remove(),o.enter().append("div").attr("class","dg-row").style("position","absolute").style("width","100%").merge(o).style("height",`${t.rowHeight}px`).each(function(e,o){const n=t.viewportTop+o,a=n*t.rowHeight;s.select(this).style("transform",`translate(0px, ${a}px)`).classed("odd",n%2==0).call(t.rowFactory(),e)})}function P(e,t,s){e.select(".dg-body").style("height",`${t.bodyHeight}px`),t.setScrollPosition(s),e.call(j,t,s),e.select(".dg-viewport").node().scrollTop=s*t.rowHeight}function R(e,t){const s=e.select(".dg-viewport"),o=s.node().getBoundingClientRect().top;t.resizeViewport(window.innerHeight-o-5),s.style("height",`${t.viewportHeight}px`)}var M={headerCellRenderer:function(e){e.style("display","inline-block").style("width",e=>`${e.width}%`).text(e=>e.name)},updateHeader:F,updateRows:j,updateViewport:P,resize:R,datagrid:function(e,t){e.append("div").classed("dg-header",!0),e.append("div").classed("dg-viewport",!0).style("overflow-y","auto").on("scroll",function(){const s=Math.floor(this.scrollTop/t.rowHeight);s!==t.previousViewportTop&&(t.setScrollPosition(s),e.call(j,t,s))}).append("div").classed("dg-body",!0).style("position","relative"),t.updateContentsNotifier=(()=>{t.applyHeader(),e.call(F,t),e.call(R,t),t.applyData(),e.call(P,t,t.viewportTop)}),t.updateFilterNotifier=(s=>{t.setFilterText(s),e.call(P,t,0)}),t.updateContentsNotifier()}};var z={plotCell:function(e,t,s){new n.View(n.parse(t[s.key])).initialize(e.node()).run()},plotThumbnail:function(e){return new n.View(n.parse(e)).toImageURL("png")},binaryToDataURI:function(e){return new Promise(t=>{const s=new FileReader;s.onload=(e=>{t(e.target.result)}),s.readAsDataURL(e)})}};function N(e,t,s){e.text(m.formatNum(t[s.key],s.d3_format))}function q(e,t,s){e.text(t[s.key])}function E(e,t,s){e.html(t[s.key])}function A(e,t,s){e.append("a").attr("href",`profile.html?compound=${t[s.key]}`).attr("target","_blank").text(t[s.key])}function H(e,t,s){e.append("img").attr("width",180).attr("height",180).attr("src",t[s.key])}function G(e,t,s){e.append("input").attr("type","checkbox").property("checked",t[s.key]).property("disabled",!!s.disabled&&t[s.disabled]).on("click",function(){t[s.key]=this.checked})}function U(e,t,s){e.append("input").attr("type","text").style("width","90%").property("value",t[s.key]).on("change",function(){t[s.key]=this.value})}function J(e,t){e.call(t)}const W={numeric:q,text:q,date:function(e,t,s){e.text(t[s.key])},raw:q,d3_format:N,compound_id:A,assay_id:q,list:q,plot:z.plotCell,image:H,checkbox:G,text_field:U,control:J,svg:E,html:E};function Q(e){e.classed("dg-cell",!0).classed("align-middle",!0).classed("text-truncate",!0).style("display","inline-block")}var K={d3Format:N,text:q,html:E,compound_id:A,image:H,checkbox:G,textField:U,call:J,rowCell:Q,rowFactory:function(e){return(t,s)=>{e.forEach(e=>{const o=t.append("div").call(Q).style("width",`${e.width}%`);s.hasOwnProperty(e.key)&&o.call(W[e.format],s,e)})}}};class Z{constructor(e,t){this.storeID=e.storeID||null,this.viewID=e.viewID||null,this.name=e.name||null,this.sortOrder=e.sortOrder||[],this.filterText=e.filterText||null,this.rows=new V(t),this.visibleFields=null,this.sortedRecords=null,this.filteredRecords=null,this.defaultColumnHeight={numeric:40,text:40,none:200},this.scrollBarSpace=20,this.keyFunc=(e=>e.index),this.rowHeight=null,this.bodyHeight=null,this.viewportHeight=null,this.numViewportRows=null,this.viewportTop=0,this.previousViewportTop=null,this.viewportBottom=null,this.fixedViewportHeight=null,this.updateContentsNotifier=null,this.updateFilterNotifier=null,this.headerCellRenderer=M.headerCellRenderer,this.rowFactory=(()=>K.rowFactory(this.visibleFields))}setViewportSize(e){this.viewportHeight=this.fixedViewportHeight||e}setScrollPosition(e){this.previousViewportTop=this.viewportTop,this.viewportTop=e,this.viewportBottom=Math.min(this.viewportTop+this.numViewportRows,this.filteredRecords.length)}setNumViewportRows(){this.numViewportRows=Math.ceil(this.viewportHeight/this.rowHeight)+1}resizeViewport(e){this.setViewportSize(e),this.setNumViewportRows()}applyHeader(){this.visibleFields=this.rows.fields.filter(e=>e.visible);const e=this.visibleFields.reduce((e,t)=>e+(t.widthf||1),0);this.visibleFields=this.visibleFields.map(t=>{const s={width:(t.widthf||1)/e*100,height:t.height||this.defaultColumnHeight[m.sortType(t.format)]};return Object.assign(s,t)}),this.rowHeight=this.visibleFields.reduce((e,t)=>e.height>t.height?e:t,0).height}applyData(){this.setNumViewportRows(),this.applyOrder()}applyOrder(t,s){if(t)this.sortedRecords=e.orderBy(this.rows.records().slice(),[t],[s]);else{const t=this.sortOrder.map(e=>e.key),s=this.sortOrder.map(e=>e.order);t&&(this.sortedRecords=e.orderBy(this.rows.records().slice(),t,s))}this.applyFilter()}applyFilter(){if(null===this.filterText)this.filteredRecords=this.sortedRecords.slice();else{const e=this.visibleFields.filter(e=>"none"!==m.sortType(e.format)).map(e=>e.key);this.filteredRecords=this.sortedRecords.filter(t=>e.some(e=>m.partialMatch(this.filterText,t[e])))}this.bodyHeight=this.filteredRecords.length*this.rowHeight}setSortOrder(e,t){const s=this.sortOrder.findIndex(e=>e.key),o={key:e,order:t};-1!==s&&this.sortOrder.splice(s,1),this.sortOrder.splice(0,0,o),this.applyOrder(e,t)}setFilterText(e){this.filterText=e,this.applyFilter()}updateFields(e){this.rows.updateFields(e)}joinFields(e){this.rows.joinFields(e),this.applyData()}recordsToShow(){return this.filteredRecords.slice(this.viewportTop,this.viewportBottom)}save(){return D.updateItem(this.storeID,e=>{const t=e.dataset.findIndex(e=>e.collectionID===this.rows.collectionID);e.dataset[t]=this.rows.export();const s=e.views.findIndex(e=>e.viewID===this.viewID);e.views[s]=this.export()})}export(){return{$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:this.viewID,name:this.name,viewType:"datagrid",rows:this.rows.collectionID,sortOrder:this.sortOrder,filterText:this.filterText}}}function X(e){return parseFloat(e.select("input").property("value"))}var Y={textBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","text")},updateTextBox:function(e,t){e.select("input").property("value",t)},textBoxValue:function(e){return e.select("input").property("value")},readonlyBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control-plaintext",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","text").property("readonly",!0)},textareaBox:function(e,t,s){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("textarea").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("rows",s)},updateTextareaBox:function(e,t){e.select("textarea").property("value",t)},updateTextareaPlaceholder:function(e,t){e.select("textarea").attr("placeholder",t)},textareaBoxValue:function(e){const t=e.select("textarea").property("value");if(t)return t;const s=e.select("textarea").attr("placeholder");return s||""},textareaBoxLines:function(e){const t=e.select("textarea").property("value");if(t)return t.split("\n").filter(e=>e.length>0);const s=e.select("textarea").attr("placeholder");return s?s.split("\n").filter(e=>e.length>0):[]},checkBox:function(e,t){const s=e.classed("form-group",!0).classed("form-row",!0).classed("form-check",!0).append("label").classed("form-check-label",!0).classed("col-form-label-sm",!0);s.append("input").classed("form-check-input",!0).attr("type","checkbox"),s.append("span").text(t)},updateCheckBox:function(e,t){e.select("input").property("checked",t)},checkBoxValue:function(e){return e.select("input").property("checked")},numberBox:function(e,t,s,o,n){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","number").attr("min",s).attr("max",o).attr("step",n)},updateNumberBox:function(e,t){e.select("input").property("value",t)},numberFloatValid:function(e){const t=X(e),s=parseInt(e.select("input").attr("min")),o=parseInt(e.select("input").attr("max")),n=!isNaN(t)&&t>=s&&t<=o;return e.select("input").style("background-color",n?"#ffffff":"#ffcccc"),n},numberBoxIntValue:function(e){return parseInt(e.select("input").property("value"))},numberBoxFloatValue:X,colorBox:function(e,t){e.classed("form-row",!0).classed("align-items-center",!0).on("change",()=>{s.event.stopPropagation()}),e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).text(t),e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).append("input").classed("form-control",!0).classed("form-control-sm",!0).attr("type","color")},updateColorBox:function(e,t){e.select("input").property("value",t)},colorBoxValue:function(e){return e.select("input").property("value")},fileInputBox:function(e,t,s){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",s)},clearFileInput:function(e){const t=e.select("input").attr();e.select("input").remove(),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",t)},fileInputBoxValue:function(e){return e.select("input").property("files")[0]}};var ee={setFilter:function(e,t){const s=e.classed("row",!0).classed("justify-content-end",!0).append("div").classed("col-5",!0).call(Y.textBox,"Search");s.select("label").classed("text-right",!0),s.select("input").on("keyup",function(){t.updateFilterNotifier(Y.textBoxValue(s))})}};var te={setSort:function(e,t){t.headerCellRenderer=(o=>{o.style("display","inline-block").style("width",e=>`${e.width}%`).text(e=>e.name).filter(e=>"none"!==m.sortType(e.format)).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",o=>{const n="v"===s.select(`#sort-${o.key}`).text();s.select(`#sort-${o.key}`).text(n?"^":"v"),t.setSortOrder(o.key,n?"desc":"asc"),e.call(M.updateRows,t)})})}};var se={table:function(e,t,s,o,n){const a=new Z({},{fields:t,records:s});a.keyFunc=(e=>e),o&&(a.rowFactory=(()=>o(a.visibleFields))),a.fixedViewportHeight=n||300,e.append("div").classed("table",!0).call(M.datagrid,a),e.datum(a)},filterTable:function(e,t,s,o,n){const a=new Z({},{fields:t,records:s});o&&(a.rowFactory=(()=>o(a.visibleFields))),a.fixedViewportHeight=n||300,e.append("div").classed("search",!0).call(ee.setFilter,a),e.append("div").classed("table",!0).call(M.datagrid,a),e.datum(a)},filterSortTable:function(e,t,s,o,n){const a=new Z({},{fields:t,records:s});o&&(a.rowFactory=(()=>o(a.visibleFields))),a.fixedViewportHeight=n||300,e.append("div").classed("search",!0).call(ee.setFilter,a),e.append("div").classed("table",!0).call(te.setSort,a).call(M.datagrid,a),e.datum(a)},update:function(e,t,s){const o={fields:t,records:s},n=e.datum();n.rows=new V(o),n.updateContentsNotifier()},updateRecords:function(e,t){const s=e.datum();s.rows.contents[0].records=t,s.updateContentsNotifier()},tableRecords:function(e){return e.datum().rows.records()}};const oe="fieldconf-dialog",ne="Column setting";function ae(e){return(t,s)=>{t.append("div").call(K.rowCell).style("width",`${e[0].width}%`).text(s.name),t.append("div").call(K.rowCell).style("width",`${e[1].width}%`).append("input").attr("type","checkbox").property("checked",s.visible).on("click",function(){s.visible=this.checked});const o=t.append("div").call(K.rowCell).style("width",`${e[2].width}%`).append("select"),n=!e[2].options.includes(s.format);o.selectAll("option").data(n?[s.format]:e[2].options).enter().append("option").attr("value",e=>e).text(e=>e),o.property("value",s.format).property("disabled",n).on("change",function(){s.format=this.value,t.select(".d3f input").property("disabled","d3_format"!==s.format)}),t.append("div").call(K.rowCell).classed("d3f",!0).style("width",`${e[3].width}%`).append("input").attr("type","text").style("width","90%").property("value",s.d3_format).property("disabled","d3_format"!==s.format).on("change",function(){s.d3_format=this.value})}}var le={menuLink:function(e){e.call(T.dropdownMenuModal,ne,oe,"menu-edittable")},body:function(e){const t=e.call(S.submitDialog,oe,ne);t.select(".modal-dialog").classed("modal-lg",!0),t.select(".modal-body").append("div").classed("dgfields",!0).call(se.table,[{key:"name",name:"Name",format:"text"},{key:"visible",name:"Visible",format:"checkbox",widthf:.5,height:40},{key:"format",name:"Format",format:"select",options:["text","numeric","d3_format","raw","compound_id"],height:40},{key:"d3_format",name:"D3 format",format:"text_field",height:40}],[],ae,300)},updateBody:function(e,t){e.select(".dgfields").call(se.updateRecords,t)},value:function(e){return se.tableRecords(e.select(".dgfields"))}};const re="fieldfetch-dialog",ie="Append assays";var de={menuLink:function(e){e.call(T.dropdownMenuModal,ie,re,"menu-addassay")},body:function(e){const t=e.call(S.submitDialog,re,ie);t.select(".modal-dialog").classed("modal-lg",!0),t.select(".modal-body").append("div").classed("assays",!0).call(se.filterTable,[{key:"check",name:"Check",format:"checkbox",widthf:.5,height:40,disabled:"check_d"},{key:"assay_id",name:"Assay ID",format:"assay_id"},{key:"name",name:"Name",format:"text"},{key:"value_type",name:"Value type",format:"text"},{key:"tags",name:"Tags",format:"list",widthf:2}],[])},updateBody:function(t,o,n){const a=e.flatten(o.resources.filter(e=>"assay"===e.domain).map(e=>e.data)),l=e.flatMap(a,e=>e.value_types.map(t=>{const s=Object.assign({},e);return s.value_type=t.key,delete s.value_types,s})),r={};n.filter(e=>e.hasOwnProperty("__origin")).map(e=>e.__origin).forEach(e=>{r.hasOwnProperty(e.assay_id)||(r[e.assay_id]=[]),r[e.assay_id].push(e.value_type)});const i=l.map(e=>{const t=r.hasOwnProperty(e.assay_id)&&r[e.assay_id].includes(e.value_type);return e.check=t,e.check_d=t,e});t.select(".assays").call(se.updateRecords,i).on("change",function(){const e=se.tableRecords(s.select(this)).filter(e=>e.check&&!e.check_d).length;t.select(".submit").property("disabled",!e)}).dispatch("change")},execute:function(e,t,s){const o=s.resources.filter(e=>"activity"===e.domain).map(e=>e.id),n=se.tableRecords(e.select(".assays")).filter(e=>e.check&&!e.check_d).map(e=>({workflow:"activity",targets:o,assay_id:e.assay_id,condition:{compounds:t,value_types:[e.value_type]}})).map(e=>d.get(e.workflow,e).then(d.json));return Promise.all(n).then(e=>{const t=e.shift();return e.forEach(e=>{const s=O.tableToMapping(e,"compound_id",["index","assay_id"]);O.apply(t,s)}),O.tableToMapping(t,"compound_id",["index","assay_id"])})}};function ce(e,t,s){e.attr("viewBox","0 0 100 10").attr("preserveAspectRatio","none");const o=e.append("g");o.append("rect").attr("x",0).attr("y",0).attr("width",100).attr("height",10).attr("fill",t[0]),o.append("text").attr("text-anchor","middle").attr("x",50).attr("y",10).attr("font-size",12).text(s)}var pe={colorBar:{monocolor:ce,bicolor:function(e,t,s){const o=m.uuidv4().slice(0,8);e.call(ce,t,s);const n=e.append("defs").append("linearGradient").attr("id",o);n.append("stop").attr("offset",0).attr("stop-color",t[0]),n.append("stop").attr("offset",1).attr("stop-color",t[1]),e.select("rect").attr("fill",`url(#${o})`)},tricolor:function(e,t,s){const o=m.uuidv4().slice(0,8);e.call(ce,t,s);const n=e.append("defs").append("linearGradient").attr("id",o);n.append("stop").attr("offset",0).attr("stop-color",t[0]),n.append("stop").attr("offset",.5).attr("stop-color",t[1]),n.append("stop").attr("offset",1).attr("stop-color",t[2]),e.select("rect").attr("fill",`url(#${o})`)},categorical:function(e,t,s){e.attr("viewBox","0 0 100 10").attr("preserveAspectRatio","none");const o=100/t.length,n=e.append("g");t.forEach((e,s)=>{n.append("rect").attr("x",o*s).attr("y",0).attr("width",o).attr("height",20).attr("fill",t[s])}),n.append("text").attr("text-anchor","middle").attr("x",50).attr("y",20).attr("font-size",20).text(s)},custom:ce},setSize:function(e,t,s){e.attr("width",t).attr("height",s)}};function ue(e){return e.selectAll("input:checked").data().map(e=>e.key)}function fe(e,t){const s=e.select(".selected");s.selectAll("svg").remove(),s.datum(t),s.append("svg").call(pe.colorBar[t.type],t.colors,t.text).call(pe.setSize,100,10)}var me={selectBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("select").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0)},selectBoxItems:function(e,t){const s=e.select("select").selectAll("option").data(t,e=>e.key);s.exit().remove(),s.enter().append("option").attr("value",e=>e.key).text(e=>e.name)},updateSelectBox:function(e,t){e.select("select").property("value",t)},selectBoxValue:function(e){return e.select("select").property("value")},checklistBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("ul").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0)},checklistBoxItems:function(e,t){const s=e.select("ul").selectAll("li").data(t,e=>e.key);s.exit().remove();const o=s.enter().append("li").attr("class","form-check").append("label").attr("class","form-check-label");o.append("input").attr("type","checkbox").attr("class","form-check-input").property("value",e=>e.key),o.append("span").text(e=>e.name)},updateChecklistBox:function(e,t){t&&e.selectAll("input").each(function(e){s.select(this).property("checked",t.includes(e.key))})},checklistBoxValue:ue,anyChecked:function(e){return ue(e).length>0},colorScaleBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t||"Colorscale");const s=e.append("div").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0),o=s.append("div").classed("btn-group",!0).classed("mr-1",!0);o.append("button").classed("btn",!0).classed("btn-light",!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown"),o.append("div").classed("dropdown-menu",!0).classed("py-0",!0),s.append("span").classed("selected",!0)},colorScaleBoxItems:function(e,t){const o=e.select(".dropdown-menu").selectAll("a").data(t,e=>e);o.exit().remove(),o.enter().append("a").classed("dropdown-item",!0).classed("py-0",!0).attr("href","#").attr("title",e=>e.key).on("click",function(t){e.call(fe,t),e.dispatch("change",{bubbles:!0})}).append("svg").each(function(e){s.select(this).call(pe.colorBar[e.type],e.colors,e.text).call(pe.setSize,100,10)})},updateColorScaleBox:function(e,t){const s=e.select(".dropdown-menu").selectAll("a").data().find(e=>e.key===t);e.call(fe,s)},colorScaleBoxValue:function(e){return e.select(".selected").datum().key},colorScaleBoxItem:function(e){return e.select(".selected").datum()}};const he="fieldfile-dialog",ye="Append JSON fields";var ge={menuLink:function(e){e.call(T.dropdownMenuModal,ye,he,"menu-addfile")},body:function(e){const t=e.call(S.submitDialog,he,ye).select(".modal-body");t.append("div").classed("file",!0).call(Y.fileInputBox,"File",".json,.csv"),t.append("div").classed("left",!0).call(me.selectBox,"Datagrid ID"),t.append("div").classed("right",!0).call(me.selectBox,"File ID").select("select").property("disabled",!0),t.append("h5").classed("mt-2",!0).text("Preview"),t.append("div").classed("preview",!0).call(se.table,[],[],null,210)},updateBody:function(e,t){const o=t.filter(e=>"none"!==m.sortType(e.format)),n=o.find(e=>"compound_id"===e.format)||o[0];e.select(".left").call(me.selectBoxItems,o).call(me.updateSelectBox,n.key),e.select(".preview").call(se.update,[],[]),e.select(".file").call(Y.clearFileInput).on("change",function(){const t=Y.fileInputBoxValue(s.select(this));s.select(this).dispatch("validate");const o="csv"===t.name.split(".").pop();f.readFile(t).then(t=>{const s=o?O.csvToMapping(t):JSON.parse(t),n=O.mappingToTable(s);e.select(".right").call(me.selectBoxItems,[{key:s.key,name:s.key}]).call(me.updateSelectBox,s.key),e.select(".preview").call(se.update,n.fields,n.records.slice(0,5))})}).on("validate",function(){const t=Y.fileInputBoxValue(s.select(this));e.select(".submit").property("disabled",!t)}).dispatch("validate")},readFile:function(e){const t=me.selectBoxValue(e.select(".left")),s=Y.fileInputBoxValue(e.select(".file")),o="csv"===s.name.split(".").pop();return f.readFile(s).then(e=>{let s=o?O.csvToMapping(e):JSON.parse(e);s.hasOwnProperty("field")&&(s=O.singleToMulti(s)),s.key=t;const n=[];if(s.fields.forEach((e,t)=>{"plot"===e.format&&(s.fields[t].format="image",n.push(t))}),n.length>0){const e=[];return Object.entries(s.mapping).forEach(t=>{n.forEach(o=>{const n=z.plotThumbnail(t[1][o]).then(e=>{s.mapping[t[0]][o]=e});e.push(n)})}),Promise.all(e).then(()=>s)}return s})}};const we="fieldinput-dialog",be="Append input field";const xe={checkbox:!1,text_field:""};var ve={menuLink:function(e){e.call(T.dropdownMenuModal,be,we,"menu-addcheckbox")},body:function(e){const t=e.call(S.submitDialog,we,be).select(".modal-body");t.append("div").classed("key",!0).call(Y.textBox,"Field key"),t.append("div").classed("type",!0).call(me.selectBox,"Type").call(me.selectBoxItems,[{key:"checkbox",name:"Checkbox"},{key:"text_field",name:"Text field"}])},updateBody:function(e){e.select(".key").call(Y.updateTextBox,null).on("input",function(){const t=""!==Y.textBoxValue(s.select(this));e.select(".submit").property("disabled",!t)}).dispatch("input"),e.select(".type").call(me.updateSelectBox,"checkbox")},value:function(e){const t=Y.textBoxValue(e.select(".key")),s=me.selectBoxValue(e.select(".type"));return{field:{key:t,name:t,format:s},default:xe[s]}}};function ke(e){const t=me.selectBoxValue(e.select(".format")),s=me.selectBoxValue(e.select(".source")),o=Y.textBoxValue(e.select(".textquery")),n=Y.textareaBoxLines(e.select(".areaquery"));return{format:t,source:"dbid"===t?s:null,value:"molfile"===t?n:o}}var Be={queryMolGroup:function(e){e.classed("mb-3",!0),e.append("div").classed("format",!0).classed("mb-1",!0).call(me.selectBox,"Format").call(me.selectBoxItems,[{key:"molfile",name:"MDL Molfile"},{key:"dbid",name:"Compound ID"}]),e.append("div").classed("source",!0).classed("mb-1",!0).call(me.selectBox,"Source"),e.append("div").classed("textquery",!0).classed("mb-1",!0).call(Y.textBox,"Query"),e.append("div").classed("areaquery",!0).classed("mb-1",!0).call(Y.textareaBox,"Query",6,null),$(function(){$('[data-toggle="popover"]').popover({html:!0,trigger:"focus"})}),e.append("div").classed("form-row",!0).classed("justify-content-end",!0).append("button").classed("preview",!0).attr("data-toggle","popover").attr("data-html","true").attr("data-content",'<div id="previmg"></div>').call(T.menuButton,"Structure preview","primary")},updateQueryMolGroup:function(e,t){e.select(".format").call(me.updateSelectBox,"molfile").on("change",function(){const t=me.selectBoxValue(s.select(this));e.select(".source").select("select").property("disabled","dbid"!==t),e.select(".textquery").property("hidden","dbid"!==t),e.select(".areaquery").property("hidden","molfile"!==t)}).dispatch("change");const o=t.map(e=>({key:e.id,name:e.name}));e.select(".source").call(me.selectBoxItems,o).call(me.updateSelectBox,null),e.select(".preview").on("click",function(){const t=ke(e);return d.get("strprev",t).then(d.text).then(e=>s.select("#previmg").html(e),d.error)}),e.select(".textquery").call(Y.updateTextBox,"").on("input",function(){e.dispatch("validate")}),e.select(".areaquery").call(Y.updateTextareaBox,"").on("input",function(){e.dispatch("validate")})},queryMolGroupValue:ke,queryMolGroupValid:function(e){const t=me.selectBoxValue(e.select(".format")),s=Y.textBoxValue(e.select(".textquery")),o=Y.textareaBoxLines(e.select(".areaquery"));return"molfile"===t?o.length:""!==s},simOptionGroup:function(e){const t=m.uuidv4().slice(0,8);e.classed("mb-3",!0).append("p").append("button").classed("btn",!0).classed("btn-sm",!0).classed("btn-outline-primary",!0).classed("dropdown-toggle",!0).attr("data-toggle","collapse").attr("data-target",`#${t}-collapse`).attr("aria-expanded","false").attr("aria-controls",`${t}-collapse`).text("Optional parameters");const s=e.append("div").classed("collapse",!0).attr("id",`${t}-collapse`).append("div").classed("card",!0).classed("card-body",!0);s.append("div").classed("ignoreh",!0).classed("mb-1",!0).call(Y.checkBox,"Ignore explicit hydrogens"),s.append("div").classed("timeout",!0).classed("mb-1",!0).call(Y.numberBox,"Timeout",1,999,1),s.append("div").classed("diam",!0).classed("mb-1",!0).call(Y.numberBox,"Diameter (MCS-DR/GLS)",4,999,1),s.selectAll("label.col-form-label").classed("col-4",!1).classed("col-6",!0),s.selectAll("input.form-control").classed("col-8",!1).classed("col-6",!0)},updateSimOptionGroup:function(e){e.select(".ignoreh").call(Y.updateCheckBox,!0),e.select(".timeout").call(Y.updateNumberBox,2),e.select(".diam").call(Y.updateNumberBox,8)},simOptionGroupValue:function(e){const t=e.select(".timeout"),s=e.select(".diam"),o={ignoreHs:Y.checkBoxValue(e.select(".ignoreh"))};return t.select("input").property("disabled")||(o.timeout=Y.numberBoxIntValue(t)),s.select("input").property("disabled")||(o.diameter=Y.numberBoxIntValue(s)),o}};const Ie="networkgen-dialog",De="Generate similarity network";var Ce={menuLink:function(e){e.call(T.dropdownMenuModal,De,Ie,"menu-network")},body:function(e){const t=e.call(S.submitDialog,Ie,De);t.select(".modal-body").append("div").classed("measure",!0).call(me.selectBox,"Measure"),t.select(".modal-body").append("div").classed("thld",!0).call(Y.numberBox,"Threshold",.5,1,.01),t.select(".modal-body").append("div").classed("option",!0).call(Be.simOptionGroup)},updateBody:function(e,t){const o=[{key:"gls",name:"Graph-based local similarity(GLS)"}];t&&(o.push({key:"rdmorgan",name:"RDKit Morgan similarity"}),o.push({key:"rdfmcs",name:"RDKit FMCS"})),e.select(".measure").call(me.selectBoxItems,o).call(me.updateSelectBox,"gls").on("change",function(){const t=me.selectBoxValue(s.select(this));e.select(".diam").select("input").property("disabled","gls"!==t),e.select(".timeout").select("input").property("disabled",!["gls","rdfmcs"].includes(t))}),e.select(".thld").call(Y.updateNumberBox,.5),e.select(".option").call(Be.updateSimOptionGroup)},execute:function(e,t){const s=e.select(".measure"),o=e.select(".thld"),n=Be.simOptionGroupValue(e.select(".option"));s.select("select").property("disabled")||(n.measure=me.selectBoxValue(s)),o.select("input").property("disabled")||(n.threshold=Y.numberBoxFloatValue(o));const a=new FormData;return a.append("params",JSON.stringify(n)),a.append("contents",new Blob([JSON.stringify(t)])),d.post(`${n.measure}net`,a).then(d.json)}};const Te="rename-dialog",_e="Rename";var Se={menuLink:function(e){e.call(T.dropdownMenuModal,_e,Te,"menu-edittext")},body:function(e){e.call(S.submitDialog,Te,_e).select(".modal-body").append("div").classed("rename",!0).call(Y.textBox,"New name")},updateBody:function(e,t){e.select(".rename").call(Y.updateTextBox,t).on("input",function(){const t=""!==Y.textBoxValue(s.select(this));e.select(".submit").property("disabled",!t)}).dispatch("input")},value:function(e){return Y.textBoxValue(e.select(".rename"))}};function $e(e){s.select("#loading-icon").style("display","none"),s.select("title").text(e.name);const t=s.select("#menubar"),o=e.rows.status(),n=e.rows.size(),a=e.rows.execTime(),l=e.rows.progress(),r=e.rows.ongoing();t.select(".title").text(e.name),t.select(".status").text(`(${o} - ${n} records found in ${a} sec.)`),t.select(".progress").select("progress").attr("value",l).text(`${l}%`),t.selectAll(".progress, .refresh, .abort").style("display",r?null:"none");const i=s.select("#dialogs");i.select(".fieldconfd").call(le.updateBody,e.rows.fields).on("submit",function(){const t=le.value(s.select(this));e.updateFields(t),e.updateContentsNotifier(),$e(e)}),i.select(".fieldfiled").call(ge.updateBody,e.visibleFields).on("submit",function(){return ge.readFile(s.select(this)).then(t=>{e.joinFields(t),e.updateContentsNotifier(),$e(e)})}),i.select(".fieldinputd").call(ve.updateBody).on("submit",function(){const t=ve.value(s.select(this));e.rows.addField(t.field),e.rows.records().forEach(e=>{e[t.field.key]=t.default}),e.updateContentsNotifier(),$e(e)}),i.select(".renamed").call(Se.updateBody,e.name).on("submit",function(){e.name=Se.value(s.select(this)),$e(e)}),d.serverStatus().then(t=>{i.select(".fieldfetchd").call(de.updateBody,t.schema,e.rows.fields).on("submit",function(){const o=e.rows.records().map(e=>e.compound_id);de.execute(s.select(this),o,t.schema).then(t=>{e.joinFields(t),e.updateContentsNotifier(),$e(e)})}),i.select(".netgend").call(Ce.updateBody,t.server.rdkit).on("submit",function(){Ce.execute(s.select(this),e.rows.records()).then(t=>{const o=t.workflowID.slice(0,8);return Promise.all([D.appendView(e.storeID,e.viewID,{$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:o,name:o,viewType:"network",nodes:e.rows.collectionID,edges:o,minConnThld:t.query.params.threshold}),D.appendCollection(e.storeID,e.rows.collectionID,{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:o,name:o,contents:[t]})]).then(()=>{s.select("#loading-icon").style("display","none"),window.open(`network.html?store=${e.storeID}&view=${o}`,"_blank")})})}),i.select(".abortd").call(S.updateConfirmDialog,"Are you sure you want to abort this calculation job?").on("submit",function(){e.rows.abort().then(()=>{e.updateContentsNotifier(),$e(e)})})}).catch(()=>{s.select("#menubar").selectAll(".online-command").attr("data-target",null).classed("disabled",!0).on("click",null)})}return{run:function(){const e=a.compatibility();if(e)return void s.select("body").style("color","#ff0000").text(e);document.location.protocol,"onLine"in navigator&&navigator.onLine,a.registerServiceWorker();const t=a.URLQuery().store||null,o=a.URLQuery().view||null;return D.getView(t,o).then(e=>{if(!e)throw"ERROR: invalid URL";return e.storeID=t,D.getCollection(t,e.rows).then(t=>(function(e,t){const o=s.select("#menubar");o.selectAll("div,span,a").remove();const n=s.select("#dialogs");n.selectAll("div").remove();const a=new Z(e,t),l=o.append("div").call(T.dropdownMenuButton,"Datagrid","primary","table-white").select(".dropdown-menu");l.append("a").call(le.menuLink),l.append("a").classed("online-command",!0).call(de.menuLink),l.append("a").call(ge.menuLink),l.append("a").call(ve.menuLink),l.append("a").call(T.dropdownMenuItem,"Generate tile view","menu-tiles").on("click",function(){const e=m.uuidv4();D.appendView(a.storeID,a.viewID,{$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:e,name:e,viewType:"tile",items:a.rows.collectionID,rowCount:5,columnCount:5,tileContent:{field:"structure",visible:!0}}).then(()=>{s.select("#loading-icon").style("display","none"),window.open(`tile.html?store=${a.storeID}&view=${e}`,"_blank")})}),l.append("a").classed("online-command",!0).call(Ce.menuLink),l.append("a").call(Se.menuLink),l.append("a").call(T.dropdownMenuItem,"Save","menu-save").on("click",function(){a.save().then(()=>console.info("Datagrid saved"))}),l.append("a").classed("online-command",!0).call(T.dropdownMenuItem,"Download Excel","menu-exportexcel").on("click",()=>{const e=a.rows.export(),t=new FormData;return t.append("contents",new Blob([JSON.stringify(e)])),d.post("xlsx",t).then(d.blob).then(e=>f.downloadDataFile(e,`${a.name}.xlsx`))}),o.append("a").call(T.menuButtonLink,"Dashboard","outline-secondary","status-gray").attr("href","dashboard.html").attr("target","_blank"),o.append("a").classed("refresh",!0).call(T.menuButtonLink,"Refresh","outline-secondary","refresh-gray").on("click",function(){return a.rows.pull().then(()=>{a.updateContentsNotifier(),$e(a)})}),o.append("a").classed("abort",!0).call(T.menuButtonLink,"Abort server job","warning","delete-gray").attr("data-toggle","modal").attr("data-target","#abort-dialog"),o.append("span").classed("progress",!0).append("progress").attr("max",100),o.append("span").classed("title",!0),o.append("span").classed("status",!0),n.append("div").classed("fieldconfd",!0).call(le.body),n.append("div").classed("fieldfetchd",!0).call(de.body),n.append("div").classed("fieldfiled",!0).call(ge.body),n.append("div").classed("fieldinputd",!0).call(ve.body),n.append("div").classed("netgend",!0).call(Ce.body),n.append("div").classed("renamed",!0).call(Se.body),n.append("div").classed("abortd",!0).call(S.confirmDialog,"abort-dialog"),s.select("#dg-search").call(ee.setFilter,a),s.select("#datagrid").call(te.setSort,a).call(M.datagrid,a),window.onresize=(()=>{s.select("#datagrid").call(M.resize,a).call(M.updateViewport,a,a.viewportTop)}),$e(a)})(e,t))}).catch(e=>{console.error(e),s.select("#datagrid").style("color","red").text(e)})}}});
//# sourceMappingURL=datagridApp.js.map
