// https://github.com/mojaie/kiwiii Version 1.0.0-alpha.6. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("pako"),require("d3"),require("vega")):"function"==typeof define&&define.amd?define(["lodash","pako","d3","vega"],t):e.datagridApp=t(e._,e.pako,e.d3,e.vega)}(this,function(e,t,o,n){"use strict";const s=!1;e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,o=o&&o.hasOwnProperty("default")?o.default:o,n=n&&n.hasOwnProperty("default")?n.default:n;var a={URLQuery:function(){const t=window.location.search.substring(1).split("&").map(e=>e.split("="));return e.fromPairs(t)},compatibility:function(){if(!window.indexedDB)return"Client compatibility error: IndexedDB not supported"},registerServiceWorker:function(){"serviceWorker"in navigator?s?console.info("Service worker is disabled for debugging"):window.addEventListener("load",()=>{navigator.serviceWorker.register("../sw.js")}):console.info("Service worker is not supported")},registerCtrlCommand:function(e,t){document.addEventListener("keydown",o=>{o.ctrlKey&&o.key===e&&t()})}};const l="../req/";function r(e,t={}){const o=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${l}${e}${o}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))}function i(e){return e.json()}var c={get:r,json:i,text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${l}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null},serverStatus:function(){const e={};return r("server").then(i).then(t=>{e.server=t}).then(()=>r("schema")).then(i).then(t=>{e.schema=t}).then(()=>e)},batchRequest:function(e,t){const o=e.map((e,o)=>new Promise(n=>{setTimeout(()=>n(e()),o*t*1e3)}));return Promise.all(o)}};function d(e,t,o){return new Promise((n,s)=>{const a=new FileReader,l=t?e.slice(0,t):e;a.onload=(e=>n(e.target.result)),a.onerror=(e=>s(e)),o?a.readAsArrayBuffer(l):a.readAsText(l)})}function p(e,o){const n=o?t.inflate(e,{to:"string"}):e;return JSON.parse(n)}function u(e,t){try{const o=window.URL.createObjectURL(new Blob([e])),n=document.createElement("a");n.download=t,n.href=o,n.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}var f={readFile:d,parseJSON:p,loadJSON:function(e){const t=e.name.endsWith("c")||e.name.endsWith(".gz");return d(e,!1,t).then(e=>p(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),o=t.endsWith("c")||t.endsWith(".gz");return fetch(t).then(e=>o?e.arrayBuffer():e.json()).then(e=>p(e,o))},downloadDataFile:u,downloadJSON:function(e,o,n=!0){const s=JSON.stringify(e);u(n?t.gzip(s):s,`${o}${`.ap${n?"c":"r"}`}`)}};var m={sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id","assay_id","list"].includes(e)?"text":["text_field","checkbox","html"].includes(e)?"html":"none"},formatNum:function(e,t){return void 0===e||null===e||Number.isNaN(e)?"":e==parseFloat(e)?o.format(t)(e):e},partialMatch:function(e,t){return void 0!==t&&null!==t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const h={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},y={datatable:"nodes",connection:"edges"};function g(e){const t=e.columns.map(e=>("numeric"===e.sort?e.format="numeric":"text"===e.sort?e.format="text":"none"===e.sort&&(e.format="raw"),e));return{id:e.id,name:e.name,dataType:y[e.format],schemaVersion:.8,revision:0,status:h[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function b(e){return{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:e.query,progress:e.progress,execTime:e.execTime,created:e.created,reference:{}}}function w(e){let t=e;return t.edges.hasOwnProperty("schemaVersion")||t.edges.hasOwnProperty("$schema")||(t.nodes=g(t.nodes),t.edges=function(e,t){const o={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(o.nodeColor.id=e.snapshot.nodeColor.id,o.nodeColor.scale=e.snapshot.nodeColor.scale,o.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):o.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(o.nodeSize.id=e.snapshot.nodeSize.id,o.nodeSize.scale=e.snapshot.nodeSize.scale,o.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):o.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(o.nodeLabel.id=e.snapshot.nodeLabel.id,o.nodeLabel.size=e.snapshot.nodeLabel.size,o.nodeLabel.text=e.snapshot.nodeLabel.text,o.nodeLabel.visible=e.snapshot.nodeLabel.visible,o.nodeLabel.scale=e.snapshot.nodeLabel.scale,o.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):o.nodeLabel={id:"label",size:12,text:"index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?o.nodeContent=e.snapshot.nodeContent:o.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?o.edge=e.snapshot.edge:o.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:y[e.format],schemaVersion:.8,revision:0,reference:{nodes:e.nodeTableId},status:h[e.status],fields:[{key:"source"},{key:"target"},{key:"weight"}],records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:o}}(t.edges,t.nodes.fields)),"0.8"!=t.edges.schemaVersion&&.1!==t.edges.schemaVersion||((t=function(e){if(e.edges.hasOwnProperty("reference")||(e.edges.reference={nodes:e.edges.nodesID}),e.nodes.fields.find(e=>"_index"===e.key)){const t={};e.nodes.records.forEach((e,o)=>{e.index=o,e.structure=e._structure,t[e._index]=e.index,delete e._index,delete e._structure}),e.edges.records.forEach(e=>{e.source=t[e.source],e.target=t[e.target]}),e.nodes.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")})}return e}(t)).nodes=b(t.nodes),t.edges=function(e){const t={networkThreshold:e.networkThreshold};return t.nodeContentVisible=e.snapshot.nodeContent.structure.visible,t.nodeColor=e.snapshot.nodeColor.scale||{},t.nodeColor.field&&(t.nodeColor.field=e.snapshot.nodeColor.field.key,"_index"===t.nodeColor.field&&(t.nodeColor.field="index")),"ordinal"===t.nodeColor.scale&&(t.nodeColor.range=o.schemeCategory20),t.nodeSize=e.snapshot.nodeSize.scale||{},e.snapshot.nodeSize.field&&(t.nodeSize.field=e.snapshot.nodeSize.field.key,"_index"===t.nodeSize.field&&(t.nodeSize.field="index")),t.nodeLabel={},e.snapshot.nodeLabel.text&&(t.nodeLabel.text=e.snapshot.nodeLabel.text.key,"_index"===t.nodeLabel.text&&(t.nodeLabel.text="index")),t.nodeLabel.size=e.snapshot.nodeLabel.size,t.nodeLabel.visible=e.snapshot.nodeLabel.visible,t.nodeLabelColor=e.snapshot.nodeLabel.scale||{},e.snapshot.nodeLabel.field&&(t.nodeLabelColor.field=e.snapshot.nodeLabel.field.key,"_index"===t.nodeLabelColor.field&&(t.nodeLabelColor.field="index")),"ordinal"===t.nodeLabelColor.scale&&(t.nodeLabelColor.range=o.schemeCategory20),t.edgeVisible=e.snapshot.edge.visible,t.edgeWidth=e.snapshot.edge.scale||{},t.edgeLabel={},t.edgeLabel.size=e.snapshot.edge.label.size,t.edgeLabel.visible=e.snapshot.edge.label.visible,t.networkThreshold=e.networkThreshold||e.query.threshold,t.coords=e.snapshot.nodePositions,{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:{params:e.query},progress:e.progress,execTime:e.execTime,created:e.created,snapshot:t,reference:e.reference}}(t.edges)),t.edges.hasOwnProperty("$schema")||(delete t.nodes.schemaVersion,delete t.edges.schemaVersion,delete t.nodes.revision,delete t.edges.revision,t.nodes.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json",t.edges.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t}var v={convertPackage:function(e){let t={};if(e.hasOwnProperty("views"))t=e;else{const o=new Date,n=e.hasOwnProperty("edges"),s=n?w(e):function(e){let t=e;return t.hasOwnProperty("schemaVersion")||t.hasOwnProperty("$schema")||(t=g(t)),"0.8"==t.schemaVersion&&(t=b(t=function(e){return e.records.forEach((e,t)=>{e.index=t,e.structure=e._structure,delete e._index,delete e._structure}),e.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")}),e}(t))),t.hasOwnProperty("$schema")||(delete t.schemaVersion,delete t.revision,t.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t.fields.forEach(e=>{"structure"===e.key&&(e.format="svg"),delete e.width,delete e.height}),t}(e),a=n?s.nodes:s;(t={$schema:"https://mojaie.github.io/kiwiii/specs/package_v1.0.json",name:s.edges.name,views:[],dataset:[]}).dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:a.id,name:a.name,contents:[{$schema:a.$schema,workflowID:a.reference.workflow,name:a.name,fields:a.fields,records:a.records,created:a.created,status:a.status,query:a.query,execTime:a.execTime,progress:a.progress}]}),t.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:a.id,name:a.name,viewType:"datagrid",rows:a.id,fields:a.fields,sortOrder:null,filterText:null,checkpoints:[{type:"convert",date:o.toString(),description:"converted from legacy format"}]}),n&&(t.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:s.edges.id,name:s.edges.name,contents:[{$schema:s.edges.$schema,workflowID:s.edges.reference.workflow,name:s.edges.name,fields:s.edges.fields,records:s.edges.records,created:s.edges.created,status:s.edges.status,query:s.edges.query,execTime:s.edges.execTime,progress:s.edges.progress}]}),t.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:s.edges.id,name:s.edges.name,viewType:"network",nodes:a.id,edges:s.edges.id,nodeColor:s.edges.snapshot.nodeColor,nodeSize:s.edges.snapshot.nodeSize,nodeLabel:s.edges.snapshot.nodeLabel,nodeLabelColor:s.edges.snapshot.nodeLabelColor,edgeWidth:s.edges.snapshot.edgeWidth,edgeLabel:s.edges.snapshot.edgeLabel,networkThreshold:s.edges.snapshot.networkThreshold,networkThresholdCutoff:s.edges.snapshot.networkThresholdCutoff,fieldTransform:s.edges.snapshot.fieldTransform,coords:s.edges.snapshot.coords,checkpoints:[{type:"convert",date:o.toString(),description:"converted from legacy format"}]})),t.views.filter(e=>"network"===e.viewType).forEach(e=>{e.minConnThld=e.networkThresholdCutoff,e.currentConnThld=e.networkThreshold,e.hasOwnProperty("nodeLabel")&&(e.nodeLabel.field=e.nodeLabel.text),e.hasOwnProperty("edgeLabel")&&(e.edgeLabel.field="weight"),e.hasOwnProperty("edgeWidth")&&(e.edgeWidth.field="weight")})}return t.views.filter(e=>"network"===e.viewType).forEach(e=>{e.nodeColor.field||(e.nodeColor.field="index"),e.nodeSize.field||(e.nodeSize.field="index"),e.nodeLabel.field||(e.nodeLabel.field="index"),e.nodeLabelColor.field||(e.nodeLabelColor.field="index"),e.edgeColor?e.edgeColor.field||(e.edgeColor.field="weight"):e.edgeColor={field:"weight",color:"monogray",scale:"linear",domain:[0,1],range:["#999999","#999999"],unknown:"#cccccc"},e.edgeWidth.field||(e.edgeWidth.field="weight"),e.edgeLabel.field||(e.edgeLabel.field="weight"),e.edgeLabelColor?e.edgeLabelColor.field||(e.edgeLabelColor.field="weight"):e.edgeLabelColor={field:"weight",color:"monoblack",scale:"linear",domain:[1,1],range:["#333333","#333333"],unknown:"#cccccc"}}),t}};function k(e,t,o){return new Promise((n,s)=>{const a=window.indexedDB.open(e,t);a.onsuccess=function(){n(this.result)},a.onerror=(e=>s(e)),a.onupgradeneeded=(e=>{o(e.currentTarget.result)})})}const x={pkgs:k("Packages",2,e=>{e.createObjectStore("Packages",{keyPath:"id"})}),assets:k("Assets",1,e=>{e.createObjectStore("Assets",{keyPath:"key"})})};function C(e){return new Promise((t,o)=>x[e].then(e=>{const n=e.transaction(e.name,"readwrite").objectStore(e.name).clear();n.onsuccess=(()=>t()),n.onerror=(e=>o(e))}))}function V(){return new Promise(e=>{const t=[];return x.pkgs.then(o=>{o.transaction(o.name).objectStore(o.name).openCursor().onsuccess=(o=>{const n=o.target.result;n?(t.push(n.value),n.continue()):e(t)})})})}function T(e){return new Promise((t,o)=>x.pkgs.then(n=>{const s=n.transaction(n.name).objectStore(n.name).get(e);s.onsuccess=(e=>t(e.target.result)),s.onerror=(e=>o(e))}))}function F(e){return new Promise((t,o)=>x.pkgs.then(n=>{const s=n.transaction(n.name,"readwrite").objectStore(n.name).put(e);s.onerror=(e=>o(e)),s.onsuccess=(()=>t())}))}function S(e,t){return new Promise((o,n)=>x.pkgs.then(s=>{const a=s.transaction(s.name,"readwrite").objectStore(s.name),l=a.get(e);l.onerror=(e=>n(e)),l.onsuccess=(e=>{const s=e.target.result;t(s);const l=a.put(s);l.onsuccess=(()=>o()),l.onerror=(e=>n(e))})}))}var _={clear:C,clearAll:function(){return Promise.all([C("pkgs"),C("assets")])},getAllItems:V,getItem:T,updateItem:S,deleteItem:function(e){return new Promise((t,o)=>x.pkgs.then(n=>{const s=n.transaction(n.name,"readwrite").objectStore(n.name).delete(e);s.onerror=(e=>o(e)),s.onsuccess=(()=>t())}))},getView:function(e,t){return T(e).then(e=>e.views.find(e=>e.viewID===t))},appendView:function(e,t,o){return S(e,e=>{const n=e.views.findIndex(e=>e.viewID===t);e.views.splice(n+1,0,o)})},updateView:function(t,o,n){return S(t,t=>{const s=t.views.findIndex(e=>e.viewID===o);e.isFunction(n)?n(t.views[s]):t.views[s]=n})},deleteView:function(e,t){return S(e,e=>{const o=e.views.findIndex(e=>e.viewID===t);e.views.splice(o,1);const n={};e.dataset.forEach(e=>{n[e.collectionID]=0}),e.views.forEach(e=>{["rows","items","nodes","edges"].filter(t=>e.hasOwnProperty(t)).forEach(t=>{n[e[t]]+=1})}),Object.entries(n).forEach(t=>{if(!t[1]){const o=e.dataset.findIndex(e=>e.collectionID===t[0]);e.dataset.splice(o,1)}})})},getAllCollections:function(){return V().then(t=>e.flatten(t.map(e=>e.dataset.map(t=>(t.instance=e.id,t)))))},getCollection:function(e,t){return T(e).then(e=>e.dataset.find(e=>e.collectionID===t))},addCollection:function(e,t,o){return S(e,e=>{e.dataset.push(o)})},updateCollection:function(t,o,n){return S(t,t=>{const s=t.dataset.findIndex(e=>e.collectionID===o);e.isFunction(n)?n(t.dataset[s]):t.dataset[s]=n})},importItem:function(e){e=v.convertPackage(e);const t=new Date;return e.id=m.uuidv4().slice(0,8),e.sessionStarted=t.toString(),F(e)},newDatagrid:function(e){const t=(new Date).toLocaleString("en-GB",{timeZone:"Asia/Tokyo"}),o=m.uuidv4().slice(0,8),n=m.uuidv4().slice(0,8),s=e.workflowID.slice(0,8);return F({$schema:"https://mojaie.github.io/kiwiii/specs/package_v1.0.json",id:o,name:e.name,views:[{$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:n,name:e.name,viewType:"datagrid",rows:s,checkpoints:[{type:"creation",date:t}]}],dataset:[{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:s,name:e.name,contents:[e]}],sessionStarted:t}).then(()=>({instance:o,viewID:n}))},addDatagrid:function(e,t){const o=m.uuidv4().slice(0,8),n=t.workflowID.slice(0,8);return S(e,e=>{e.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:o,name:t.name,viewType:"datagrid",rows:n}),e.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:n,name:t.name,contents:[t]})}).then(()=>o)},add384Tiles:function(e,t){const o=m.uuidv4().slice(0,8),n=t.workflowID.slice(0,8);return S(e,e=>{e.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/tile_v1.0.json",viewID:o,name:`${t.name}_tiles`,viewType:"tile",items:n,rowCount:16,columnCount:24,chunksPerRow:10}),e.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:n,name:t.name,contents:[t]})}).then(()=>o)},newNetwork:function(e,t,o,n){const s=m.uuidv4().slice(0,8),a=n.workflowID.slice(0,8);return S(e,e=>{e.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:s,name:`${o}_${n.name}`,viewType:"network",nodes:t,edges:a,minConnThld:n.query.params.threshold}),e.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:a,name:n.name,contents:[n]})}).then(()=>s)},getAsset:function(e){return new Promise((t,o)=>x.assets.then(n=>{const s=n.transaction(n.name).objectStore(n.name).get(e);s.onsuccess=(e=>{const o=void 0===e.target.result?void 0:e.target.result.value;t(o)}),s.onerror=(e=>o(e))}))},putAsset:function(e,t){return new Promise((o,n)=>x.assets.then(s=>{const a=s.transaction(s.name,"readwrite").objectStore(s.name).put({key:e,value:t});a.onerror=(e=>n(e)),a.onsuccess=(()=>o())}))}};const D="../assets/",I="../assets/icon/";var L={badge:function(e){e.classed("badge",!0),e.append("img").classed("icon",!0).style("width","1.25rem").style("height","1.25rem"),e.append("span").classed("text",!0)},updateBadge:function(e,t,o,n){e.classed(`badge-${o}`,!0),e.select(".icon").attr("src",n?`${I}${n}.svg`:null),e.select(".text").text(t)},notify:function(e){e.style("opacity",0).style("display","inline").transition().duration(500).ease(o.easeLinear).style("opacity",1).transition().delay(3e3).duration(1e3).ease(o.easeLinear).style("opacity",0).on("end",function(){e.style("display","none")})},loadingCircle:function(e){e.style("display","none").append("img").attr("src",`${D}loading1.gif`).style("width","2rem").style("height","2rem")},alert:function(e){e.classed("alert",!0).classed("px-1",!0).classed("py-0",!0),e.append("img").classed("icon",!0).style("width","1.25rem").style("height","1.25rem"),e.append("span").classed("text",!0).style("font-size","75%")},updateAlert:function(e,t,o,n){e.classed(`alert-${o}`,!0),e.select(".icon").attr("src",n?`${I}${n}.svg`:null),e.select(".text").text(t)},invalidFeedback:function(e){e.classed("invalid-feedback",!0).style("display","none"),e.append("img").classed("icon",!0).attr("src",`${I}caution-salmon.svg`).style("width","1rem").style("height","1rem"),e.append("span").classed("invalid-msg",!0)},updateInvalidMessage:function(e,t){e.select(".invalid-msg").text(t)}};const O="../assets/icon/";var B={iconBaseURL:O,buttonBox:function(e,t,o){e.classed("form-group",!0).classed("mb-1",!0).append("button").classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).text(t)},menuButton:function(e,t,o){e.classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("mr-1",!0).text(t)},menuButtonLink:function(e,t,o,n){e.classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("href","#"),e.append("img").attr("src",n?`${O}${n}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").style("vertical-align","middle").text(t)},menuModalLink:function(e,t,o,n,s){e.classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("href","#").attr("role","button").attr("data-toggle","modal").attr("data-target",`#${t}`),e.append("img").attr("src",s?`${O}${s}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").classed("label",!0).style("vertical-align","middle").text(o)},dropdownMenuButton:function(e,t,o,n){e.classed("btn-group",!0).classed("mr-1",!0);const s=e.append("button").classed("btn",!0).classed(`btn-${o}`,!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown");s.append("img").attr("src",n?`${O}${n}.svg`:null).style("width","1.25rem").style("height","1.25rem"),s.append("span").style("vertical-align","middle").text(t),e.append("div").classed("dropdown-menu",!0)},dropdownMenuItem:function(e,t,o){e.classed("dropdown-item",!0).attr("href","#"),e.append("img").attr("src",o?`${O}${o}.svg`:null).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuModal:function(e,t,o,n){e.classed("dropdown-item",!0).attr("href","#").attr("data-toggle","modal").attr("data-target",`#${o}`),e.append("img").attr("src",`${O}${n}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuFile:function(e,t,n,s){e.classed("dropdown-item",!0).attr("href","#").on("click",function(){o.select(this).select("input").node().click()}),e.append("form").style("display","none").append("input").attr("type","file").attr("accept",n),e.append("img").attr("src",`${O}${s}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuFileValue:function(e){return e.select("input").node().files[0]}};function P(e,t){e.classed("modal",!0).attr("tabindex",-1).attr("role","dialog").attr("aria-labelledby","").attr("aria-hidden",!0).attr("id",t),e.append("div").classed("modal-dialog",!0).attr("role","document").append("div").classed("modal-content",!0)}var j={confirmDialog:function(e,t){const o=e.call(P,t).select(".modal-content");o.append("div").classed("modal-body",!0).append("div").classed("message",!0);const n=o.append("div").classed("modal-footer",!0);n.append("button").classed("btn",!0).classed("btn-outline-secondary",!0).classed("cancel",!0).attr("type","button").attr("data-dismiss","modal").text("Cancel"),n.append("button").classed("btn",!0).classed("btn-warning",!0).classed("ok",!0).attr("type","button").attr("data-dismiss","modal").text("OK").on("click",()=>{e.dispatch("submit")})},updateConfirmDialog:function(e,t){e.select(".message").text(t)},submitDialog:function(e,t,o){const n=e.call(P,t).select(".modal-content"),s=n.append("div").classed("modal-header",!0);s.append("h4").classed("modal-title",!0).text(o),s.append("button").attr("type","button").attr("data-dismiss","modal").attr("aria-label","Close").classed("close",!0).append("span").attr("aria-hidden",!0).html("&times;"),n.append("div").classed("modal-body",!0),n.append("div").classed("modal-footer",!0).append("button").classed("btn",!0).classed("btn-primary",!0).classed("submit",!0).attr("type","button").attr("data-dismiss","modal").text("Submit").on("click",()=>{$(`#${t}`).modal("hide"),e.dispatch("submit")})}};const R=[{key:"monoblack",type:"monocolor",colors:["#333333"],unknown:"#333333"},{key:"monogray",type:"monocolor",colors:["#cccccc"],unknown:"#cccccc"},{key:"nodeDefault",type:"monocolor",colors:["#7fffd4"],unknown:"#7fffd4"},{key:"aquamarine",type:"bicolor",colors:["#778899","#7fffd4"],unknown:"#f0f0f0"},{key:"chartreuse",type:"bicolor",colors:["#778899","#7fff00"],unknown:"#f0f0f0"},{key:"salmon",type:"bicolor",colors:["#778899","#fa8072"],unknown:"#f0f0f0"},{key:"violet",type:"bicolor",colors:["#778899","#ee82ee"],unknown:"#f0f0f0"},{key:"temperature",type:"tricolor",colors:["#87ceeb","#fff5ee","#fa8072"],unknown:"#f0f0f0"},{key:"spectrum",type:"tricolor",colors:["#6495ed","#ccff66","#ffa500"],unknown:"#f0f0f0"},{key:"category10",type:"categorical",colors:["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#bc80bd","#ccebc5"],unknown:"#f0f0f0"},{key:"cbsafe",type:"categorical",colors:["#543005","#8c510a","#bf812d","#dfc27d","#f6e8c3","#c7eae5","#80cdc1","#35978f","#01665e","#003c30"],unknown:"#f0f0f0"},{key:"category20",type:"categorical",colors:o.schemePaired.concat(o.schemeSet2),unknown:"#f0f0f0"},{key:"category40",type:"categorical",colors:o.schemePaired.concat(o.schemePastel2,o.schemeSet2,o.schemeSet3),unknown:"#f0f0f0"},{key:"custom",type:"custom",colors:["#ffffff"],text:"custom"}],q=[{key:"linear",name:"Linear",func:o.scaleLinear},{key:"log",name:"Log",func:o.scaleLog},{key:"quantize",name:"Quantize",func:o.scaleQuantize},{key:"ordinal",name:"Ordinal",func:o.scaleOrdinal}];var M={colorScales:R,types:q,scaleFunction:function(e){const t=R.find(t=>t.key===e.color);let o,n;t&&"custom"!==t.key?(o=t.colors,n=t.unknown):(o=e.range,n=e.unknown);let s=null;if(3===o.length){const t=(parseFloat(e.domain[0])+parseFloat(e.domain[1]))/2;s=[e.domain[0],t,e.domain[1]]}else s=e.domain;let a=q.find(t=>t.key===e.scale).func();return a=(a=a.domain(s)).range(o),["linear","log"].includes(e.scale)&&(a=a.clamp(!0)),t=>{if(""===t||void 0===t||null===t)return n;if(["linear","log"].includes(e.scale)&&parseFloat(t)!=t)return n;if("log"===e.scale&&t<=0)return n;const o=a(t);return void 0===o?n:o}},isD3Format:function(e){try{o.format(e)}catch(e){return!1}return!0}};function A(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}var z={singleToMulti:A,mappingToTable:function(e){const t=e.hasOwnProperty("field")?A(e):e;return{fields:[{key:t.key,format:"text"}].concat(t.fields),records:Object.entries(t.mapping).map(e=>{const o={};return o[t.key]=e[0],t.fields.forEach((t,n)=>{o[t.key]=e[1][n]}),o})}},tableToMapping:function(e,t,o=["index"]){const n={created:(new Date).toString(),fields:e.fields.filter(e=>e.key!==t).filter(e=>!o.includes(e.key)),key:t,mapping:{}};return e.records.forEach(e=>{n.mapping[e[t]]=n.fields.map(t=>e[t.key])}),n},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),o=t.shift().split(","),n=o.shift(),s=new Date,a=[],l=[];o.forEach((e,t)=>{""!==e&&(a.push(t),l.push({key:e,format:"text"}))});const r={created:s.toString(),fields:l,key:n,mapping:{}};return t.forEach(e=>{const t=e.split(","),o=t.shift();r.mapping[o]=Array(a.length),a.forEach(e=>{r.mapping[o][e]=t[e]})}),r},apply:function(t,o){const n=o.hasOwnProperty("field")?A(o):o;t.records.filter(e=>n.mapping.hasOwnProperty(e[n.key])).forEach(e=>{n.fields.forEach((t,o)=>{e[t.key]=n.mapping[e[n.key]][o]})}),t.fields=e(t.fields).concat(n.fields).uniqBy("key").value()}};class N{constructor(e){this.autoIndex="index",this.collectionID=e.collectionID||null,this.instance=e.instance||null,this.name=e.name||null,e.records?(this.contents=[e],this.fields=[]):(this.contents=e.contents,this.fields=e.fields||[]),this.contents.forEach(e=>{e.fields.forEach(e=>this.addField(e))})}addField(e){this.fields.find(t=>t.key===e.key)||(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),this.fields.push(e))}updateFields(e){this.fields=[],e.forEach(e=>this.addField(e))}joinFields(e){this.contents.forEach(t=>{z.apply(t,e)}),e.hasOwnProperty("fields")?e.fields.forEach(e=>this.addField(e)):this.addField(e.field)}apply(e){this.contents.forEach(t=>{t.records.forEach(t=>{e(t)})})}records(){return e.flatten(this.contents.map(e=>e.records))}fetch(e){const t=this.contents.filter(e=>["running","ready","interrupted","queued"].includes(e.status)).map(t=>{const o={id:t.workflowID,command:e};return c.get("progress",o).then(c.json).then(e=>_.updateCollection(this.instance,this.collectionID,t=>{const n=t.contents.findIndex(e=>e.workflowID===o.id);"failure"===e.status?t.contents[n].status="failure":t.contents[n]=e}))});return Promise.all(t).then(()=>_.getCollection(this.instance,this.collectionID)).then(e=>{this.contents=e.contents})}pull(){return this.fetch("pull")}abort(){return this.fetch("abort")}size(){return e.sum(this.contents.map(e=>e.records.length))}status(){return this.contents.some(e=>"interrupted"===e.status)?"interrupted":this.contents.some(e=>"running"===e.status)?"running":this.contents.some(e=>"queued"===e.status)?"queued":this.contents.some(e=>"ready"===e.status)?"ready":this.contents.some(e=>"aborted"===e.status)?"aborted":this.contents.some(e=>"failure"===e.status)?"failure":"done"}ongoing(){return["ready","queued","running","interrupted"].includes(this.status())}progress(){return e.min(this.contents.map(e=>e.progress))}execTime(){return e.sum(this.contents.map(e=>e.execTime))}export(){return{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:this.collectionID,name:this.name,fields:this.fields,contents:this.contents}}}function E(e,t){const o=e.select(".dg-header");o.selectAll(".dg-hcell").remove(),o.selectAll(".dg-hcell").data(t.visibleFields).enter().append("div").classed("dg-hcell",!0).call(t.headerCellRenderer)}function H(e,t){const n=e.select(".dg-body").selectAll(".dg-row").data(t.recordsToShow(),t.keyFunc);n.exit().remove(),n.selectAll(".dg-cell").remove(),n.enter().append("div").attr("class","dg-row").style("position","absolute").style("width","100%").merge(n).style("height",`${t.rowHeight}px`).each(function(e,n){const s=t.viewportTop+n,a=s*t.rowHeight;o.select(this).style("transform",`translate(0px, ${a}px)`).classed("odd",s%2==0).call(t.rowFactory(),e)})}function U(e,t,o){e.select(".dg-body").style("height",`${t.bodyHeight}px`),t.setScrollPosition(o),e.call(H,t,o),e.select(".dg-viewport").node().scrollTop=o*t.rowHeight}function W(e,t){const o=e.select(".dg-viewport"),n=o.node().getBoundingClientRect().top;t.resizeViewport(window.innerHeight-n-5),o.style("height",`${t.viewportHeight}px`)}var G={headerCellRenderer:function(e){e.style("display","inline-block").style("width",e=>`${e.width}%`).text(e=>e.name)},updateHeader:E,updateRows:H,updateViewport:U,resize:W,datagrid:function(e,t){e.append("div").classed("dg-header",!0),e.append("div").classed("dg-viewport",!0).style("overflow-y","auto").on("scroll",function(){const o=Math.floor(this.scrollTop/t.rowHeight);o!==t.previousViewportTop&&(t.setScrollPosition(o),e.call(H,t,o))}).append("div").classed("dg-body",!0).style("position","relative"),t.updateContentsNotifier=(()=>{t.applyHeader(),e.call(E,t),e.call(W,t),t.applyData(),e.call(U,t,t.viewportTop)}),t.updateFilterNotifier=(o=>{t.setFilterText(o),e.call(U,t,0)})}};var J={plotCell:function(e,t,o){new n.View(n.parse(t[o.key])).initialize(e.node()).run()},plotThumbnail:function(e){return new n.View(n.parse(e)).toImageURL("png")},binaryToDataURI:function(e){return new Promise(t=>{const o=new FileReader;o.onload=(e=>{t(e.target.result)}),o.readAsDataURL(e)})}};function Q(e,t,o){e.text(m.formatNum(t[o.key],o.d3_format))}function K(e,t,o){e.text(t[o.key])}function Z(e,t,o){e.html(t[o.key])}function X(e,t,o){e.append("a").attr("href",`profile.html?compound=${t[o.key]}`).attr("target","_blank").text(t[o.key])}function Y(e,t,o){e.append("img").attr("width",180).attr("height",180).attr("src",t[o.key])}function ee(e,t,o){e.append("input").attr("type","checkbox").property("checked",t[o.key]).property("disabled",!!o.disabled&&t[o.disabled]).on("click",function(){t[o.key]=this.checked})}function te(e,t,o){e.append("input").attr("type","text").style("width","90%").property("value",t[o.key]).on("change",function(){t[o.key]=this.value})}function oe(e,t){e.call(t)}function ne(e,t,o){const n=`${o.request}${t[o.key]}`;_.getAsset(n).then(e=>void 0!==e?e:fetch(n,{credentials:"include"}).then(e=>e.blob()).then(e=>_.putAsset(n,e).then(()=>e))).then(t=>{e.append("img").attr("width",180).attr("height",180).attr("src",URL.createObjectURL(t))})}function se(e,t,o){const n=`${o.request}${t[o.key]}`;_.getAsset(n).then(e=>void 0!==e?e:fetch(n,{credentials:"include"}).then(e=>e.text()).then(e=>_.putAsset(n,e).then(()=>e))).then(t=>{e.html(t)})}const ae={numeric:K,text:K,date:function(e,t,o){e.text(t[o.key])},raw:K,d3_format:Q,compound_id:X,assay_id:K,list:K,plot:J.plotCell,image:Y,checkbox:ee,text_field:te,control:oe,svg:Z,html:Z,async_image:ne,async_html:se};function le(e){e.classed("dg-cell",!0).classed("align-middle",!0).classed("text-truncate",!0).style("display","inline-block")}var re={d3Format:Q,text:K,html:Z,compoundID:X,image:Y,checkbox:ee,textField:te,call:oe,asyncImage:ne,asyncHtml:se,rowCell:le,rowFactory:function(e){return(t,o)=>{e.forEach(e=>{const n=t.append("div").call(le).style("width",`${e.width}%`);o.hasOwnProperty(e.key)&&n.call(ae[e.format],o,e)})}}};class ie{constructor(e,t){this.instance=e.instance||null,this.viewID=e.viewID||null,this.name=e.name||null,this.sortOrder=e.sortOrder||[],this.filterText=e.filterText||null,this.rows=new N(t),this.visibleFields=null,this.sortedRecords=null,this.filteredRecords=null,this.defaultColumnHeight={numeric:40,text:40,html:40,none:200},this.scrollBarSpace=20,this.keyFunc=(e=>e.index),this.rowHeight=null,this.bodyHeight=null,this.viewportHeight=null,this.numViewportRows=null,this.viewportTop=0,this.previousViewportTop=null,this.viewportBottom=null,this.fixedViewportHeight=null,this.updateContentsNotifier=null,this.updateFilterNotifier=null,this.headerCellRenderer=G.headerCellRenderer,this.rowFactory=(()=>re.rowFactory(this.visibleFields))}setViewportSize(e){this.viewportHeight=this.fixedViewportHeight||e}setScrollPosition(e){this.previousViewportTop=this.viewportTop,this.viewportTop=e,this.viewportBottom=Math.min(this.viewportTop+this.numViewportRows,this.filteredRecords.length)}setNumViewportRows(){this.numViewportRows=Math.ceil(this.viewportHeight/this.rowHeight)+1}resizeViewport(e){this.setViewportSize(e),this.setNumViewportRows()}applyHeader(){this.visibleFields=this.rows.fields.filter(e=>e.visible);const e=this.visibleFields.reduce((e,t)=>e+(t.widthf||1),0);this.visibleFields=this.visibleFields.map(t=>{const o={width:(t.widthf||1)/e*100,height:t.height||this.defaultColumnHeight[m.sortType(t.format)]};return Object.assign(o,t)}),this.rowHeight=this.visibleFields.reduce((e,t)=>e.height>t.height?e:t,0).height}applyData(){this.setNumViewportRows(),this.applyOrder()}applyOrder(t,o){if(t)this.sortedRecords=e.orderBy(this.rows.records().slice(),[t],[o]);else{const t=this.sortOrder.map(e=>e.key),o=this.sortOrder.map(e=>e.order);t&&(this.sortedRecords=e.orderBy(this.rows.records().slice(),t,o))}this.applyFilter()}applyFilter(){if(null===this.filterText)this.filteredRecords=this.sortedRecords.slice();else{const e=this.visibleFields.filter(e=>"none"!==m.sortType(e.format)).map(e=>e.key);this.filteredRecords=this.sortedRecords.filter(t=>e.some(e=>m.partialMatch(this.filterText,t[e])))}this.bodyHeight=this.filteredRecords.length*this.rowHeight}setSortOrder(e,t){const o=this.sortOrder.findIndex(e=>e.key),n={key:e,order:t};-1!==o&&this.sortOrder.splice(o,1),this.sortOrder.splice(0,0,n),this.applyOrder(e,t)}setFilterText(e){this.filterText=e,this.applyFilter()}updateFields(e){this.rows.updateFields(e)}joinFields(e){this.rows.joinFields(e),this.applyData()}recordsToShow(){return this.filteredRecords.slice(this.viewportTop,this.viewportBottom)}save(){return _.updateItem(this.instance,e=>{const t=e.dataset.findIndex(e=>e.collectionID===this.rows.collectionID);e.dataset[t]=this.rows.export();const o=e.views.findIndex(e=>e.viewID===this.viewID);e.views[o]=this.export()})}export(){return{$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:this.viewID,name:this.name,viewType:"datagrid",rows:this.rows.collectionID,sortOrder:this.sortOrder,filterText:this.filterText}}}function ce(e){return e.select(".form-control").property("value")}function de(e){return e.select(".form-control").node().checkValidity()}function pe(e,t){e.select(".invalid-feedback").style("display",t?"none":"inherit"),e.select(".form-control").style("background-color",t?null:"#ffcccc")}function ue(e){return/\s*?\w\s*?/.test(ce(e))}function fe(e,t,o){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",o).on("change",function(){const t=me(e);e.call(pe,t)}),e.append("div").classed("col-4",!0),e.append("div").call(L.invalidFeedback).classed("col-8",!0)}function me(e){return e.select("input").property("files").length>0}var he={updateFormValue:function(e,t){e.select(".form-control").property("value",t),e.call(pe,!0)},formValue:ce,formValid:de,setValidity:pe,textBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","text").on("input",function(){const t=de(e);e.call(pe,t)}),e.append("div").classed("col-4",!0),e.append("div").call(L.invalidFeedback).classed("col-8",!0)},readonlyBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control-plaintext",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","text").attr("readonly","readonly")},updateReadonlyValue:function(e,t){e.select(".form-control-plaintext").property("value",t)},readonlyValue:function(e){return e.select(".form-control-plaintext").property("value")},textareaBox:function(e,t,o,n){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t).append("div").call(L.invalidFeedback),e.append("textarea").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("rows",o).attr("placeholder",n).on("input",function(){const t=ue(e);e.call(pe,t)})},textareaBoxLines:function(e){const t=e.select("textarea").property("value");return t?t.split("\n").map(e=>e.replace(/^\s+|\s+$/g,"")).filter(e=>e.length>0):[]},textareaValid:ue,numberBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","number").on("input",function(){const t=de(e);e.call(pe,t)}),e.append("div").classed("col-4",!0),e.append("div").call(L.invalidFeedback).classed("col-8",!0)},updateNumberRange:function(e,t,o,n){e.select(".form-control").attr("min",t).attr("max",o).attr("step",n).dispatch("input",{bubbles:!0})},checkBox:function(e,t){const o=e.classed("form-group",!0).classed("form-row",!0).classed("form-check",!0).append("label").classed("form-check-label",!0).classed("col-form-label-sm",!0);o.append("input").classed("form-check-input",!0).attr("type","checkbox"),o.append("span").text(t)},updateCheckBox:function(e,t){e.select("input").property("checked",t)},checkBoxValue:function(e){return e.select("input").property("checked")},colorBox:function(e,t){e.classed("form-row",!0).classed("align-items-center",!0).on("change",()=>{o.event.stopPropagation()}),e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).text(t),e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).append("input").classed("form-control",!0).classed("form-control-sm",!0).attr("type","color")},fileInputBox:fe,clearFileInput:function(e){const t=e.select("label").text(),o=e.select("input").attr("accept");e.selectAll("*").remove(),e.call(fe,t,o)},fileInputValue:function(e){return e.select("input").property("files")[0]},fileInputValid:me};var ye={setFilter:function(e,t){const o=e.classed("row",!0).classed("justify-content-end",!0).append("div").classed("col-5",!0).call(he.textBox,"Search");o.select("label").classed("text-right",!0),o.select("input").on("keyup",function(){t.updateFilterNotifier(he.formValue(o))})}};var ge={setSort:function(e,t){t.headerCellRenderer=(n=>{n.style("display","inline-block").style("width",e=>`${e.width}%`).text(e=>e.name).filter(e=>"none"!==m.sortType(e.format)).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",n=>{const s="v"===o.select(`#sort-${n.key}`).text();o.select(`#sort-${n.key}`).text(s?"^":"v"),t.setSortOrder(n.key,s?"desc":"asc"),e.call(G.updateRows,t)})})}};var be={table:function(e,t,o,n,s){const a=new ie({},{fields:t,records:o});a.keyFunc=(e=>e),n&&(a.rowFactory=(()=>n(a.visibleFields))),a.fixedViewportHeight=s||300,e.append("div").classed("table",!0).call(G.datagrid,a),e.datum(a)},filterTable:function(e,t,o,n,s){const a=new ie({},{fields:t,records:o});n&&(a.rowFactory=(()=>n(a.visibleFields))),a.fixedViewportHeight=s||300,e.append("div").classed("search",!0).call(ye.setFilter,a),e.append("div").classed("table",!0).call(G.datagrid,a),e.datum(a)},filterSortTable:function(e,t,o,n,s){const a=new ie({},{fields:t,records:o});n&&(a.rowFactory=(()=>n(a.visibleFields))),a.fixedViewportHeight=s||300,e.append("div").classed("search",!0).call(ye.setFilter,a),e.append("div").classed("table",!0).call(ge.setSort,a).call(G.datagrid,a),e.datum(a)},update:function(e,t,o){const n={fields:t,records:o},s=e.datum();s.rows=new N(n),s.updateContentsNotifier()},updateRecords:function(e,t){const o=e.datum();o.rows.contents[0].records=t,o.updateContentsNotifier()},tableRecords:function(e){return e.datum().rows.records()}};const we="fieldconf-dialog",ve="Column setting";function ke(e){return(t,n)=>{t.append("div").call(re.rowCell).style("width",`${e[0].width}%`).text(n.name),t.append("div").call(re.rowCell).style("width",`${e[1].width}%`).append("input").attr("type","checkbox").property("checked",n.visible).on("change",function(){n.visible=this.checked});const s=t.append("div").call(re.rowCell).style("width",`${e[2].width}%`).append("select"),a=!e[2].options.includes(n.format);s.selectAll("option").data(a?[n.format]:e[2].options).enter().append("option").attr("value",e=>e).text(e=>e),s.property("value",n.format).property("disabled",a).on("change",function(){n.format=this.value,t.select(".d3f input").property("disabled","d3_format"!==n.format)}),t.append("div").call(re.rowCell).classed("d3f",!0).style("width",`${e[3].width}%`).append("input").attr("type","text").style("width","90%").property("value",n.d3_format).property("disabled","d3_format"!==n.format).on("input",function(){const e=M.isD3Format(this.value);o.select(this).style("background-color",e?"#ffffff":"#ffcccc"),e&&(n.d3_format=this.value,t.dispatch("change",{bubbles:!0}))})}}var xe={menuLink:function(e){e.call(B.dropdownMenuModal,ve,we,"menu-edittable")},body:function(e){const t=e.call(j.submitDialog,we,ve);t.select(".modal-dialog").classed("modal-lg",!0),t.select(".modal-body").append("div").classed("dgfields",!0).call(be.table,[{key:"name",name:"Name",format:"text"},{key:"visible",name:"Visible",format:"checkbox",widthf:.5,height:40},{key:"format",name:"Format",format:"select",options:["text","numeric","d3_format","raw","compound_id"],height:40},{key:"d3_format",name:"D3 format",format:"text_field",height:40}],[],ke,300)},updateBody:function(e,t){e.select(".dgfields").call(be.updateRecords,t).on("change",function(){const t=o.select(this).selectAll(".d3f input").nodes().map(e=>e.value).every(e=>M.isD3Format(e));e.select(".submit").property("disabled",!t)})},value:function(e){return be.tableRecords(e.select(".dgfields"))}};const Ce="fieldfetch-dialog",Ve="Fetch assays";var Te={menuLink:function(e){e.call(B.dropdownMenuModal,Ve,Ce,"menu-addassay")},body:function(e){const t=e.call(j.submitDialog,Ce,Ve);t.select(".modal-dialog").classed("modal-lg",!0),t.select(".modal-body").append("div").classed("assays",!0).call(be.filterTable,[{key:"check",name:"Check",format:"checkbox",widthf:.5,height:40,disabled:"check_d"},{key:"assay_id",name:"Assay ID",format:"assay_id"},{key:"name",name:"Name",format:"text"},{key:"value_type",name:"Value type",format:"text"},{key:"tags",name:"Tags",format:"list",widthf:2}],[])},updateBody:function(t,n,s){const a=e.flatten(n.resources.filter(e=>"assay"===e.domain).map(e=>e.data)),l=e.flatMap(a,e=>e.value_types.map(t=>{const o=Object.assign({},e);return o.value_type=t.key,delete o.value_types,o})),r={};s.filter(e=>e.hasOwnProperty("__origin")).map(e=>e.__origin).forEach(e=>{r.hasOwnProperty(e.assay_id)||(r[e.assay_id]=[]),r[e.assay_id].push(e.value_type)});const i=l.map(e=>{const t=r.hasOwnProperty(e.assay_id)&&r[e.assay_id].includes(e.value_type);return e.check=t,e.check_d=t,e});t.select(".assays").call(be.updateRecords,i).on("change",function(){const e=be.tableRecords(o.select(this)).filter(e=>e.check&&!e.check_d).length;t.select(".submit").property("disabled",!e)}).dispatch("change")},execute:function(e,t,o){const n=o.resources.filter(e=>"activity"===e.domain).map(e=>e.id),s=be.tableRecords(e.select(".assays")).filter(e=>e.check&&!e.check_d).map(e=>({workflow:"activity",targets:n,assay_id:e.assay_id,condition:{compounds:t,value_types:[e.value_type]}})).map(e=>c.get(e.workflow,e).then(c.json));return Promise.all(s).then(e=>{const t=e.shift();return e.forEach(e=>{const o=z.tableToMapping(e,"compound_id",["index","assay_id"]);z.apply(t,o)}),z.tableToMapping(t,"compound_id",["index","assay_id"])})}};function Fe(e,t,o){const n=e.append("g");n.append("rect").attr("x",0).attr("y",0).attr("width",100).attr("height",10).attr("fill",t[0]),n.append("text").attr("text-anchor","middle").attr("x",50).attr("y",10).attr("font-size",12).text(o)}var $e={colorBar:{monocolor:Fe,bicolor:function(e,t,o){const n=m.uuidv4().slice(0,8);e.call(Fe,t,o);const s=e.append("defs").append("linearGradient").attr("id",n);s.append("stop").attr("offset",0).attr("stop-color",t[0]),s.append("stop").attr("offset",1).attr("stop-color",t[1]),e.select("rect").attr("fill",`url(#${n})`)},tricolor:function(e,t,o){const n=m.uuidv4().slice(0,8);e.call(Fe,t,o);const s=e.append("defs").append("linearGradient").attr("id",n);s.append("stop").attr("offset",0).attr("stop-color",t[0]),s.append("stop").attr("offset",.5).attr("stop-color",t[1]),s.append("stop").attr("offset",1).attr("stop-color",t[2]),e.select("rect").attr("fill",`url(#${n})`)},categorical:function(e,t,o){const n=100/t.length,s=e.append("g");t.forEach((e,o)=>{s.append("rect").attr("x",n*o).attr("y",0).attr("width",n).attr("height",10).attr("fill",t[o])}),s.append("text").attr("text-anchor","middle").attr("x",50).attr("y",10).attr("font-size",12).text(o)},custom:Fe},setSize:function(e,t,o){e.attr("width",t).attr("height",o)}};function Se(e){return e.selectAll("input:checked").data().map(e=>e.key)}function _e(e){return Se(e).length>0}function De(e,t){e.select(".invalid-feedback").style("display",t?"none":"inherit"),e.select(".form-control").style("background-color",t?null:"LightPink")}function Ie(e,t){const o=e.select(".selected");o.selectAll("svg").remove(),o.datum(t),o.append("svg").attr("viewBox","0 0 100 10").attr("preserveAspectRatio","none").call($e.colorBar[t.type],t.colors,t.text).call($e.setSize,100,10)}var Le={selectBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("select").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).on("input",function(){const t=he.formValid(e);e.call(he.setValidity,t)})},updateSelectBoxOptions:function(e,t){const o=e.select("select").selectAll("option").data(t,e=>e.key);o.exit().remove(),o.enter().append("option").attr("value",e=>e.key).text(e=>e.name)},selectedRecord:function(e){const t=he.formValue(e);return e.selectAll("select option").data().find(e=>e.key===t)},checklistBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t).append("div").call(L.invalidFeedback),e.append("ul").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0)},updateChecklistItems:function(e,t){const o=e.select("ul").selectAll("li").data(t,e=>e.key);o.exit().remove();const n=o.enter().append("li").attr("class","form-check").append("label").attr("class","form-check-label");n.append("input").attr("type","checkbox").attr("class","form-check-input").property("value",e=>e.key),n.append("span").text(e=>e.name)},checkRequired:function(e){e.selectAll("input").on("change",function(){const t=_e(e);e.call(De,t)})},updateChecklistValues:function(e,t){e.selectAll("input").each(function(e){o.select(this).property("checked",t.includes(e.key))}),e.call(De,!0)},checklistValues:Se,anyChecked:_e,setChecklistValidity:De,colorScaleBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t||"Colorscale");const o=e.append("div").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0),n=o.append("div").classed("btn-group",!0).classed("mr-1",!0);n.append("button").classed("btn",!0).classed("btn-light",!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown"),n.append("div").classed("dropdown-menu",!0).classed("py-0",!0),o.append("span").classed("selected",!0)},colorScaleBoxItems:function(e,t){const n=e.select(".dropdown-menu").selectAll("a").data(t,e=>e);n.exit().remove(),n.enter().append("a").classed("dropdown-item",!0).classed("py-0",!0).attr("href","#").attr("title",e=>e.key).on("click",function(t){e.call(Ie,t),e.dispatch("change",{bubbles:!0})}).append("svg").each(function(e){o.select(this).attr("viewBox","0 0 100 10").attr("preserveAspectRatio","none").call($e.colorBar[e.type],e.colors,e.text).call($e.setSize,100,10)})},updateColorScaleBox:function(e,t){const o=e.select(".dropdown-menu").selectAll("a").data().find(e=>e.key===t);e.call(Ie,o)},colorScaleBoxValue:function(e){return e.select(".selected").datum().key},colorScaleBoxItem:function(e){return e.select(".selected").datum()}};const Oe="fieldfile-dialog",Be="Import fields from file";var Pe={menuLink:function(e){e.call(B.dropdownMenuModal,Be,Oe,"menu-addfile")},body:function(e){const t=e.call(j.submitDialog,Oe,Be).select(".modal-body");t.append("div").classed("file",!0).call(he.fileInputBox,"File (JSON mapping or CSV)",".json,.csv").on("change",function(){const t=he.fileInputValid(o.select(this));if(e.select(".submit").property("disabled",!t),!t)return;const n=he.fileInputValue(o.select(this));return f.readFile(n).then(t=>{const o="csv"===n.name.split(".").pop()?z.csvToMapping(t):JSON.parse(t),s=z.mappingToTable(o);e.select(".right").call(Le.updateSelectBoxOptions,[{key:o.key,name:o.key}]).call(he.updateFormValue,o.key),e.select(".preview").call(be.update,s.fields,s.records.slice(0,5))})}),t.append("div").classed("left",!0).call(Le.selectBox,"Datagrid ID"),t.append("div").classed("right",!0).call(Le.selectBox,"File ID").select("select").property("disabled",!0),t.append("h5").classed("mt-2",!0).text("Preview"),t.append("div").classed("preview",!0).call(be.table,[],[],null,210)},updateBody:function(e,t){const o=t.filter(e=>"none"!==m.sortType(e.format)),n=o.find(e=>"compound_id"===e.format)||o[0];e.select(".left").call(Le.updateSelectBoxOptions,o).call(he.updateFormValue,n.key),e.select(".preview").call(be.update,[],[]),e.select(".file").call(he.clearFileInput).call(L.updateInvalidMessage,"Please choose a valid file"),e.select(".submit").property("disabled",!0)},readFile:function(e){const t=he.formValue(e.select(".left")),o=he.fileInputValue(e.select(".file")),n="csv"===o.name.split(".").pop();return f.readFile(o).then(e=>{let o=n?z.csvToMapping(e):JSON.parse(e);o.hasOwnProperty("field")&&(o=z.singleToMulti(o)),o.key=t;const s=[];if(o.fields.forEach((e,t)=>{"plot"===e.format&&(o.fields[t].format="image",s.push(t))}),s.length>0){const e=[];return Object.entries(o.mapping).forEach(t=>{s.forEach(n=>{const s=J.plotThumbnail(t[1][n]).then(e=>{o.mapping[t[0]][n]=e});e.push(s)})}),Promise.all(e).then(()=>o)}return o})}};var je={dropdownFormGroup:function(e,t){const o=m.uuidv4().slice(0,8);e.classed("mb-3",!0).append("div").classed("form-group",!0).classed("form-row",!0).classed("justify-content-end",!0).append("button").classed("btn",!0).classed("btn-sm",!0).classed("btn-outline-primary",!0).classed("dropdown-toggle",!0).attr("data-toggle","collapse").attr("data-target",`#${o}-collapse`).attr("aria-expanded","false").attr("aria-controls",`${o}-collapse`).text(t),e.append("div").classed("collapse",!0).attr("id",`${o}-collapse`).append("div").classed("card",!0).classed("card-body",!0)}};const Re="fieldinput-dialog",qe="Add custom field";const Me={checkbox:()=>()=>!1,text_field:()=>()=>"",template:e=>{const t=(e,t)=>{const n=t.slice(1,-1).split(":");return 1===n.length?e[n[0]]:o.format(n[1])(e[n[0]])},n=e.match(/\{.+?\}/g)||[],s=e.split(/\{.+?\}/g);return e=>{const o=n.slice(),a=s.slice(),l=[a.shift()];for(;o.length;)l.push(t(e,o.shift())),l.push(a.shift());return l.join("").replace(/(?:\r\n|\r|\n)/g,"<br />")}}};function Ae(e,t){const o=he.formValue(e);return!t.map(e=>e.key).includes(o)}function ze(e,t){const o="template"===he.formValue(e.select(".type")),n=he.formValid(e.select(".key")),s=Ae(e.select(".key"),t),a=t.filter(e=>"none"!==m.sortType(e.format)),l=function(e,t){const o=he.formValue(e),n=he.formValid(e),s=o.split(/\{.+?\}/g),a=(o.match(/\{.+?\}/g)||[]).map(e=>e.slice(1,-1)),l=a.some(e=>{const o=e.split(":");return!!t.map(e=>e.key).includes(o[0])&&!(o.length>2)&&(1===o.length||M.isD3Format(o[1]))}),r=s.concat(a).every(e=>!e.includes("{")&&!e.includes("}"));return n&&l&&r}(e.select(".contents"),a);return n&&s&&(!o||l)}var Ne={menuLink:function(e){e.call(B.dropdownMenuModal,qe,Re,"menu-addcheckbox")},body:function(e){const t=e.call(j.submitDialog,Re,qe).select(".modal-body");t.append("div").classed("key",!0).call(he.textBox,"Field key").select(".form-control").attr("required","required"),t.append("div").classed("type",!0).call(Le.selectBox,"Type").call(Le.updateSelectBoxOptions,[{key:"checkbox",name:"Checkbox",format:"checkbox"},{key:"text_field",name:"Text field",format:"text_field"},{key:"template",name:"Template",format:"html"}]).on("change",function(){const t="template"===he.formValue(o.select(this));e.selectAll(".tmpbuild .form-control").property("disabled",!t)});const n=t.append("div").call(je.dropdownFormGroup,"Template builder").select(".card-body");n.append("div").classed("tmpfield",!0).classed("mb-1",!0).call(Le.selectBox,"Field").on("change",function(){const t=Le.selectedRecord(o.select(this)),n=t.d3_format?`:${t.d3_format}`:"";e.select(".notation").call(he.updateReadonlyValue,`{${t.key}${n}}`)}),n.append("div").classed("notation",!0).call(he.readonlyBox,"Notation"),n.append("div").classed("contents",!0).call(he.textareaBox,"Contents",5)},updateBody:function(e,t){e.select(".key").call(he.updateFormValue,"").on("input",function(){const n=he.formValue(o.select(this)),s=Ae(o.select(this),t);s||he.setValidity(o.select(this),!1);const a=s?"Please provide valid field name":`Key '${n}' already exsists`;o.select(this).call(L.updateInvalidMessage,a);const l=ze(e,t);e.select(".submit").property("disabled",!l)}),e.select(".type").call(he.updateFormValue,"checkbox").on("change",function(){const o=ze(e,t);e.select(".submit").property("disabled",!o)});const n=t.filter(e=>"none"!==m.sortType(e.format));e.select(".tmpfield").call(Le.updateSelectBoxOptions,n).call(he.updateFormValue,"index").dispatch("change"),e.select(".contents").call(he.updateFormValue,"").on("input",function(){const o=ze(e,t);e.select(".submit").property("disabled",!o)}),e.select(".submit").property("disabled",!0)},value:function(e){const t=he.formValue(e.select(".key")),o=Le.selectedRecord(e.select(".type")),n=he.formValue(e.select(".contents"));return{field:{key:t,name:t,format:o.format},converter:Me[o.key](n)}}};function Ee(e){const t=he.formValue(e.select(".format")),o=he.formValue(e.select(".source")),n=he.formValue(e.select(".textquery")),s=he.textareaBoxLines(e.select(".areaquery"));return{format:t,source:"dbid"===t?o:null,value:"molfile"===t?s:n}}var He={queryMolGroup:function(e){e.classed("mb-3",!0),e.append("div").classed("format",!0).classed("mb-1",!0).call(Le.selectBox,"Format").call(Le.updateSelectBoxOptions,[{key:"molfile",name:"MDL Molfile"},{key:"dbid",name:"Compound ID"}]).on("change",function(){const t=he.formValue(o.select(this));e.select(".source .form-control").property("disabled","dbid"!==t),e.select(".textquery").property("hidden","dbid"!==t),e.select(".areaquery").property("hidden","molfile"!==t)}),e.append("div").classed("source",!0).classed("mb-1",!0).call(Le.selectBox,"Source");const t=e.append("div").classed("textquery",!0).classed("mb-1",!0).call(he.textBox,"Query");t.select(".form-control").attr("required","required"),t.select(".invalid-feedback").call(L.updateInvalidMessage,"Please provide a valid query");const n=e.append("div").classed("areaquery",!0).classed("mb-1",!0).attr("required","required").call(he.textareaBox,"Query",6,null);n.select(".form-control").attr("required","required"),n.select(".invalid-feedback").call(L.updateInvalidMessage,"Please provide a valid CTAB format text (.sdf or .mol)"),$(function(){$('[data-toggle="popover"]').popover({html:!0,trigger:"focus"})}),e.append("div").classed("form-row",!0).classed("justify-content-end",!0).append("button").classed("preview",!0).attr("data-toggle","popover").attr("data-html","true").attr("data-content",'<div id="previmg"></div>').call(B.menuButton,"Structure preview","primary").on("click",function(){const t=Ee(e);return c.get("strprev",t).then(c.text).then(e=>o.select("#previmg").html(e),c.error)})},updateQueryMolResources:function(e,t){const o=t.map(e=>({key:e.id,name:e.name}));e.select(".source").call(Le.updateSelectBoxOptions,o)},updateQueryMolValues:function(e,t){e.select(".format").call(he.updateFormValue,t.format).dispatch("change"),e.select(".source").call(he.updateFormValue,t.source),e.select(".textquery").call(he.updateFormValue,"dbid"===t.format?t.value:null),e.select(".areaquery").call(he.updateFormValue,"molfile"===t.format?t.value:null)},queryMolValues:Ee,queryMolValid:function(e){const t=he.formValue(e.select(".format")),o=he.formValid(e.select(".textquery")),n=he.textareaValid(e.select(".areaquery"));return"molfile"===t?n:o},simOptionGroup:function(e){const t=e.append("div").call(je.dropdownFormGroup,"Optional parameters").select(".card-body");t.append("div").classed("ignoreh",!0).classed("mb-1",!0).call(he.checkBox,"Ignore explicit hydrogens");const o=t.append("div").classed("timeout",!0).classed("mb-1",!0).call(he.numberBox,"Timeout").call(he.updateNumberRange,1,999,1);o.select(".form-control").attr("required","required"),o.select(".invalid-feedback").call(L.updateInvalidMessage,"Please provide a valid number (1 to 999)");const n=t.append("div").classed("diam",!0).classed("mb-1",!0).call(he.numberBox,"Diameter (MCS-DR/GLS)").call(he.updateNumberRange,4,999,1);n.select(".form-control").attr("required","required"),n.select(".invalid-feedback").call(L.updateInvalidMessage,"Please provide a valid number (4 to 999)"),t.selectAll("label.col-form-label").classed("col-4",!1).classed("col-6",!0),t.selectAll("input.form-control").classed("col-8",!1).classed("col-6",!0)},updateSimOptionValues:function(e,t){e.select(".ignoreh").call(he.updateCheckBox,t.ignoreHs),t.hasOwnProperty("timeout")&&e.select(".timeout").call(he.updateFormValue,t.timeout),t.hasOwnProperty("diameter")&&e.select(".diam").call(he.updateFormValue,t.diameter)},simOptionValues:function(e){const t=e.select(".timeout"),o=e.select(".diam"),n={ignoreHs:he.checkBoxValue(e.select(".ignoreh"))};return t.select(".form-control").property("disabled")||(n.timeout=he.formValue(t)),o.select(".form-control").property("disabled")||(n.diameter=he.formValue(o)),n},simOptionValid:function(e){const t=he.formValid(e.select(".timeout")),o=he.formValid(e.select(".diam"));return t&&o}};const Ue="networkgen-dialog",We="Generate similarity network";function Ge(e){const t=he.formValid(e.select(".thld")),o=He.simOptionValid(e.select(".option"));return t&&o}var Je={menuLink:function(e){e.call(B.dropdownMenuModal,We,Ue,"menu-network")},body:function(e){const t=e.call(j.submitDialog,Ue,We).select(".modal-body");t.append("div").classed("measure",!0).call(Le.selectBox,"Measure").on("change",function(){const t=he.formValue(o.select(this));e.select(".diam input").property("disabled","gls"!==t),e.select(".timeout input").property("disabled",!["gls","rdfmcs"].includes(t))});const n=t.append("div").classed("thld",!0).call(he.numberBox,"Threshold").call(he.updateNumberRange,.01,1,.01).on("input",function(){const t=Ge(e);e.select(".submit").property("disabled",!t)});n.select(".form-control").attr("required","required"),n.select(".invalid-feedback").call(L.updateInvalidMessage,"Please provide a valid number (0.01 to 1.00)"),t.append("div").classed("option",!0).call(He.simOptionGroup).on("input",function(){const t=Ge(e);e.select(".submit").property("disabled",!t)})},updateBody:function(e,t){const o=[{key:"gls",name:"Graph-based local similarity(GLS)"}];t&&(o.push({key:"rdmorgan",name:"RDKit Morgan similarity"}),o.push({key:"rdfmcs",name:"RDKit FMCS"})),e.select(".measure").call(Le.updateSelectBoxOptions,o).call(he.updateFormValue,"gls"),e.select(".thld").call(he.updateFormValue,.5),e.select(".option").call(He.updateSimOptionValues,{ignoreHs:!0,timeout:2,diameter:8})},execute:function(e,t){const o=e.select(".measure"),n=e.select(".thld"),s=He.simOptionValues(e.select(".option"));o.select("select").property("disabled")||(s.measure=he.formValue(o)),n.select("input").property("disabled")||(s.threshold=he.formValue(n));const a=new FormData;return a.append("params",JSON.stringify(s)),a.append("contents",new Blob([JSON.stringify(t)])),c.post(`${s.measure}net`,a).then(c.json)}};const Qe="rename-dialog",Ke="Rename";var Ze={menuLink:function(e){e.call(B.dropdownMenuModal,Ke,Qe,"menu-edittext")},body:function(e){const t=e.call(j.submitDialog,Qe,Ke).select(".modal-body").append("div").classed("rename",!0).call(he.textBox,"New name");t.select(".form-control").attr("required","required"),t.select(".invalid-feedback").call(L.updateInvalidMessage,"Please provide a valid name")},updateBody:function(e,t){e.select(".rename").call(he.updateFormValue,t).on("input",function(){const t=he.formValid(o.select(this));e.select(".submit").property("disabled",!t)}).dispatch("input")},value:function(e){return he.formValue(e.select(".rename"))}};function Xe(e){o.select("title").text(e.name),o.select("#menubar").selectAll(".refresh, .abort").style("display",e.rows.ongoing()?null:"none"),o.select("#menubar .name").text(e.name);const t=o.select("#menubar .loading-circle"),n=e.rows.status(),s="done"===n?n:`${n} ${e.rows.progress()}%`;o.select("#menubar .rows-count").call(L.updateBadge,`${e.rows.size()} rows`,"light","table-gray").select(".text").style("color","gray"),o.select("#menubar .fetch-status").call(L.updateBadge,s,"light",{done:"check-green",running:"running-darkorange",ready:"clock-cornflowerblue",queued:"clock-cornflowerblue",interrupted:"caution-salmon",aborted:"caution-salmon",failure:"caution-salmon"}[n]).select(".text").style("color",{done:"green",running:"darkorange",ready:"cornflowerblue",queued:"cornflowerblue",interrupted:"salmon",aborted:"salmon",failure:"salmon"}[n]),o.select("#menubar .exec-time").call(L.updateBadge,`${e.rows.execTime()} seconds`,"light","clock-cornflowerblue").select(".text").style("color","cornflowerblue");const a=o.select("#dialogs");return a.select(".fieldconfd").call(xe.updateBody,e.rows.fields).on("submit",function(){const t=xe.value(o.select(this));return e.updateFields(t),e.updateContentsNotifier(),Xe(e)}),a.select(".fieldfiled").call(Pe.updateBody,e.visibleFields).on("submit",function(){return Pe.readFile(o.select(this)).then(t=>(e.joinFields(t),e.updateContentsNotifier(),Xe(e)))}),a.select(".fieldinputd").call(Ne.updateBody,e.rows.fields).on("submit",function(){const t=Ne.value(o.select(this));return e.rows.addField(t.field),e.rows.apply(e=>{e[t.field.key]=t.converter(e)}),e.updateContentsNotifier(),Xe(e)}),a.select(".renamed").call(Ze.updateBody,e.name).on("submit",function(){return e.name=Ze.value(o.select(this)),Xe(e)}),c.serverStatus().then(n=>{a.select(".fieldfetchd").call(Te.updateBody,n.schema,e.rows.fields).on("submit",function(){const t=e.rows.records().map(e=>e.compound_id);return Te.execute(o.select(this),t,n.schema).then(t=>(e.joinFields(t),e.updateContentsNotifier(),Xe(e)))}),a.select(".netgend").call(Je.updateBody,n.server.rdkit).on("submit",function(){return Je.execute(o.select(this),e.rows.records()).then(t=>_.newNetwork(e.instance,e.rows.collectionID,e.name,t)).then(o=>{t.style("display","none"),window.open(`network.html?instance=${e.instance}&view=${o}`,"_blank")})}),a.select(".abortd").call(j.updateConfirmDialog,"Are you sure you want to abort this calculation job?").on("submit",function(){return e.rows.abort().then(()=>(e.updateContentsNotifier(),Xe(e)))})}).catch(()=>{o.select("#menubar").selectAll(".online-command").attr("data-target",null).classed("disabled",!0).on("click",null)}).finally(()=>{t.style("display","none")})}return{run:function(){const e=a.compatibility();if(e)return void o.select("body").style("color","#ff0000").text(e);document.location.protocol,"onLine"in navigator&&navigator.onLine,a.registerServiceWorker();const t=a.URLQuery().instance||null,n=a.URLQuery().view||null;return _.getView(t,n).then(e=>{if(!e)throw"ERROR: invalid URL";return e.instance=t,_.getCollection(t,e.rows).then(n=>{n.instance=t,function(e,t){const n=o.select("#menubar").classed("my-1",!0);n.selectAll("div,span,a").remove();const s=o.select("#dialogs");s.selectAll("div").remove();const a=new ie(e,t),l=n.append("div").call(B.dropdownMenuButton,"Menu","primary","table-white").select(".dropdown-menu");l.append("a").call(xe.menuLink),l.append("a").classed("online-command",!0).call(Te.menuLink),l.append("a").call(Pe.menuLink),l.append("a").call(Ne.menuLink),l.append("a").call(B.dropdownMenuItem,"Generate tile view","menu-tiles").on("click",function(){o.select("#menubar .loading-circle").style("display","inline-block");const e=m.uuidv4().slice(0,8);return _.appendView(a.instance,a.viewID,{$schema:"https://mojaie.github.io/kiwiii/specs/tile_v1.0.json",viewID:e,name:`${a.name}_tiles`,viewType:"tile",items:a.rows.collectionID,rowCount:5,columnCount:5,tileContent:{field:"structure",visible:!0}}).then(()=>{o.select("#menubar .loading-circle").style("display","none"),window.open(`tile.html?instance=${a.instance}&view=${e}`,"_blank")})}),l.append("a").classed("online-command",!0).call(Je.menuLink),l.append("a").call(Ze.menuLink),l.append("a").call(B.dropdownMenuItem,"Save","menu-save").on("click",function(){return a.save().then(()=>n.select(".notify-saved").call(L.notify))}),l.append("a").classed("online-command",!0).call(B.dropdownMenuItem,"Download Excel","menu-exportexcel").on("click",()=>{o.select("#menubar .loading-circle").style("display","inline-block");const e=a.rows.export(),t=new FormData;return t.append("contents",new Blob([JSON.stringify(e)])),c.post("xlsx",t).then(c.blob).then(e=>{o.select("#menubar .loading-circle").style("display","none"),f.downloadDataFile(e,`${a.name}.xlsx`)})}),n.append("a").call(B.menuButtonLink,"Dashboard","outline-secondary","status-gray").attr("href","dashboard.html").attr("target","_blank"),n.append("a").classed("refresh",!0).call(B.menuButtonLink,"Refresh","outline-secondary","refresh-gray").on("click",function(){return o.select("#menubar .loading-circle").style("display","inline-block"),a.rows.pull().then(()=>(a.updateContentsNotifier(),Xe(a)))}),n.append("a").classed("abort",!0).call(B.menuButtonLink,"Abort server job","warning","delete-gray").attr("data-toggle","modal").attr("data-target","#abort-dialog"),n.append("span").classed("loading-circle",!0).call(L.loadingCircle),n.append("span").classed("notify-saved",!0).call(L.alert).call(L.updateAlert,"State saved","success","check-green").style("display","none"),n.append("span").classed("name",!0),n.append("span").classed("rows-count",!0).call(L.badge),n.append("span").classed("fetch-status",!0).call(L.badge),n.append("span").classed("exec-time",!0).call(L.badge),s.append("div").classed("fieldconfd",!0).call(xe.body),s.append("div").classed("fieldfetchd",!0).call(Te.body),s.append("div").classed("fieldfiled",!0).call(Pe.body),s.append("div").classed("fieldinputd",!0).call(Ne.body),s.append("div").classed("netgend",!0).call(Je.body),s.append("div").classed("renamed",!0).call(Ze.body),s.append("div").classed("abortd",!0).call(j.confirmDialog,"abort-dialog"),o.select("#dg-search").call(ye.setFilter,a),o.select("#datagrid").call(ge.setSort,a).call(G.datagrid,a),window.onresize=(()=>{o.select("#datagrid").call(G.resize,a).call(G.updateViewport,a,a.viewportTop)}),a.updateContentsNotifier(),Xe(a)}(e,n)})}).catch(e=>{console.error(e),o.select("#datagrid").style("color","red").text(e)})}}});
//# sourceMappingURL=datagridApp.js.map
