// https://github.com/mojaie/kiwiii Version 1.0.0-alpha.6. Copyright 2018 Seiji Matsuoka.
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("d3"),require("pako"),require("vega")):"function"==typeof define&&define.amd?define(["lodash","d3","pako","vega"],t):e.dashboardApp=t(e._,e.d3,e.pako,e.vega)}(this,function(e,t,s,n){"use strict";const o=!1,a="1.0.0-alpha.6";e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,s=s&&s.hasOwnProperty("default")?s.default:s,n=n&&n.hasOwnProperty("default")?n.default:n;var l={URLQuery:function(){const t=window.location.search.substring(1).split("&").map(e=>e.split("="));return e.fromPairs(t)},compatibility:function(){if(!window.indexedDB)return"Client compatibility error: IndexedDB not supported"},registerServiceWorker:function(){"serviceWorker"in navigator?o?console.info("Service worker is disabled for debugging"):window.addEventListener("load",()=>{navigator.serviceWorker.register("../sw.js")}):console.info("Service worker is not supported")},registerCtrlCommand:function(e,t){document.addEventListener("keydown",s=>{s.ctrlKey&&s.key===e&&t()})}};var r={sortType:function(e){return["numeric","d3_format"].includes(e)?"numeric":["text","compound_id","assay_id","list"].includes(e)?"text":["text_field","checkbox","html"].includes(e)?"html":"none"},formatNum:function(e,s){return void 0===e||null===e||Number.isNaN(e)?"":e==parseFloat(e)?t.format(s)(e):e},partialMatch:function(e,t){return void 0!==t&&null!==t&&""!==t&&-1!==t.toString().toUpperCase().indexOf(e.toString().toUpperCase())},uuidv4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}};const i={Queued:"ready","In progress":"running",Aborting:"running",Aborted:"aborted",Completed:"done",Failure:"failure"},c={datatable:"nodes",connection:"edges"};function d(e){const t=e.columns.map(e=>("numeric"===e.sort?e.format="numeric":"text"===e.sort?e.format="text":"none"===e.sort&&(e.format="raw"),e));return{id:e.id,name:e.name,dataType:c[e.format],schemaVersion:.8,revision:0,status:i[e.status],fields:t,records:e.records,query:e.query,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate}}function u(e){return{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:e.query,progress:e.progress,execTime:e.execTime,created:e.created,reference:{}}}function p(e){let s=e;return s.edges.hasOwnProperty("schemaVersion")||s.edges.hasOwnProperty("$schema")||(s.nodes=d(s.nodes),s.edges=function(e,t){const s={fieldTransform:e.snapshot.fieldTransform,nodePositions:e.snapshot.nodePositions,nodeColor:{},nodeSize:{},nodeLabel:{},edge:{}};return e.snapshot.hasOwnProperty("nodeColor")?(s.nodeColor.id=e.snapshot.nodeColor.id,s.nodeColor.scale=e.snapshot.nodeColor.scale,s.nodeColor.field=t.find(t=>t.key===e.snapshot.nodeColor.column)):s.nodeColor={id:"color",field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeSize")?(s.nodeSize.id=e.snapshot.nodeSize.id,s.nodeSize.scale=e.snapshot.nodeSize.scale,s.nodeSize.field=t.find(t=>t.key===e.snapshot.nodeSize.column)):s.nodeSize={id:"size",field:t[0],scale:{scale:"linear",domain:[0,1],range:[20,20],unknown:20}},e.snapshot.hasOwnProperty("nodeLabel")?(s.nodeLabel.id=e.snapshot.nodeLabel.id,s.nodeLabel.size=e.snapshot.nodeLabel.size,s.nodeLabel.text=e.snapshot.nodeLabel.text,s.nodeLabel.visible=e.snapshot.nodeLabel.visible,s.nodeLabel.scale=e.snapshot.nodeLabel.scale,s.nodeLabel.field=t.find(t=>t.key===e.snapshot.nodeLabel.column)):s.nodeLabel={id:"label",size:12,text:"index",visible:!1,field:t[0],scale:{scale:"linear",domain:[0,1],range:["black","white"],unknown:"gray"}},e.snapshot.hasOwnProperty("nodeContent")?s.nodeContent=e.snapshot.nodeContent:s.nodeContent={structure:{visible:!1}},e.snapshot.hasOwnProperty("edge")?s.edge=e.snapshot.edge:s.edge={id:"label",label:{size:10,visible:!1},visible:!0,scale:{scale:"linear",domain:[0,1],range:[5,5],unknown:5}},{id:e.id,name:e.name,dataType:c[e.format],schemaVersion:.8,revision:0,reference:{nodes:e.nodeTableId},status:i[e.status],fields:[{key:"source"},{key:"target"},{key:"weight"}],records:e.records,query:e.query,networkThreshold:e.networkThreshold,taskCount:e.searchCount,doneCount:e.searchDoneCount|e.searchCount,resultCount:e.recordCount,progress:100|e.progress,execTime:e.execTime,created:e.startDate|e.responseDate,snapshot:s}}(s.edges,s.nodes.fields)),"0.8"!=s.edges.schemaVersion&&.1!==s.edges.schemaVersion||((s=function(e){if(e.edges.hasOwnProperty("reference")||(e.edges.reference={nodes:e.edges.nodesID}),e.nodes.fields.find(e=>"_index"===e.key)){const t={};e.nodes.records.forEach((e,s)=>{e.index=s,e.structure=e._structure,t[e._index]=e.index,delete e._index,delete e._structure}),e.edges.records.forEach(e=>{e.source=t[e.source],e.target=t[e.target]}),e.nodes.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")})}return e}(s)).nodes=u(s.nodes),s.edges=function(e){const s={networkThreshold:e.networkThreshold};return s.nodeContentVisible=e.snapshot.nodeContent.structure.visible,s.nodeColor=e.snapshot.nodeColor.scale||{},s.nodeColor.field&&(s.nodeColor.field=e.snapshot.nodeColor.field.key,"_index"===s.nodeColor.field&&(s.nodeColor.field="index")),"ordinal"===s.nodeColor.scale&&(s.nodeColor.range=t.schemeCategory20),s.nodeSize=e.snapshot.nodeSize.scale||{},e.snapshot.nodeSize.field&&(s.nodeSize.field=e.snapshot.nodeSize.field.key,"_index"===s.nodeSize.field&&(s.nodeSize.field="index")),s.nodeLabel={},e.snapshot.nodeLabel.text&&(s.nodeLabel.text=e.snapshot.nodeLabel.text.key,"_index"===s.nodeLabel.text&&(s.nodeLabel.text="index")),s.nodeLabel.size=e.snapshot.nodeLabel.size,s.nodeLabel.visible=e.snapshot.nodeLabel.visible,s.nodeLabelColor=e.snapshot.nodeLabel.scale||{},e.snapshot.nodeLabel.field&&(s.nodeLabelColor.field=e.snapshot.nodeLabel.field.key,"_index"===s.nodeLabelColor.field&&(s.nodeLabelColor.field="index")),"ordinal"===s.nodeLabelColor.scale&&(s.nodeLabelColor.range=t.schemeCategory20),s.edgeVisible=e.snapshot.edge.visible,s.edgeWidth=e.snapshot.edge.scale||{},s.edgeLabel={},s.edgeLabel.size=e.snapshot.edge.label.size,s.edgeLabel.visible=e.snapshot.edge.label.visible,s.networkThreshold=e.networkThreshold||e.query.threshold,s.coords=e.snapshot.nodePositions,{id:e.id,name:e.name,dataType:e.dataType,schemaVersion:"0.10",revision:e.revision,status:e.status,fields:e.fields,records:e.records,query:{params:e.query},progress:e.progress,execTime:e.execTime,created:e.created,snapshot:s,reference:e.reference}}(s.edges)),s.edges.hasOwnProperty("$schema")||(delete s.nodes.schemaVersion,delete s.edges.schemaVersion,delete s.nodes.revision,delete s.edges.revision,s.nodes.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json",s.edges.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),s}var m={convertPackage:function(e){let t={};if(e.hasOwnProperty("views"))t=e;else{const s=new Date,n=e.hasOwnProperty("edges"),o=n?p(e):function(e){let t=e;return t.hasOwnProperty("schemaVersion")||t.hasOwnProperty("$schema")||(t=d(t)),"0.8"==t.schemaVersion&&(t=u(t=function(e){return e.records.forEach((e,t)=>{e.index=t,e.structure=e._structure,delete e._index,delete e._structure}),e.fields.forEach(e=>{"_index"===e.key&&(e.key="index"),"_structure"===e.key&&(e.key="structure"),"numeric"===e.sort&&(e.format="numeric"),"text"===e.sort&&(e.format="text"),"none"===e.sort&&(e.format="raw")}),e}(t))),t.hasOwnProperty("$schema")||(delete t.schemaVersion,delete t.revision,t.$schema="https://mojaie.github.io/flashflood/_static/specs/job_result_v1.0.json"),t.fields.forEach(e=>{"structure"===e.key&&(e.format="svg"),delete e.width,delete e.height}),t}(e),a=n?o.nodes:o;(t={$schema:"https://mojaie.github.io/kiwiii/specs/package_v1.0.json",name:o.edges.name,views:[],dataset:[]}).dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:a.id,name:a.name,contents:[{$schema:a.$schema,workflowID:a.reference.workflow,name:a.name,fields:a.fields,records:a.records,created:a.created,status:a.status,query:a.query,execTime:a.execTime,progress:a.progress}]}),t.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:a.id,name:a.name,viewType:"datagrid",rows:a.id,fields:a.fields,sortOrder:null,filterText:null,checkpoints:[{type:"convert",date:s.toString(),description:"converted from legacy format"}]}),n&&(t.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:o.edges.id,name:o.edges.name,contents:[{$schema:o.edges.$schema,workflowID:o.edges.reference.workflow,name:o.edges.name,fields:o.edges.fields,records:o.edges.records,created:o.edges.created,status:o.edges.status,query:o.edges.query,execTime:o.edges.execTime,progress:o.edges.progress}]}),t.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:o.edges.id,name:o.edges.name,viewType:"network",nodes:a.id,edges:o.edges.id,nodeColor:o.edges.snapshot.nodeColor,nodeSize:o.edges.snapshot.nodeSize,nodeLabel:o.edges.snapshot.nodeLabel,nodeLabelColor:o.edges.snapshot.nodeLabelColor,edgeWidth:o.edges.snapshot.edgeWidth,edgeLabel:o.edges.snapshot.edgeLabel,networkThreshold:o.edges.snapshot.networkThreshold,networkThresholdCutoff:o.edges.snapshot.networkThresholdCutoff,fieldTransform:o.edges.snapshot.fieldTransform,coords:o.edges.snapshot.coords,checkpoints:[{type:"convert",date:s.toString(),description:"converted from legacy format"}]})),t.views.filter(e=>"network"===e.viewType).forEach(e=>{e.minConnThld=e.networkThresholdCutoff,e.currentConnThld=e.networkThreshold,e.hasOwnProperty("nodeLabel")&&(e.nodeLabel.field=e.nodeLabel.text),e.hasOwnProperty("edgeLabel")&&(e.edgeLabel.field="weight"),e.hasOwnProperty("edgeWidth")&&(e.edgeWidth.field="weight")})}return t.views.filter(e=>"network"===e.viewType).forEach(e=>{e.nodeColor.field||(e.nodeColor.field="index"),e.nodeSize.field||(e.nodeSize.field="index"),e.nodeLabel.field||(e.nodeLabel.field="index"),e.nodeLabelColor.field||(e.nodeLabelColor.field="index"),e.edgeColor?e.edgeColor.field||(e.edgeColor.field="weight"):e.edgeColor={field:"weight",color:"monogray",scale:"linear",domain:[0,1],range:["#999999","#999999"],unknown:"#cccccc"},e.edgeWidth.field||(e.edgeWidth.field="weight"),e.edgeLabel.field||(e.edgeLabel.field="weight"),e.edgeLabelColor?e.edgeLabelColor.field||(e.edgeLabelColor.field="weight"):e.edgeLabelColor={field:"weight",color:"monoblack",scale:"linear",domain:[1,1],range:["#333333","#333333"],unknown:"#cccccc"}}),t}};function h(e,t,s){return new Promise((n,o)=>{const a=window.indexedDB.open(e,t);a.onsuccess=function(){n(this.result)},a.onerror=(e=>o(e)),a.onupgradeneeded=(e=>{s(e.currentTarget.result)})})}const f={pkgs:h("Packages",2,e=>{e.createObjectStore("Packages",{keyPath:"id"})}),assets:h("Assets",1,e=>{e.createObjectStore("Assets",{keyPath:"key"})})};function g(e){return new Promise((t,s)=>f[e].then(e=>{const n=e.transaction(e.name,"readwrite").objectStore(e.name).clear();n.onsuccess=(()=>t()),n.onerror=(e=>s(e))}))}function y(){return new Promise(e=>{const t=[];return f.pkgs.then(s=>{s.transaction(s.name).objectStore(s.name).openCursor().onsuccess=(s=>{const n=s.target.result;n?(t.push(n.value),n.continue()):e(t)})})})}function b(e){return new Promise((t,s)=>f.pkgs.then(n=>{const o=n.transaction(n.name).objectStore(n.name).get(e);o.onsuccess=(e=>t(e.target.result)),o.onerror=(e=>s(e))}))}function w(e){return new Promise((t,s)=>f.pkgs.then(n=>{const o=n.transaction(n.name,"readwrite").objectStore(n.name).put(e);o.onerror=(e=>s(e)),o.onsuccess=(()=>t())}))}function v(e,t){return new Promise((s,n)=>f.pkgs.then(o=>{const a=o.transaction(o.name,"readwrite").objectStore(o.name),l=a.get(e);l.onerror=(e=>n(e)),l.onsuccess=(e=>{const o=e.target.result;t(o);const l=a.put(o);l.onsuccess=(()=>s()),l.onerror=(e=>n(e))})}))}var x={clear:g,clearAll:function(){return Promise.all([g("pkgs"),g("assets")])},getAllItems:y,getItem:b,updateItem:v,deleteItem:function(e){return new Promise((t,s)=>f.pkgs.then(n=>{const o=n.transaction(n.name,"readwrite").objectStore(n.name).delete(e);o.onerror=(e=>s(e)),o.onsuccess=(()=>t())}))},getView:function(e,t){return b(e).then(e=>e.views.find(e=>e.viewID===t))},appendView:function(e,t,s){return v(e,e=>{const n=e.views.findIndex(e=>e.viewID===t);e.views.splice(n+1,0,s)})},updateView:function(t,s,n){return v(t,t=>{const o=t.views.findIndex(e=>e.viewID===s);e.isFunction(n)?n(t.views[o]):t.views[o]=n})},deleteView:function(e,t){return v(e,e=>{const s=e.views.findIndex(e=>e.viewID===t);e.views.splice(s,1);const n={};e.dataset.forEach(e=>{n[e.collectionID]=0}),e.views.forEach(e=>{["rows","items","nodes","edges"].filter(t=>e.hasOwnProperty(t)).forEach(t=>{n[e[t]]+=1})}),Object.entries(n).forEach(t=>{if(!t[1]){const s=e.dataset.findIndex(e=>e.collectionID===t[0]);e.dataset.splice(s,1)}})})},getAllCollections:function(){return y().then(t=>e.flatten(t.map(e=>e.dataset.map(t=>(t.instance=e.id,t)))))},getCollection:function(e,t){return b(e).then(e=>e.dataset.find(e=>e.collectionID===t))},addCollection:function(e,t,s){return v(e,e=>{e.dataset.push(s)})},updateCollection:function(t,s,n){return v(t,t=>{const o=t.dataset.findIndex(e=>e.collectionID===s);e.isFunction(n)?n(t.dataset[o]):t.dataset[o]=n})},importItem:function(e){e=m.convertPackage(e);const t=new Date;return e.id=r.uuidv4().slice(0,8),e.sessionStarted=t.toString(),w(e)},newDatagrid:function(e){const t=(new Date).toLocaleString("en-GB",{timeZone:"Asia/Tokyo"}),s=r.uuidv4().slice(0,8),n=r.uuidv4().slice(0,8),o=e.workflowID.slice(0,8);return w({$schema:"https://mojaie.github.io/kiwiii/specs/package_v1.0.json",id:s,name:e.name,views:[{$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:n,name:e.name,viewType:"datagrid",rows:o,checkpoints:[{type:"creation",date:t}]}],dataset:[{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:o,name:e.name,contents:[e]}],sessionStarted:t}).then(()=>({instance:s,viewID:n}))},addDatagrid:function(e,t){const s=r.uuidv4().slice(0,8),n=t.workflowID.slice(0,8);return v(e,e=>{e.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:s,name:t.name,viewType:"datagrid",rows:n}),e.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:n,name:t.name,contents:[t]})}).then(()=>s)},add384Tiles:function(e,t){const s=r.uuidv4().slice(0,8),n=t.workflowID.slice(0,8);return v(e,e=>{e.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/tile_v1.0.json",viewID:s,name:`${t.name}_tiles`,viewType:"tile",items:n,rowCount:16,columnCount:24,chunksPerRow:10}),e.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:n,name:t.name,contents:[t]})}).then(()=>s)},newNetwork:function(e,t,s,n){const o=r.uuidv4().slice(0,8),a=n.workflowID.slice(0,8);return v(e,e=>{e.views.push({$schema:"https://mojaie.github.io/kiwiii/specs/network_v1.0.json",viewID:o,name:`${s}_${n.name}`,viewType:"network",nodes:t,edges:a,minConnThld:n.query.params.threshold}),e.dataset.push({$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:a,name:n.name,contents:[n]})}).then(()=>o)},getAsset:function(e){return new Promise((t,s)=>f.assets.then(n=>{const o=n.transaction(n.name).objectStore(n.name).get(e);o.onsuccess=(e=>{const s=void 0===e.target.result?void 0:e.target.result.value;t(s)}),o.onerror=(e=>s(e))}))},putAsset:function(e,t){return new Promise((s,n)=>f.assets.then(o=>{const a=o.transaction(o.name,"readwrite").objectStore(o.name).put({key:e,value:t});a.onerror=(e=>n(e)),a.onsuccess=(()=>s())}))}};const k="../req/";function V(e,t={}){const s=Object.keys(t).length?`?query=${JSON.stringify(t)}`:"";return fetch(`${k}${e}${s}`,{credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))}function C(e){return e.json()}var D={get:V,json:C,text:function(e){return e.text()},blob:function(e){return e.blob()},post:function(e,t){return fetch(`${k}${e}`,{method:"POST",body:t,credentials:"include"}).then(e=>200!==e.status?Promise.reject(new Error(e.statusText)):Promise.resolve(e))},error:function(e){return console.error(e),null},serverStatus:function(){const e={};return V("server").then(C).then(t=>{e.server=t}).then(()=>V("schema")).then(C).then(t=>{e.schema=t}).then(()=>e)},batchRequest:function(e,t){const s=e.map((e,s)=>new Promise(n=>{setTimeout(()=>n(e()),s*t*1e3)}));return Promise.all(s)}};function I(e){const t={};return Object.entries(e.mapping).forEach(e=>{t[e[0]]=[e[1]]}),{created:e.created,fields:[e.field],key:e.key,mapping:t}}var S={singleToMulti:I,mappingToTable:function(e){const t=e.hasOwnProperty("field")?I(e):e;return{fields:[{key:t.key,format:"text"}].concat(t.fields),records:Object.entries(t.mapping).map(e=>{const s={};return s[t.key]=e[0],t.fields.forEach((t,n)=>{s[t.key]=e[1][n]}),s})}},tableToMapping:function(e,t,s=["index"]){const n={created:(new Date).toString(),fields:e.fields.filter(e=>e.key!==t).filter(e=>!s.includes(e.key)),key:t,mapping:{}};return e.records.forEach(e=>{n.mapping[e[t]]=n.fields.map(t=>e[t.key])}),n},csvToMapping:function(e){const t=e.split(/\n|\r|\r\n/),s=t.shift().split(","),n=s.shift(),o=new Date,a=[],l=[];s.forEach((e,t)=>{""!==e&&(a.push(t),l.push({key:e,format:"text"}))});const r={created:o.toString(),fields:l,key:n,mapping:{}};return t.forEach(e=>{const t=e.split(","),s=t.shift();r.mapping[s]=Array(a.length),a.forEach(e=>{r.mapping[s][e]=t[e]})}),r},apply:function(t,s){const n=s.hasOwnProperty("field")?I(s):s;t.records.filter(e=>n.mapping.hasOwnProperty(e[n.key])).forEach(e=>{n.fields.forEach((t,s)=>{e[t.key]=n.mapping[e[n.key]][s]})}),t.fields=e(t.fields).concat(n.fields).uniqBy("key").value()}};class B{constructor(e){this.autoIndex="index",this.collectionID=e.collectionID||null,this.instance=e.instance||null,this.name=e.name||null,e.records?(this.contents=[e],this.fields=[]):(this.contents=e.contents,this.fields=e.fields||[]),this.contents.forEach(e=>{e.fields.forEach(e=>this.addField(e))})}addField(e){this.fields.find(t=>t.key===e.key)||(e.hasOwnProperty("name")||(e.name=e.key),e.hasOwnProperty("visible")||(e.visible=!0),e.hasOwnProperty("d3_format")&&(e.format="d3_format"),e.hasOwnProperty("format")||(e.format="raw"),this.fields.push(e))}updateFields(e){this.fields=[],e.forEach(e=>this.addField(e))}joinFields(e){this.contents.forEach(t=>{S.apply(t,e)}),e.hasOwnProperty("fields")?e.fields.forEach(e=>this.addField(e)):this.addField(e.field)}apply(e){this.contents.forEach(t=>{t.records.forEach(t=>{e(t)})})}records(){return e.flatten(this.contents.map(e=>e.records))}fetch(e){const t=this.contents.filter(e=>["running","ready","interrupted","queued"].includes(e.status)).map(t=>{const s={id:t.workflowID,command:e};return D.get("progress",s).then(D.json).then(e=>x.updateCollection(this.instance,this.collectionID,t=>{const n=t.contents.findIndex(e=>e.workflowID===s.id);"failure"===e.status?t.contents[n].status="failure":t.contents[n]=e}))});return Promise.all(t).then(()=>x.getCollection(this.instance,this.collectionID)).then(e=>{this.contents=e.contents})}pull(){return this.fetch("pull")}abort(){return this.fetch("abort")}size(){return e.sum(this.contents.map(e=>e.records.length))}status(){return this.contents.some(e=>"interrupted"===e.status)?"interrupted":this.contents.some(e=>"running"===e.status)?"running":this.contents.some(e=>"queued"===e.status)?"queued":this.contents.some(e=>"ready"===e.status)?"ready":this.contents.some(e=>"aborted"===e.status)?"aborted":this.contents.some(e=>"failure"===e.status)?"failure":"done"}ongoing(){return["ready","queued","running","interrupted"].includes(this.status())}progress(){return e.min(this.contents.map(e=>e.progress))}execTime(){return e.sum(this.contents.map(e=>e.execTime))}export(){return{$schema:"https://mojaie.github.io/kiwiii/specs/collection_v1.0.json",collectionID:this.collectionID,name:this.name,fields:this.fields,contents:this.contents}}}function F(e,t,s){return new Promise((n,o)=>{const a=new FileReader,l=t?e.slice(0,t):e;a.onload=(e=>n(e.target.result)),a.onerror=(e=>o(e)),s?a.readAsArrayBuffer(l):a.readAsText(l)})}function T(e,t){const n=t?s.inflate(e,{to:"string"}):e;return JSON.parse(n)}function q(e,t){try{const s=window.URL.createObjectURL(new Blob([e])),n=document.createElement("a");n.download=t,n.href=s,n.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}))}catch(e){}}var O={readFile:F,parseJSON:T,loadJSON:function(e){const t=e.name.endsWith("c")||e.name.endsWith(".gz");return F(e,!1,t).then(e=>T(e,t))},fetchJSON:function(e){const t=decodeURIComponent(e),s=t.endsWith("c")||t.endsWith(".gz");return fetch(t).then(e=>s?e.arrayBuffer():e.json()).then(e=>T(e,s))},downloadDataFile:q,downloadJSON:function(e,t,n=!0){const o=JSON.stringify(e);q(n?s.gzip(o):o,`${t}${`.ap${n?"c":"r"}`}`)}};var L={isRunning:function(e){return e.dataset.some(e=>e.contents.some(e=>["ready","queued","running","interrupted"].includes(e.status)))}};const P="../assets/",j="../assets/icon/";var R={badge:function(e){e.classed("badge",!0),e.append("img").classed("icon",!0).style("width","1.25rem").style("height","1.25rem"),e.append("span").classed("text",!0)},updateBadge:function(e,t,s,n){e.classed(`badge-${s}`,!0),e.select(".icon").attr("src",n?`${j}${n}.svg`:null),e.select(".text").text(t)},notify:function(e){e.style("opacity",0).style("display","inline").transition().duration(500).ease(t.easeLinear).style("opacity",1).transition().delay(3e3).duration(1e3).ease(t.easeLinear).style("opacity",0).on("end",function(){e.style("display","none")})},loadingCircle:function(e){e.style("display","none").append("img").attr("src",`${P}loading1.gif`).style("width","2rem").style("height","2rem")},alert:function(e){e.classed("alert",!0).classed("px-1",!0).classed("py-0",!0),e.append("img").classed("icon",!0).style("width","1.25rem").style("height","1.25rem"),e.append("span").classed("text",!0).style("font-size","75%")},updateAlert:function(e,t,s,n){e.classed(`alert-${s}`,!0),e.select(".icon").attr("src",n?`${j}${n}.svg`:null),e.select(".text").text(t)},invalidFeedback:function(e){e.classed("invalid-feedback",!0).style("display","none"),e.append("img").classed("icon",!0).attr("src",`${j}caution-salmon.svg`).style("width","1rem").style("height","1rem"),e.append("span").classed("invalid-msg",!0)},updateInvalidMessage:function(e,t){e.select(".invalid-msg").text(t)}};const _="../assets/icon/";var M={iconBaseURL:_,buttonBox:function(e,t,s){e.classed("form-group",!0).classed("mb-1",!0).append("button").classed("btn",!0).classed(`btn-${s}`,!0).classed("btn-sm",!0).text(t)},menuButton:function(e,t,s){e.classed("btn",!0).classed(`btn-${s}`,!0).classed("btn-sm",!0).classed("mr-1",!0).text(t)},menuButtonLink:function(e,t,s,n){e.classed("btn",!0).classed(`btn-${s}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("role","button").attr("href","#"),e.append("img").attr("src",n?`${_}${n}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").style("vertical-align","middle").text(t)},menuModalLink:function(e,t,s,n,o){e.classed("btn",!0).classed(`btn-${n}`,!0).classed("btn-sm",!0).classed("mr-1",!0).attr("href","#").attr("role","button").attr("data-toggle","modal").attr("data-target",`#${t}`),e.append("img").attr("src",o?`${_}${o}.svg`:null).style("width","1.25rem").style("height","1.25rem"),e.append("span").classed("label",!0).style("vertical-align","middle").text(s)},dropdownMenuButton:function(e,t,s,n){e.classed("btn-group",!0).classed("mr-1",!0);const o=e.append("button").classed("btn",!0).classed(`btn-${s}`,!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown");o.append("img").attr("src",n?`${_}${n}.svg`:null).style("width","1.25rem").style("height","1.25rem"),o.append("span").style("vertical-align","middle").text(t),e.append("div").classed("dropdown-menu",!0)},dropdownMenuItem:function(e,t,s){e.classed("dropdown-item",!0).attr("href","#"),e.append("img").attr("src",s?`${_}${s}.svg`:null).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuModal:function(e,t,s,n){e.classed("dropdown-item",!0).attr("href","#").attr("data-toggle","modal").attr("data-target",`#${s}`),e.append("img").attr("src",`${_}${n}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(t)},dropdownMenuFile:function(e,s,n,o){e.classed("dropdown-item",!0).attr("href","#").on("click",function(){t.select(this).select("input").node().click()}),e.append("form").style("display","none").append("input").attr("type","file").attr("accept",n),e.append("img").attr("src",`${_}${o}.svg`).classed("mr-1",!0).style("width","2rem").style("height","2rem"),e.append("span").text(s)},dropdownMenuFileValue:function(e){return e.select("input").node().files[0]}};function A(e,t){e.classed("modal",!0).attr("tabindex",-1).attr("role","dialog").attr("aria-labelledby","").attr("aria-hidden",!0).attr("id",t),e.append("div").classed("modal-dialog",!0).attr("role","document").append("div").classed("modal-content",!0)}var z={confirmDialog:function(e,t){const s=e.call(A,t).select(".modal-content");s.append("div").classed("modal-body",!0).append("div").classed("message",!0);const n=s.append("div").classed("modal-footer",!0);n.append("button").classed("btn",!0).classed("btn-outline-secondary",!0).classed("cancel",!0).attr("type","button").attr("data-dismiss","modal").text("Cancel"),n.append("button").classed("btn",!0).classed("btn-warning",!0).classed("ok",!0).attr("type","button").attr("data-dismiss","modal").text("OK").on("click",()=>{e.dispatch("submit")})},updateConfirmDialog:function(e,t){e.select(".message").text(t)},submitDialog:function(e,t,s){const n=e.call(A,t).select(".modal-content"),o=n.append("div").classed("modal-header",!0);o.append("h4").classed("modal-title",!0).text(s),o.append("button").attr("type","button").attr("data-dismiss","modal").attr("aria-label","Close").classed("close",!0).append("span").attr("aria-hidden",!0).html("&times;"),n.append("div").classed("modal-body",!0),n.append("div").classed("modal-footer",!0).append("button").classed("btn",!0).classed("btn-primary",!0).classed("submit",!0).attr("type","button").attr("data-dismiss","modal").text("Submit").on("click",()=>{$(`#${t}`).modal("hide"),e.dispatch("submit")})}};var E={tree:function(){let e=400,s=e=>e.id,n=e=>e.parent,o=99999,a=()=>{},l=()=>{};function r(e,n){e.select(".childlist").size()||e.append("ul").classed("childlist",!0).style("list-style-type","none");const i=e.select(".childlist").selectAll("li").data(n,s);i.exit().remove(),i.enter().append("li").each(function(e){t.select(this).call(a,e.data)}).merge(i).each(function(e){const s=t.select(this);s.call(l,e.data),e.hasOwnProperty("children")?(s.call(r,e.children).select(".arrow").text(e=>e.depth-1>=o?"▶ ":"▼ ").on("click",function(){const e=s.select(".childlist"),n="none"!==e.style("display");t.select(this).text(n?"▶ ":"▼ "),e.style("display",n?"none":"inherit")}),s.select(".childlist").style("display",e=>e.depth-1>=o?"none":"inherit")):s.select(".childlist").remove()})}function i(o,a){const l=t.stratify().id(s).parentId(n)(a);o.style("overflow-y","scroll").style("height",`${e}px`),o.select(".body").size()||o.append("div").classed("body",!0),o.select(".body").call(r,l.children||[]),o.selectAll(".body > ul").style("padding-left",0),o.selectAll(".body > ul > li").classed("my-2",!0)}return i.bodyHeight=function(t){return e=t,i},i.keyDef=function(e){return s=e,i},i.defaultLevel=function(e){return o=e,i},i.nodeEnterFactory=function(e){return a=e,i},i.nodeMergeFactory=function(e){return l=e,i},i},checkboxNode:function(e){e.append("span").classed("arrow",!0),e.append("input").attr("type","checkbox"),e.append("span").classed("label",!0)},updateCheckbox:function(e,t){e.select(".label").text(t.id)},checkboxValues:function(e){return e.select(".body").selectAll("input:checked").data().map(e=>e.id)}};function N(e){return e.select(".form-control").property("value")}function H(e){return e.select(".form-control").node().checkValidity()}function U(e,t){e.select(".invalid-feedback").style("display",t?"none":"inherit"),e.select(".form-control").style("background-color",t?null:"#ffcccc")}function W(e){return/\s*?\w\s*?/.test(N(e))}function J(e,t,s){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("form-control-file",!0).classed("col-8",!0).attr("type","file").attr("accept",s).on("change",function(){const t=G(e);e.call(U,t)}),e.append("div").classed("col-4",!0),e.append("div").call(R.invalidFeedback).classed("col-8",!0)}function G(e){return e.select("input").property("files").length>0}var Q={updateFormValue:function(e,t){e.select(".form-control").property("value",t),e.call(U,!0)},formValue:N,formValid:H,setValidity:U,textBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","text").on("input",function(){const t=H(e);e.call(U,t)}),e.append("div").classed("col-4",!0),e.append("div").call(R.invalidFeedback).classed("col-8",!0)},readonlyBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control-plaintext",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","text").attr("readonly","readonly")},updateReadonlyValue:function(e,t){e.select(".form-control-plaintext").property("value",t)},readonlyValue:function(e){return e.select(".form-control-plaintext").property("value")},textareaBox:function(e,t,s,n){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t).append("div").call(R.invalidFeedback),e.append("textarea").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("rows",s).attr("placeholder",n).on("input",function(){const t=W(e);e.call(U,t)})},textareaBoxLines:function(e){const t=e.select("textarea").property("value");return t?t.split("\n").map(e=>e.replace(/^\s+|\s+$/g,"")).filter(e=>e.length>0):[]},textareaValid:W,numberBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("input").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).attr("type","number").on("input",function(){const t=H(e);e.call(U,t)}),e.append("div").classed("col-4",!0),e.append("div").call(R.invalidFeedback).classed("col-8",!0)},updateNumberRange:function(e,t,s,n){e.select(".form-control").attr("min",t).attr("max",s).attr("step",n).dispatch("input",{bubbles:!0})},checkBox:function(e,t){const s=e.classed("form-group",!0).classed("form-row",!0).classed("form-check",!0).append("label").classed("form-check-label",!0).classed("col-form-label-sm",!0);s.append("input").classed("form-check-input",!0).attr("type","checkbox"),s.append("span").text(t)},updateCheckBox:function(e,t){e.select("input").property("checked",t)},checkBoxValue:function(e){return e.select("input").property("checked")},colorBox:function(e,s){e.classed("form-row",!0).classed("align-items-center",!0).on("change",()=>{t.event.stopPropagation()}),e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).text(s),e.append("div").classed("form-group",!0).classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).classed("mb-1",!0).append("input").classed("form-control",!0).classed("form-control-sm",!0).attr("type","color")},fileInputBox:J,clearFileInput:function(e){const t=e.select("label").text(),s=e.select("input").attr("accept");e.selectAll("*").remove(),e.call(J,t,s)},fileInputValue:function(e){return e.select("input").property("files")[0]},fileInputValid:G};function K(e,t,s){const n=e.append("g");n.append("rect").attr("x",0).attr("y",0).attr("width",100).attr("height",10).attr("fill",t[0]),n.append("text").attr("text-anchor","middle").attr("x",50).attr("y",10).attr("font-size",12).text(s)}var Z={colorBar:{monocolor:K,bicolor:function(e,t,s){const n=r.uuidv4().slice(0,8);e.call(K,t,s);const o=e.append("defs").append("linearGradient").attr("id",n);o.append("stop").attr("offset",0).attr("stop-color",t[0]),o.append("stop").attr("offset",1).attr("stop-color",t[1]),e.select("rect").attr("fill",`url(#${n})`)},tricolor:function(e,t,s){const n=r.uuidv4().slice(0,8);e.call(K,t,s);const o=e.append("defs").append("linearGradient").attr("id",n);o.append("stop").attr("offset",0).attr("stop-color",t[0]),o.append("stop").attr("offset",.5).attr("stop-color",t[1]),o.append("stop").attr("offset",1).attr("stop-color",t[2]),e.select("rect").attr("fill",`url(#${n})`)},categorical:function(e,t,s){const n=100/t.length,o=e.append("g");t.forEach((e,s)=>{o.append("rect").attr("x",n*s).attr("y",0).attr("width",n).attr("height",10).attr("fill",t[s])}),o.append("text").attr("text-anchor","middle").attr("x",50).attr("y",10).attr("font-size",12).text(s)},custom:K},setSize:function(e,t,s){e.attr("width",t).attr("height",s)}};function X(e){return e.selectAll("input:checked").data().map(e=>e.key)}function Y(e){return X(e).length>0}function ee(e,t){e.select(".invalid-feedback").style("display",t?"none":"inherit"),e.select(".form-control").style("background-color",t?null:"LightPink")}function te(e,t){const s=e.select(".selected");s.selectAll("svg").remove(),s.datum(t),s.append("svg").attr("viewBox","0 0 100 10").attr("preserveAspectRatio","none").call(Z.colorBar[t.type],t.colors,t.text).call(Z.setSize,100,10)}var se={selectBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t),e.append("select").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0).on("input",function(){const t=Q.formValid(e);e.call(Q.setValidity,t)})},updateSelectBoxOptions:function(e,t){const s=e.select("select").selectAll("option").data(t,e=>e.key);s.exit().remove(),s.enter().append("option").attr("value",e=>e.key).text(e=>e.name)},selectedRecord:function(e){const t=Q.formValue(e);return e.selectAll("select option").data().find(e=>e.key===t)},checklistBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t).append("div").call(R.invalidFeedback),e.append("ul").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0)},updateChecklistItems:function(e,t){const s=e.select("ul").selectAll("li").data(t,e=>e.key);s.exit().remove();const n=s.enter().append("li").attr("class","form-check").append("label").attr("class","form-check-label");n.append("input").attr("type","checkbox").attr("class","form-check-input").property("value",e=>e.key),n.append("span").text(e=>e.name)},checkRequired:function(e){e.selectAll("input").on("change",function(){const t=Y(e);e.call(ee,t)})},updateChecklistValues:function(e,s){e.selectAll("input").each(function(e){t.select(this).property("checked",s.includes(e.key))}),e.call(ee,!0)},checklistValues:X,anyChecked:Y,setChecklistValidity:ee,colorScaleBox:function(e,t){e.classed("form-group",!0).classed("form-row",!0).classed("align-items-center",!0),e.append("label").classed("col-form-label",!0).classed("col-form-label-sm",!0).classed("col-4",!0).text(t||"Colorscale");const s=e.append("div").classed("form-control",!0).classed("form-control-sm",!0).classed("col-8",!0),n=s.append("div").classed("btn-group",!0).classed("mr-1",!0);n.append("button").classed("btn",!0).classed("btn-light",!0).classed("btn-sm",!0).classed("dropdown-toggle",!0).attr("data-toggle","dropdown"),n.append("div").classed("dropdown-menu",!0).classed("py-0",!0),s.append("span").classed("selected",!0)},colorScaleBoxItems:function(e,s){const n=e.select(".dropdown-menu").selectAll("a").data(s,e=>e);n.exit().remove(),n.enter().append("a").classed("dropdown-item",!0).classed("py-0",!0).attr("href","#").attr("title",e=>e.key).on("click",function(t){e.call(te,t),e.dispatch("change",{bubbles:!0})}).append("svg").each(function(e){t.select(this).attr("viewBox","0 0 100 10").attr("preserveAspectRatio","none").call(Z.colorBar[e.type],e.colors,e.text).call(Z.setSize,100,10)})},updateColorScaleBox:function(e,t){const s=e.select(".dropdown-menu").selectAll("a").data().find(e=>e.key===t);e.call(te,s)},colorScaleBoxValue:function(e){return e.select(".selected").datum().key},colorScaleBoxItem:function(e){return e.select(".selected").datum()}};const ne="search-dialog",oe="Search by compound ID";var ae={menuLink:function(e){e.call(M.dropdownMenuModal,oe,ne,"menu-searchtext")},body:function(e){const s=e.call(z.submitDialog,ne,oe).select(".modal-body");s.append("div").classed("text-muted",!0).classed("small",!0).classed("text-right",!0).text("Ctrl+F to fill the form with demo queries"),s.append("div").classed("field",!0).call(se.selectBox,"Field"),s.append("div").classed("query",!0).call(Q.textareaBox,"Query",12).call(R.updateInvalidMessage,"Please provide valid queries").on("input",function(){const s=Q.textareaValid(t.select(this));e.select(".submit").property("disabled",!s)})},updateBody:function(t,s){const n=e(s.map(e=>e.fields)).flatten().uniqBy("key").value().filter(e=>e.hasOwnProperty("d3_format")||["compound_id","numeric","text"].includes(e.format)),o=n.find(e=>"compound_id"===e.format)||n[0];t.select(".field").call(se.updateSelectBoxOptions,n).call(Q.updateFormValue,o.key),t.select(".query").call(Q.updateFormValue,""),t.select(".submit").property("disabled",!0)},execute:function(e,t){const s={workflow:"search",targets:t.map(e=>e.id),key:Q.formValue(e.select(".field")),values:Q.textareaBoxLines(e.select(".query"))};return D.get(s.workflow,s).then(D.json)},fill:function(e){e.select(".field").call(Q.updateFormValue,"compound_id"),e.select(".query").call(Q.updateFormValue,"DB00186\nDB00189\nDB00193\nDB00203\nDB00764\nDB00863\nDB00865\nDB00868\nDB01143\nDB01240\nDB01242\nDB01361\nDB01366\nDB02638\nDB02959").dispatch("input")}};var le={dropdownFormGroup:function(e,t){const s=r.uuidv4().slice(0,8);e.classed("mb-3",!0).append("div").classed("form-group",!0).classed("form-row",!0).classed("justify-content-end",!0).append("button").classed("btn",!0).classed("btn-sm",!0).classed("btn-outline-primary",!0).classed("dropdown-toggle",!0).attr("data-toggle","collapse").attr("data-target",`#${s}-collapse`).attr("aria-expanded","false").attr("aria-controls",`${s}-collapse`).text(t),e.append("div").classed("collapse",!0).attr("id",`${s}-collapse`).append("div").classed("card",!0).classed("card-body",!0)}};function re(e){const t=Q.formValue(e.select(".format")),s=Q.formValue(e.select(".source")),n=Q.formValue(e.select(".textquery")),o=Q.textareaBoxLines(e.select(".areaquery"));return{format:t,source:"dbid"===t?s:null,value:"molfile"===t?o:n}}var ie={queryMolGroup:function(e){e.classed("mb-3",!0),e.append("div").classed("format",!0).classed("mb-1",!0).call(se.selectBox,"Format").call(se.updateSelectBoxOptions,[{key:"molfile",name:"MDL Molfile"},{key:"dbid",name:"Compound ID"}]).on("change",function(){const s=Q.formValue(t.select(this));e.select(".source .form-control").property("disabled","dbid"!==s),e.select(".textquery").property("hidden","dbid"!==s),e.select(".areaquery").property("hidden","molfile"!==s)}),e.append("div").classed("source",!0).classed("mb-1",!0).call(se.selectBox,"Source");const s=e.append("div").classed("textquery",!0).classed("mb-1",!0).call(Q.textBox,"Query");s.select(".form-control").attr("required","required"),s.select(".invalid-feedback").call(R.updateInvalidMessage,"Please provide a valid query");const n=e.append("div").classed("areaquery",!0).classed("mb-1",!0).attr("required","required").call(Q.textareaBox,"Query",6,null);n.select(".form-control").attr("required","required"),n.select(".invalid-feedback").call(R.updateInvalidMessage,"Please provide a valid CTAB format text (.sdf or .mol)"),$(function(){$('[data-toggle="popover"]').popover({html:!0,trigger:"focus"})}),e.append("div").classed("form-row",!0).classed("justify-content-end",!0).append("button").classed("preview",!0).attr("data-toggle","popover").attr("data-html","true").attr("data-content",'<div id="previmg"></div>').call(M.menuButton,"Structure preview","primary").on("click",function(){const s=re(e);return D.get("strprev",s).then(D.text).then(e=>t.select("#previmg").html(e),D.error)})},updateQueryMolResources:function(e,t){const s=t.map(e=>({key:e.id,name:e.name}));e.select(".source").call(se.updateSelectBoxOptions,s)},updateQueryMolValues:function(e,t){e.select(".format").call(Q.updateFormValue,t.format).dispatch("change"),e.select(".source").call(Q.updateFormValue,t.source),e.select(".textquery").call(Q.updateFormValue,"dbid"===t.format?t.value:null),e.select(".areaquery").call(Q.updateFormValue,"molfile"===t.format?t.value:null)},queryMolValues:re,queryMolValid:function(e){const t=Q.formValue(e.select(".format")),s=Q.formValid(e.select(".textquery")),n=Q.textareaValid(e.select(".areaquery"));return"molfile"===t?n:s},simOptionGroup:function(e){const t=e.append("div").call(le.dropdownFormGroup,"Optional parameters").select(".card-body");t.append("div").classed("ignoreh",!0).classed("mb-1",!0).call(Q.checkBox,"Ignore explicit hydrogens");const s=t.append("div").classed("timeout",!0).classed("mb-1",!0).call(Q.numberBox,"Timeout").call(Q.updateNumberRange,1,999,1);s.select(".form-control").attr("required","required"),s.select(".invalid-feedback").call(R.updateInvalidMessage,"Please provide a valid number (1 to 999)");const n=t.append("div").classed("diam",!0).classed("mb-1",!0).call(Q.numberBox,"Diameter (MCS-DR/GLS)").call(Q.updateNumberRange,4,999,1);n.select(".form-control").attr("required","required"),n.select(".invalid-feedback").call(R.updateInvalidMessage,"Please provide a valid number (4 to 999)"),t.selectAll("label.col-form-label").classed("col-4",!1).classed("col-6",!0),t.selectAll("input.form-control").classed("col-8",!1).classed("col-6",!0)},updateSimOptionValues:function(e,t){e.select(".ignoreh").call(Q.updateCheckBox,t.ignoreHs),t.hasOwnProperty("timeout")&&e.select(".timeout").call(Q.updateFormValue,t.timeout),t.hasOwnProperty("diameter")&&e.select(".diam").call(Q.updateFormValue,t.diameter)},simOptionValues:function(e){const t=e.select(".timeout"),s=e.select(".diam"),n={ignoreHs:Q.checkBoxValue(e.select(".ignoreh"))};return t.select(".form-control").property("disabled")||(n.timeout=Q.formValue(t)),s.select(".form-control").property("disabled")||(n.diameter=Q.formValue(s)),n},simOptionValid:function(e){const t=Q.formValid(e.select(".timeout")),s=Q.formValid(e.select(".diam"));return t&&s}};const ce="struct-dialog",de="Search by structure";function ue(e){const t=ie.queryMolValid(e.select(".qmol")),s=Q.formValid(e.select(".thld")),n=ie.simOptionValid(e.select(".option")),o=se.anyChecked(e.select(".target"));return t&&s&&n&&o}var pe={menuLink:function(e){e.call(M.dropdownMenuModal,de,ce,"menu-searchchem")},body:function(e){const s=e.call(z.submitDialog,ce,de).select(".modal-body");s.append("div").classed("text-muted",!0).classed("small",!0).classed("text-right",!0).text("Ctrl+F to fill the form with demo queries"),s.append("div").classed("qmol",!0).call(ie.queryMolGroup).on("input",function(){const t=ue(e);e.select(".submit").property("disabled",!t)}),s.append("div").classed("method",!0).call(se.selectBox,"Method").on("change",function(){const s=Q.formValue(t.select(this)),n=["gls","rdfmcs"].includes(s),o=["exact","substr","supstr"].includes(s);e.select(".measure").call(Q.updateFormValue,"sim"),e.select(".measure select").property("disabled",!n),e.select(".thld input").property("disabled",o),e.select(".diam input").property("disabled","gls"!==s),e.select(".timeout input").property("disabled",!n)}),s.append("div").classed("measure",!0).call(se.selectBox,"Measure").call(se.updateSelectBoxOptions,[{key:"sim",name:"Similarity"},{key:"edge",name:"Edge count"}]).on("change",function(){const s="sim"===Q.formValue(t.select(this))?[.4,1,.01]:[1,999,1];e.select(".thld").call(Q.updateNumberRange,s[0],s[1],s[2])});const n=s.append("div").classed("thld",!0).call(Q.numberBox,"Threshold").on("input",function(){const t=ue(e);e.select(".submit").property("disabled",!t)});n.select(".form-control").attr("required","required"),n.select(".invalid-feedback").call(R.updateInvalidMessage,"Please provide a valid number (0.40 to 1.00)"),s.append("div").classed("option",!0).call(ie.simOptionGroup).on("input",function(){const t=ue(e);e.select(".submit").property("disabled",!t)}),s.append("div").classed("target",!0).call(se.checklistBox,"Target databases").on("input",function(){const t=ue(e);e.select(".submit").property("disabled",!t)})},updateBody:function(e,t,s){e.select(".qmol").call(ie.updateQueryMolResources,t).call(ie.updateQueryMolValues,{format:"molfile",source:t[0].key,value:""});const n=[{key:"exact",name:"Exact match"},{key:"substr",name:"Substructure"},{key:"supstr",name:"Superstructure"},{key:"gls",name:"MCS-DR/GLS"}];s&&(n.push({key:"rdmorgan",name:"RDKit Morgan similarity"}),n.push({key:"rdfmcs",name:"RDKit FMCS"})),e.select(".method").call(se.updateSelectBoxOptions,n).call(Q.updateFormValue,"exact").dispatch("change"),e.select(".measure").call(Q.updateFormValue,"sim"),e.select(".thld").call(Q.updateFormValue,.5),e.select(".option").call(ie.updateSimOptionValues,{ignoreHs:!0,timeout:2,diameter:8});const o=t.map(e=>({key:e.id,name:e.name}));e.select(".target").call(se.updateChecklistItems,o).call(se.updateChecklistValues,[]),e.select(".submit").property("disabled",!0)},execute:function(e){const t=ie.simOptionValues(e.select(".option")),s=e.select(".measure"),n=e.select(".thld");s.select("select").property("disabled")||(t.measure=Q.formValue(s)),n.select("input").property("disabled")||(t.threshold=Q.formValue(n));const o={workflow:Q.formValue(e.select(".method")),targets:se.checklistValues(e.select(".target")),queryMol:ie.queryMolValues(e.select(".qmol")),params:t};return D.get(o.workflow,o).then(D.json)},fill:function(e){e.select(".qmol").call(ie.updateQueryMolValues,{format:"dbid",source:"drugbankfda",value:"DB00465"}),e.select(".method").call(Q.updateFormValue,"gls").dispatch("change"),e.select(".measure").call(Q.updateFormValue,"sim").dispatch("change"),e.select(".thld").call(Q.updateFormValue,.7),e.select(".option").call(ie.updateSimOptionValues,{ignoreHs:!0,timeout:2,diameter:8}),e.select(".target").call(se.updateChecklistValues,"drugbankfda").dispatch("input")}};const me="filter-dialog",he="Search by properties";function fe(e){const t=se.selectedRecord(e.select(".key")).format,s=r.sortType(t),n=Q.formValid(e.select(".textvalue")),o=Q.formValid(e.select(".numvalue")),a=se.anyChecked(e.select(".target"));return("text"===s?n:o)&&a}var ge={menuLink:function(e){e.call(M.dropdownMenuModal,he,me,"menu-searchprop")},body:function(e){const s=e.call(z.submitDialog,me,he).select(".modal-body");s.append("div").classed("text-muted",!0).classed("small",!0).classed("text-right",!0).text("Ctrl+F to fill the form with demo queries"),s.append("div").classed("key",!0).call(se.selectBox,"Field").on("change",function(){const s=se.selectedRecord(t.select(this)),n=r.sortType(s.format||"d3_format");e.select(".textvalue").property("hidden","text"!==n),e.select(".numvalue").property("hidden","numeric"!==n)}),s.append("div").classed("operator",!0).call(se.selectBox,"Operator").call(se.updateSelectBoxOptions,[{key:"eq",name:"="},{key:"gt",name:">"},{key:"lt",name:"<"},{key:"ge",name:">="},{key:"le",name:">="},{key:"lk",name:"LIKE"}]);const n=s.append("div").classed("textvalue",!0).call(Q.textBox,"Value").on("input",function(){const t=fe(e);e.select(".submit").property("disabled",!t)});n.select(".form-control").attr("required","required"),n.select(".invalid-feedback").call(R.updateInvalidMessage,"Please provide a valid text");const o=s.append("div").classed("numvalue",!0).call(Q.numberBox,"Value").on("input",function(){const t=fe(e);e.select(".submit").property("disabled",!t)});o.select(".form-control").attr("required","required"),o.select(".invalid-feedback").call(R.updateInvalidMessage,"Please provide a valid number"),s.append("div").classed("target",!0).call(se.checklistBox,"Target databases").on("change",function(){const t=fe(e);e.select(".submit").property("disabled",!t)}).select(".invalid-feedback").call(R.updateInvalidMessage,"Please choose at least one items")},updateBody:function(t,s){const n=e(s.map(e=>e.fields)).flatten().uniqBy("key").value().filter(e=>e.hasOwnProperty("d3_format")||["compound_id","numeric","text"].includes(e.format));t.select(".key").call(se.updateSelectBoxOptions,n).call(Q.updateFormValue,n[0].key).dispatch("change"),t.select(".operator").call(Q.updateFormValue,"eq"),t.select(".textvalue").call(Q.updateFormValue,null),t.select(".numvalue").call(Q.updateFormValue,null);const o=s.map(e=>({key:e.id,name:e.name}));t.select(".target").call(se.updateChecklistItems,o).call(se.checkRequired).call(se.updateChecklistValues,[]),t.select(".submit").property("disabled",!0)},execute:function(e){const t=se.selectedRecord(e.select(".key")).format,s=r.sortType(t),n=Q.formValue(e.select("text"===s?".textvalue":".numvalue")),o={workflow:"filter",targets:se.checklistValues(e.select(".target")),key:Q.formValue(e.select(".key")),value:n,operator:Q.formValue(e.select(".operator"))};return D.get(o.workflow,o).then(D.json)},fill:function(e){e.select(".key").call(Q.updateFormValue,"_mw").dispatch("change"),e.select(".operator").call(Q.updateFormValue,"gt"),e.select(".numvalue").call(Q.updateFormValue,1500),e.select(".target").call(se.updateChecklistValues,["drugbankfda"]).dispatch("change")}};const ye="screener-dialog",be="Fetch Screener QCSession";function we(e,s){e.append("span").classed("arrow",!0),e.append("img").classed("icon",!0).classed("mr-1",!0).style("width","1.3rem").style("height","1.3rem"),e.append("span").classed("label",!0),s.content&&(e.append("input").classed("qcsvalue",!0).attr("type","radio").attr("name","qcsvalue").style("display","none"),e.select(".label").on("click",function(){e.select(".qcsvalue").property("checked",!0),t.select(`#${ye} .qcsession`).selectAll("li").style("background-color",null),e.style("background-color","#ffff00"),t.select(`#${ye} .submit`).property("disabled",!1)}))}function ve(e,t){const s=t.content?"table-darkorange":"file-seagreen";e.select(".icon").attr("src",`${M.iconBaseURL}${s}.svg`),e.select(".label").text(t.content?t.content.name:t.id)}var xe={menuLink:function(e){e.call(M.dropdownMenuModal,be,ye,"menu-addassay")},body:function(e){const t=e.call(z.submitDialog,ye,be);t.select(".modal-dialog").classed("modal-lg",!0),t.select(".modal-body").append("div").classed("qcsession",!0)},updateBody:function(t,s){const n=t.select(".modal-body");t.select(".submit").property("disabled",!0),$(`#${ye}`).on("shown.bs.modal",()=>($(`#${ye}`).off("shown.bs.modal"),fetch(`${s}qcSessions?limit=0`,{credentials:"include"}).then(e=>e.json()).then(e=>e.meta.totalHitCount).then(e=>{const t=[],s=Math.ceil(e/250);for(let e=0;e<s;e++){const s=`../screener/qcsession?query=${JSON.stringify({limit:250,offset:250*e,fields:["qcsRefId","name","experiment"]})}`,n={credentials:"include"};t.push(()=>fetch(s,n).then(e=>e.json()))}return t}).then(e=>D.batchRequest(e,.1)).then(t=>e.flatten(t.map(e=>e.records))).then(e=>{const t=[{id:"root"}];e.forEach(e=>{const s=e.experiment.folderName.split("/");s.shift(),s.forEach((e,n)=>{t.find(t=>e===t.id)||t.push({id:e,parent:0===n?"root":s[n-1]})}),t.push({id:e.qcsRefId,parent:s[s.length-1],content:e})}),n.select(".qcsession").call(E.tree().bodyHeight(300).defaultLevel(1).nodeEnterFactory(we).nodeMergeFactory(ve),t)})))},execute:function(e){const t=e.select(".modal-body"),s=E.checkboxValues(t.select(".qcsession"))[0],n={credentials:"include"},o=JSON.stringify({qcsRefIds:s});return fetch(`../screener/platestats?query=${o}`,n).then(e=>e.json()).then(e=>x.newDatagrid(e)).then(e=>{const t=e.instance,s=fetch(`../screener/platevalue?query=${o}`,n).then(e=>e.json()).then(e=>x.add384Tiles(t,e)),a=fetch(`../screener/compound?query=${o}`,n).then(e=>e.json()).then(e=>e.records.length?x.addDatagrid(t,e):void 0);return Promise.all([s,a])})}};const ke="sdf-dialog",Ve="Import SDFile";var Ce={menuLink:function(e){e.call(M.dropdownMenuModal,Ve,ke,"menu-importsdf")},body:function(e){const s=e.call(z.submitDialog,ke,Ve);s.select(".modal-body").append("div").classed("file",!0).call(Q.fileInputBox,"File",".mol,.sdf").on("change",function(){const s=Q.fileInputValid(t.select(this));if(e.select(".submit").property("disabled",!s),!s)return;const n=Q.fileInputValue(t.select(this));return O.readFile(n,104857600,!1).then(t=>{const s=function(e){const t=/>.*?<(\S+)>/g,s=new Set;let n;for(;null!==(n=t.exec(e));)s.add(n[1]);return Array.from(s)}(t).map(e=>({key:e,name:e}));e.select(".field").call(se.updateChecklistItems,s).call(se.updateChecklistValues,[]).call(se.checkRequired),e.select(".submit").property("disabled",!0)})}),s.select(".modal-body").append("div").classed("field",!0).call(se.checklistBox,"Fields").on("input",function(){const t=se.anyChecked(e.select(".field"));e.select(".submit").property("disabled",!t)}).select(".invalid-feedback").call(R.updateInvalidMessage,"Please select at least one item"),s.select(".modal-body").append("div").classed("implh",!0).call(Q.checkBox,"Make hydrogens implicit"),s.select(".modal-body").append("div").classed("recalc",!0).call(Q.checkBox,"Recalculate 2D coords")},updateBody:function(e){e.select(".file").call(Q.clearFileInput).select(".invalid-feedback").call(R.updateInvalidMessage,"Please choose a file"),e.select(".field").call(se.updateChecklistItems,[]).call(se.updateChecklistValues,[]),e.select(".implh").call(Q.updateCheckBox,!0),e.select(".recalc").call(Q.updateCheckBox,!1),e.select(".submit").property("disabled",!0)},execute:function(e){const t={fields:se.checklistValues(e.select(".field")),implh:Q.checkBoxValue(e.select(".implh")),recalc:Q.checkBoxValue(e.select(".recalc"))},s=new FormData;return s.append("contents",Q.fileInputValue(e.select(".file"))),s.append("params",JSON.stringify(t)),D.post("sdfin",s).then(D.json)}};const De="rename-dialog",Ie="Rename";var $e={menuLink:function(e){e.call(M.dropdownMenuModal,Ie,De,"menu-edittext")},body:function(e){const t=e.call(z.submitDialog,De,Ie).select(".modal-body").append("div").classed("rename",!0).call(Q.textBox,"New name");t.select(".form-control").attr("required","required"),t.select(".invalid-feedback").call(R.updateInvalidMessage,"Please provide a valid name")},updateBody:function(e,s){e.select(".rename").call(Q.updateFormValue,s).on("input",function(){const s=Q.formValid(t.select(this));e.select(".submit").property("disabled",!s)}).dispatch("input")},value:function(e){return Q.formValue(e.select(".rename"))}};function Se(e,t){const s=e.select(".dg-header");s.selectAll(".dg-hcell").remove(),s.selectAll(".dg-hcell").data(t.visibleFields).enter().append("div").classed("dg-hcell",!0).call(t.headerCellRenderer)}function Be(e,s){const n=e.select(".dg-body").selectAll(".dg-row").data(s.recordsToShow(),s.keyFunc);n.exit().remove(),n.selectAll(".dg-cell").remove(),n.enter().append("div").attr("class","dg-row").style("position","absolute").style("width","100%").merge(n).style("height",`${s.rowHeight}px`).each(function(e,n){const o=s.viewportTop+n,a=o*s.rowHeight;t.select(this).style("transform",`translate(0px, ${a}px)`).classed("odd",o%2==0).call(s.rowFactory(),e)})}function Fe(e,t,s){e.select(".dg-body").style("height",`${t.bodyHeight}px`),t.setScrollPosition(s),e.call(Be,t,s),e.select(".dg-viewport").node().scrollTop=s*t.rowHeight}function Te(e,t){const s=e.select(".dg-viewport"),n=s.node().getBoundingClientRect().top;t.resizeViewport(window.innerHeight-n-5),s.style("height",`${t.viewportHeight}px`)}var qe={headerCellRenderer:function(e){e.style("display","inline-block").style("width",e=>`${e.width}%`).text(e=>e.name)},updateHeader:Se,updateRows:Be,updateViewport:Fe,resize:Te,datagrid:function(e,t){e.append("div").classed("dg-header",!0),e.append("div").classed("dg-viewport",!0).style("overflow-y","auto").on("scroll",function(){const s=Math.floor(this.scrollTop/t.rowHeight);s!==t.previousViewportTop&&(t.setScrollPosition(s),e.call(Be,t,s))}).append("div").classed("dg-body",!0).style("position","relative"),t.updateContentsNotifier=(()=>{t.applyHeader(),e.call(Se,t),e.call(Te,t),t.applyData(),e.call(Fe,t,t.viewportTop)}),t.updateFilterNotifier=(s=>{t.setFilterText(s),e.call(Fe,t,0)})}};function Oe(e,t,s){e.text(r.formatNum(t[s.key],s.d3_format))}function Le(e,t,s){e.text(t[s.key])}function Pe(e,t,s){e.html(t[s.key])}function je(e,t,s){e.append("a").attr("href",`profile.html?compound=${t[s.key]}`).attr("target","_blank").text(t[s.key])}function Re(e,t,s){e.append("img").attr("width",180).attr("height",180).attr("src",t[s.key])}function _e(e,t,s){e.append("input").attr("type","checkbox").property("checked",t[s.key]).property("disabled",!!s.disabled&&t[s.disabled]).on("click",function(){t[s.key]=this.checked})}function Me(e,t,s){e.append("input").attr("type","text").style("width","90%").property("value",t[s.key]).on("change",function(){t[s.key]=this.value})}function Ae(e,t){e.call(t)}function ze(e,t,s){const n=`${s.request}${t[s.key]}`;x.getAsset(n).then(e=>void 0!==e?e:fetch(n,{credentials:"include"}).then(e=>e.blob()).then(e=>x.putAsset(n,e).then(()=>e))).then(t=>{e.append("img").attr("width",180).attr("height",180).attr("src",URL.createObjectURL(t))})}function Ee(e,t,s){const n=`${s.request}${t[s.key]}`;x.getAsset(n).then(e=>void 0!==e?e:fetch(n,{credentials:"include"}).then(e=>e.text()).then(e=>x.putAsset(n,e).then(()=>e))).then(t=>{e.html(t)})}const Ne={numeric:Le,text:Le,date:function(e,t,s){e.text(t[s.key])},raw:Le,d3_format:Oe,compound_id:je,assay_id:Le,list:Le,plot:{plotCell:function(e,t,s){new n.View(n.parse(t[s.key])).initialize(e.node()).run()},plotThumbnail:function(e){return new n.View(n.parse(e)).toImageURL("png")},binaryToDataURI:function(e){return new Promise(t=>{const s=new FileReader;s.onload=(e=>{t(e.target.result)}),s.readAsDataURL(e)})}}.plotCell,image:Re,checkbox:_e,text_field:Me,control:Ae,svg:Pe,html:Pe,async_image:ze,async_html:Ee};function He(e){e.classed("dg-cell",!0).classed("align-middle",!0).classed("text-truncate",!0).style("display","inline-block")}var Ue={d3Format:Oe,text:Le,html:Pe,compoundID:je,image:Re,checkbox:_e,textField:Me,call:Ae,asyncImage:ze,asyncHtml:Ee,rowCell:He,rowFactory:function(e){return(t,s)=>{e.forEach(e=>{const n=t.append("div").call(He).style("width",`${e.width}%`);s.hasOwnProperty(e.key)&&n.call(Ne[e.format],s,e)})}}};class We{constructor(e,t){this.instance=e.instance||null,this.viewID=e.viewID||null,this.name=e.name||null,this.sortOrder=e.sortOrder||[],this.filterText=e.filterText||null,this.rows=new B(t),this.visibleFields=null,this.sortedRecords=null,this.filteredRecords=null,this.defaultColumnHeight={numeric:40,text:40,html:40,none:200},this.scrollBarSpace=20,this.keyFunc=(e=>e.index),this.rowHeight=null,this.bodyHeight=null,this.viewportHeight=null,this.numViewportRows=null,this.viewportTop=0,this.previousViewportTop=null,this.viewportBottom=null,this.fixedViewportHeight=null,this.updateContentsNotifier=null,this.updateFilterNotifier=null,this.headerCellRenderer=qe.headerCellRenderer,this.rowFactory=(()=>Ue.rowFactory(this.visibleFields))}setViewportSize(e){this.viewportHeight=this.fixedViewportHeight||e}setScrollPosition(e){this.previousViewportTop=this.viewportTop,this.viewportTop=e,this.viewportBottom=Math.min(this.viewportTop+this.numViewportRows,this.filteredRecords.length)}setNumViewportRows(){this.numViewportRows=Math.ceil(this.viewportHeight/this.rowHeight)+1}resizeViewport(e){this.setViewportSize(e),this.setNumViewportRows()}applyHeader(){this.visibleFields=this.rows.fields.filter(e=>e.visible);const e=this.visibleFields.reduce((e,t)=>e+(t.widthf||1),0);this.visibleFields=this.visibleFields.map(t=>{const s={width:(t.widthf||1)/e*100,height:t.height||this.defaultColumnHeight[r.sortType(t.format)]};return Object.assign(s,t)}),this.rowHeight=this.visibleFields.reduce((e,t)=>e.height>t.height?e:t,0).height}applyData(){this.setNumViewportRows(),this.applyOrder()}applyOrder(t,s){if(t)this.sortedRecords=e.orderBy(this.rows.records().slice(),[t],[s]);else{const t=this.sortOrder.map(e=>e.key),s=this.sortOrder.map(e=>e.order);t&&(this.sortedRecords=e.orderBy(this.rows.records().slice(),t,s))}this.applyFilter()}applyFilter(){if(null===this.filterText)this.filteredRecords=this.sortedRecords.slice();else{const e=this.visibleFields.filter(e=>"none"!==r.sortType(e.format)).map(e=>e.key);this.filteredRecords=this.sortedRecords.filter(t=>e.some(e=>r.partialMatch(this.filterText,t[e])))}this.bodyHeight=this.filteredRecords.length*this.rowHeight}setSortOrder(e,t){const s=this.sortOrder.findIndex(e=>e.key),n={key:e,order:t};-1!==s&&this.sortOrder.splice(s,1),this.sortOrder.splice(0,0,n),this.applyOrder(e,t)}setFilterText(e){this.filterText=e,this.applyFilter()}updateFields(e){this.rows.updateFields(e)}joinFields(e){this.rows.joinFields(e),this.applyData()}recordsToShow(){return this.filteredRecords.slice(this.viewportTop,this.viewportBottom)}save(){return x.updateItem(this.instance,e=>{const t=e.dataset.findIndex(e=>e.collectionID===this.rows.collectionID);e.dataset[t]=this.rows.export();const s=e.views.findIndex(e=>e.viewID===this.viewID);e.views[s]=this.export()})}export(){return{$schema:"https://mojaie.github.io/kiwiii/specs/datagrid_v1.0.json",viewID:this.viewID,name:this.name,viewType:"datagrid",rows:this.rows.collectionID,sortOrder:this.sortOrder,filterText:this.filterText}}}var Je={setFilter:function(e,t){const s=e.classed("row",!0).classed("justify-content-end",!0).append("div").classed("col-5",!0).call(Q.textBox,"Search");s.select("label").classed("text-right",!0),s.select("input").on("keyup",function(){t.updateFilterNotifier(Q.formValue(s))})}};var Ge={setSort:function(e,s){s.headerCellRenderer=(n=>{n.style("display","inline-block").style("width",e=>`${e.width}%`).text(e=>e.name).filter(e=>"none"!==r.sortType(e.format)).append("span").append("a").attr("id",e=>`sort-${e.key}`).text("^v").style("display","inline-block").style("width","30px").style("text-align","center").on("click",n=>{const o="v"===t.select(`#sort-${n.key}`).text();t.select(`#sort-${n.key}`).text(o?"^":"v"),s.setSortOrder(n.key,o?"desc":"asc"),e.call(qe.updateRows,s)})})}};var Qe={table:function(e,t,s,n,o){const a=new We({},{fields:t,records:s});a.keyFunc=(e=>e),n&&(a.rowFactory=(()=>n(a.visibleFields))),a.fixedViewportHeight=o||300,e.append("div").classed("table",!0).call(qe.datagrid,a),e.datum(a)},filterTable:function(e,t,s,n,o){const a=new We({},{fields:t,records:s});n&&(a.rowFactory=(()=>n(a.visibleFields))),a.fixedViewportHeight=o||300,e.append("div").classed("search",!0).call(Je.setFilter,a),e.append("div").classed("table",!0).call(qe.datagrid,a),e.datum(a)},filterSortTable:function(e,t,s,n,o){const a=new We({},{fields:t,records:s});n&&(a.rowFactory=(()=>n(a.visibleFields))),a.fixedViewportHeight=o||300,e.append("div").classed("search",!0).call(Je.setFilter,a),e.append("div").classed("table",!0).call(Ge.setSort,a).call(qe.datagrid,a),e.datum(a)},update:function(e,t,s){const n={fields:t,records:s},o=e.datum();o.rows=new B(n),o.updateContentsNotifier()},updateRecords:function(e,t){const s=e.datum();s.rows.contents[0].records=t,s.updateContentsNotifier()},tableRecords:function(e){return e.datum().rows.records()}};function Ke(e,t){const s=t.instance||t.parent;e.append("span").classed("arrow",!0);const n=t.viewID?e.append("a").attr("href",`${t.viewType}.html?instance=${s}&view=${t.viewID}`).attr("target","_blank"):e;n.append("img").classed("icon",!0).classed("mr-1",!0).style("width","2rem").style("height","2rem"),n.append("span").classed("title",!0).classed("mr-1",!0),e.append("span").classed("status",!0).classed("mr-1",!0),e.append("span").classed("action",!0).classed("p-1",!0).style("border","1px solid #999999").style("border-radius","5px")}function Ze(e,s){const n=s.viewID?{datagrid:"table-darkorange",network:"network-turquoise",tile:"tiles-yellowgreen"}[s.viewType]:"file-seagreen";e.select(".icon").attr("src",n?`${M.iconBaseURL}${n}.svg`:null),e.select(".title").text(s.name);const o={done:"green",running:"darkorange",ready:"cornflowerblue",queued:"cornflowerblue",interrupted:"salmon",aborted:"salmon",failure:"salmon",rows:"gray",items:"gray",nodes:"gray",edges:"gray"},a={done:"check-green",running:"running-darkorange",ready:"clock-cornflowerblue",queued:"clock-cornflowerblue",interrupted:"caution-salmon",aborted:"caution-salmon",failure:"caution-salmon",rows:"table-gray",items:"tiles-gray",nodes:"nodes-gray",edges:"edges-gray"},l=e.select(".status");l.selectAll("*").remove(),s.viewID?s.stats.forEach(e=>{l.append("img").attr("src",`${M.iconBaseURL}${a[e[0]]}.svg`).style("width","1rem").style("height","1rem"),l.append("span").style("font-size","0.8rem").style("color",o[e[0]]).text(e[1])}):l.append("span").style("font-size","0.7rem").style("color","#999999").text(s.sessionStarted);const r=e.select(".action");r.selectAll("*").remove();const i=(e,t)=>e.append("img").attr("src",`${M.iconBaseURL}${t}.svg`).classed("mx-1",!0).style("width","1.25rem").style("height","1.25rem");if(s.viewID||r.append("a").call(i,"menu-export").on("click",()=>{const e=JSON.parse(JSON.stringify(s));delete e.instance,delete e.sessionStarted,O.downloadJSON(e,e.name)}),r.append("a").attr("data-toggle","modal").attr("data-target","#rename-dialog").call(i,"menu-edittext").on("click",()=>{t.select("#rename-dialog").call($e.updateBody,s.name).on("submit",function(){t.select("#menubar .loading-circle").style("display","inline-block"),s.viewID?x.updateView(s.parent,s.viewID,e=>{e.name=$e.value(t.select(this))}).then(Xe):x.updateItem(s.instance,e=>{e.name=$e.value(t.select(this))}).then(Xe)})}),!s.ongoing){const e=s.viewID?s.viewType:"package",n=s.alone?"package":e,o=s.alone?s.parentName:s.name;r.append("a").attr("data-toggle","modal").attr("data-target","#delete-dialog").call(i,"delete-gray").on("click",()=>{t.select("#delete-dialog").call(z.updateConfirmDialog,`Are you sure you want to delete ${n} ${o} ?`).on("submit",()=>{t.select("#menubar .loading-circle").style("display","inline-block"),s.viewID&&!s.alone?x.deleteView(s.parent,s.viewID).then(Xe):x.deleteItem(s.id||s.parent).then(Xe)})})}r.selectAll("img").on("mouseenter",function(){t.select(this).style("background-color","#ffcccc")}).on("mouseleave",function(){t.select(this).style("background-color",null)})}function Xe(){const e=t.select("#menubar .loading-circle"),s=t.select("#dialogs");return D.serverStatus().then(n=>{t.select("#contents").select(".calc").call(Qe.updateRecords,n.server.calc.records);const o=Object.entries(n.server).filter(e=>"calc"!==e[0]).map(e=>{const t="externalModules"===e[0]?JSON.stringify(e[1].map(e=>e.name)):e[1];return{key:e[0],value:t}});t.select("#contents").select(".server").call(Qe.updateRecords,o);const a=n.schema.resources.filter(e=>"chemical"===e.domain);s.select(".searchd").call(ae.updateBody,a).on("submit",function(){return ae.execute(t.select(this),a).then(x.newDatagrid).then(t=>{e.style("display","none"),window.open(`datagrid.html?instance=${t.instance}&view=${t.viewID}`,"_blank")})}),s.select(".structd").call(pe.updateBody,a,n.server.rdkit).on("submit",function(){return pe.execute(t.select(this)).then(x.newDatagrid).then(t=>{e.style("display","none"),window.open(`datagrid.html?instance=${t.instance}&view=${t.viewID}`,"_blank")})}),s.select(".filterd").call(ge.updateBody,a).on("submit",function(){return ge.execute(t.select(this)).then(x.newDatagrid).then(t=>{e.style("display","none"),window.open(`datagrid.html?instance=${t.instance}&view=${t.viewID}`,"_blank")})});const r=n.server.externalModules.find(e=>"contrib.screenerapi"===e.module);return r&&s.select(".screenerd").call(xe.updateBody,r.base_url).on("submit",function(){xe.execute(t.select(this)).then(()=>(e.style("display","none"),Xe()))}),s.select(".sdfd").call(Ce.updateBody,a).on("submit",function(){return Ce.execute(t.select(this)).then(x.newDatagrid).then(t=>{e.style("display","none"),window.open(`datagrid.html?instance=${t.instance}&view=${t.viewID}`,"_blank")})}),l.registerCtrlCommand("f",()=>{const e=s.select(".show").attr("id"),t={"search-dialog":ae,"struct-dialog":pe,"filter-dialog":ge};s.select(`#${e}`).call(t[e].fill)}),x.getAllCollections().then(e=>{const t=e.map(e=>new B(e)).filter(e=>e.ongoing());return Promise.all(t.map(e=>e.pull()))})}).catch(e=>{console.info("Server did not respond"),console.error(e),t.select("#menubar").selectAll(".online-command").attr("data-target",null).classed("disabled",!0),t.select("#contents").select(".calc").text("Off-line"),t.select("#contents").select(".server").text("Off-line")}).finally(()=>x.getAllItems().then(s=>{const n=[{id:"root"}],o=[];s.forEach(e=>{e.parent="root",e.ongoing=L.isRunning(e),o.push(e.ongoing),n.push(e),e.views.forEach(s=>{s.parent=e.id,s.ongoing=e.ongoing,s.alone=e.views.length<=1,s.parentName=e.name,s.stats=["nodes","edges","rows","items"].filter(e=>s.hasOwnProperty(e)).map(n=>[n,t.format(".3~s")(e.dataset.find(e=>e.collectionID===s[n]).contents.reduce((e,t)=>e+t.records.length,0))]);const o=new B(e.dataset.find(e=>e.collectionID===s[["edges","rows","items"].filter(e=>s.hasOwnProperty(e))[0]])),a="done"===o.status()?"":o.status(),l=o.ongoing()?`${o.progress()}%`:"";s.stats.push([o.status(),`${a}${l}`]),n.push(s)})}),t.select(".reset").classed("disabled",o.some(e=>e)),t.select(".stored").call(E.tree().bodyHeight(300).nodeEnterFactory(Ke).nodeMergeFactory(Ze),n),e.style("display","none")}))}return{run:function(){const e=l.compatibility();if(e)return void t.select("body").style("color","#ff0000").text(e);document.location.protocol,"onLine"in navigator&&navigator.onLine,console.info(`Kiwiii version ${a}`),l.registerServiceWorker(),function(){const e=t.select("#menubar").classed("my-1",!0),s=e.append("div").call(M.dropdownMenuButton,"Start","primary","plus-white").select(".dropdown-menu");s.append("a").classed("online-command",!0).call(ae.menuLink),s.append("a").classed("online-command",!0).call(pe.menuLink),s.append("a").classed("online-command",!0).call(ge.menuLink),s.append("a").classed("online-command",!0).call(xe.menuLink),s.append("a").classed("online-command",!0).call(Ce.menuLink),s.append("a").call(M.dropdownMenuFile,"Open file",".apc,.apr,.ndc,.ndr,.gfc,.gfr,.json,.gz","menu-import").on("change",function(){t.select("#menubar .loading-circle").style("display","inline-block");const e=M.dropdownMenuFileValue(t.select(this));return O.loadJSON(e).then(x.importItem).then(Xe)}),e.append("a").classed("refresh",!0).classed("online-command",!0).call(M.menuButtonLink,"Refresh all","outline-secondary","refresh-gray").on("click",()=>(t.select("#menubar .loading-circle").style("display","inline-block"),Xe())),e.append("a").classed("reset",!0).call(M.menuModalLink,"reset-dialog","Reset local datastore","warning","delete-gray"),e.append("span").classed("loading-circle",!0).call(R.loadingCircle);const n=t.select("#contents").style("padding-left","10%").style("padding-right","10%");n.append("h5").classed("mt-5",!0).text("Packages on local storage"),n.append("div").classed("mb-5",!0).classed("stored",!0).style("border","1px solid #333333"),n.append("h5").classed("mt-5",!0).text("Server calculation job"),n.append("div").classed("mb-5",!0).classed("calc",!0).call(Qe.table,[{key:"workflowID",name:"WorkflowID",format:"text"},{key:"name",name:"Name",format:"text"},{key:"size",name:"File size",format:"d3_format",d3_format:".3s"},{key:"status",name:"Status",format:"text"},{key:"created",name:"Created",format:"date",height:40}],[],null,300),n.append("h5").classed("mt-5",!0).text("Server status"),n.append("div").classed("mb-5",!0).classed("server",!0).call(Qe.table,[{key:"key",name:"Key",format:"text"},{key:"value",name:"Value",format:"text"}],[],null,300);const o=t.select("#dialogs");o.append("div").classed("searchd",!0).call(ae.body),o.append("div").classed("structd",!0).call(pe.body),o.append("div").classed("filterd",!0).call(ge.body),o.append("div").classed("screenerd",!0).call(xe.body),o.append("div").classed("sdfd",!0).call(Ce.body),o.append("div").classed("renamed",!0).call($e.body),o.append("div").call(z.confirmDialog,"reset-dialog").call(z.updateConfirmDialog,"Are you sure you want to delete all local tables and reset the datastore ?").on("submit",()=>(t.select("#menubar .loading-circle").style("display","inline-block"),x.clearAll().then(Xe))),o.append("div").call(z.confirmDialog,"delete-dialog"),Xe()}()}}});
//# sourceMappingURL=dashboardApp.js.map
